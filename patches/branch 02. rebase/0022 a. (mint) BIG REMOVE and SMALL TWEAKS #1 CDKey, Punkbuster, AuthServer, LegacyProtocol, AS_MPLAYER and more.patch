Index: code/botlib/be_ai_goal.c
===================================================================
--- code/botlib/be_ai_goal.c	(revision 3378)
+++ code/botlib/be_ai_goal.c	(working copy)
@@ -566,7 +566,7 @@
 	{
 		if (!ic->iteminfo[i].modelindex)
 		{
-			Log_Write("item %s has modelindex 0", ic->iteminfo[i].classname);
+			Log_Write("item %s has modelindex 0.\n", ic->iteminfo[i].classname);
 		} //end if
 	} //end for
 
Index: code/botlib/botlib.h
===================================================================
--- code/botlib/botlib.h	(revision 3378)
+++ code/botlib/botlib.h	(working copy)
@@ -45,12 +45,14 @@
 
 #define BOTFILESBASEFOLDER		"botfiles"
 //debug line colors
-#define LINECOLOR_NONE			-1
-#define LINECOLOR_RED			1//0xf2f2f0f0L
-#define LINECOLOR_GREEN			2//0xd0d1d2d3L
-#define LINECOLOR_BLUE			3//0xf3f3f1f1L
-#define LINECOLOR_YELLOW		4//0xdcdddedfL
-#define LINECOLOR_ORANGE		5//0xe0e1e2e3L
+#define LINECOLOR_NONE			0
+#define LINECOLOR_RED			1
+#define LINECOLOR_GREEN			2
+#define LINECOLOR_YELLOW		3
+#define LINECOLOR_BLUE			4
+#define LINECOLOR_MAGENTA		5
+#define LINECOLOR_CYAN			6
+#define LINECOLOR_WHITE			7
 
 //Print types
 #define PRT_MESSAGE				1
Index: code/botlib/l_crc.c
===================================================================
--- code/botlib/l_crc.c	(revision 3378)
+++ code/botlib/l_crc.c	(working copy)
@@ -29,10 +29,6 @@
  *
  *****************************************************************************/
 
-#include <stdlib.h>
-#include <stdio.h>
-#include <string.h>
-
 #include "../qcommon/q_shared.h"
 #include "botlib.h"
 #include "be_interface.h"			//for botimport.Print
Index: code/botlib/l_precomp.c
===================================================================
--- code/botlib/l_precomp.c	(revision 3378)
+++ code/botlib/l_precomp.c	(working copy)
@@ -81,11 +81,6 @@
 #include "../bspc/l_log.h"
 #include "../bspc/l_mem.h"
 #include "l_precomp.h"
-
-#define qtrue	true
-#define qfalse	false
-#define Q_stricmp	stricmp
-
 #endif //BSPC
 
 #if defined(QUAKE) && !defined(BSPC)
@@ -92,8 +87,6 @@
 #include "l_utils.h"
 #endif //QUAKE
 
-//#define DEBUG_EVAL
-
 #define MAX_DEFINEPARMS			128
 
 #define DEFINEHASHING			1
Index: code/botlib/l_precomp.h
===================================================================
--- code/botlib/l_precomp.h	(revision 3378)
+++ code/botlib/l_precomp.h	(working copy)
@@ -152,22 +152,6 @@
 //print a source warning
 void QDECL SourceWarning(source_t *source, char *str, ...)  __attribute__ ((format (printf, 2, 3)));
 
-#ifdef BSPC
-// some of BSPC source does include game/q_shared.h and some does not
-// we define pc_token_s pc_token_t if needed (yes, it's ugly)
-#ifndef __Q_SHARED_H
-#define MAX_TOKENLENGTH		1024
-typedef struct pc_token_s
-{
-	int type;
-	int subtype;
-	int intvalue;
-	float floatvalue;
-	char string[MAX_TOKENLENGTH];
-} pc_token_t;
-#endif //!_Q_SHARED_H
-#endif //BSPC
-
 //
 int PC_LoadSourceHandle(const char *filename);
 int PC_FreeSourceHandle(int handle);
Index: code/botlib/l_script.c
===================================================================
--- code/botlib/l_script.c	(revision 3378)
+++ code/botlib/l_script.c	(working copy)
@@ -74,9 +74,6 @@
 #include "../bspc/qbsp.h"
 #include "../bspc/l_log.h"
 #include "../bspc/l_mem.h"
-
-#define qtrue	true
-#define qfalse	false
 #endif //BSPC
 
 
Index: code/botlib/l_script.h
===================================================================
--- code/botlib/l_script.h	(revision 3378)
+++ code/botlib/l_script.h	(working copy)
@@ -39,11 +39,7 @@
 //maximum token length
 #define MAX_TOKEN					1024
 
-#if defined(BSPC) && !defined(QDECL)
-#define QDECL
-#endif
 
-
 //script flags
 #define SCFL_NOERRORS				0x0001
 #define SCFL_NOWARNINGS				0x0002
Index: code/botlib/l_struct.c
===================================================================
--- code/botlib/l_struct.c	(revision 3378)
+++ code/botlib/l_struct.c	(working copy)
@@ -46,9 +46,6 @@
 #include "../bspc/l_mem.h"
 #include "l_precomp.h"
 #include "l_struct.h"
-
-#define qtrue	true
-#define qfalse	false
 #endif //BSPC
 
 //===========================================================================
Index: code/cgame/cg_consolecmds.c
===================================================================
--- code/cgame/cg_consolecmds.c	(revision 3378)
+++ code/cgame/cg_consolecmds.c	(working copy)
@@ -581,5 +581,4 @@
 	trap_AddCommand ("teamvote");
 	trap_AddCommand ("stats");
 	trap_AddCommand ("teamtask");
-	trap_AddCommand ("loaddefered");	// spelled wrong, but not changing for demo
 }
Index: code/cgame/cg_draw.c
===================================================================
--- code/cgame/cg_draw.c	(revision 3378)
+++ code/cgame/cg_draw.c	(working copy)
@@ -756,7 +756,7 @@
 		if ( !total ) {
 			total = 1;
 		}
-		fps = 1000 * FPS_FRAMES / total;
+		fps = 1000 * FPS_FRAMES / (float)total;
 
 		s = va( "%ifps", fps );
 		w = CG_DrawStrlen( s ) * BIGCHAR_WIDTH;
@@ -1198,6 +1198,16 @@
 			continue;
 		}
 
+#ifdef MISSIONPACK
+		if (i == PW_SCOUT
+			|| i == PW_GUARD
+			|| i == PW_DOUBLER
+			|| i == PW_AMMOREGEN)
+		{
+			continue;
+		}
+#endif
+
 		// ZOID--don't draw if the power up has unlimited time
 		// This is true of the CTF flags
 		if ( ps->powerups[ i ] == INT_MAX ) {
Index: code/cgame/cg_effects.c
===================================================================
--- code/cgame/cg_effects.c	(revision 3378)
+++ code/cgame/cg_effects.c	(working copy)
@@ -635,8 +635,8 @@
 	if ( CG_PointContents( playerOrigin, -1 ) & ( CONTENTS_WATER | CONTENTS_SLIME ) ) {
 		CG_SpawnBubbles( NULL, playerOrigin, 3, 5 + random() * 5 );
 	}
-
-	if ( !cg_blood.integer ) {
+	// allow gibs to be turned off for speed
+	if ( !cg_blood.integer || !cg_gibs.integer ) {
 		return;
 	}
 
@@ -650,11 +650,6 @@
 		CG_LaunchGib( origin, velocity, cgs.media.gibBrain );
 	}
 
-	// allow gibs to be turned off for speed
-	if ( !cg_gibs.integer ) {
-		return;
-	}
-
 	VectorCopy( playerOrigin, origin );
 	velocity[0] = crandom()*GIB_VELOCITY;
 	velocity[1] = crandom()*GIB_VELOCITY;
@@ -746,8 +741,6 @@
 /*
 ===================
 CG_BigExplode
-
-Generated a bunch of gibs launching out from the bodies location
 ===================
 */
 void CG_BigExplode( vec3_t playerOrigin ) {
Index: code/cgame/cg_ents.c
===================================================================
--- code/cgame/cg_ents.c	(revision 3378)
+++ code/cgame/cg_ents.c	(working copy)
@@ -480,7 +480,7 @@
 	// flicker between two skins
 	ent.skinNum = cg.clientFrame & 1;
 	ent.hModel = weapon->missileModel;
-	ent.renderfx = weapon->missileRenderfx | RF_NOSHADOW;
+	ent.renderfx = RF_NOSHADOW;
 
 #ifdef MISSIONPACK
 	if ( cent->currentState.weapon == WP_PROX_LAUNCHER ) {
@@ -553,7 +553,7 @@
 	// flicker between two skins
 	ent.skinNum = cg.clientFrame & 1;
 	ent.hModel = weapon->missileModel;
-	ent.renderfx = weapon->missileRenderfx | RF_NOSHADOW;
+	ent.renderfx = RF_NOSHADOW;
 
 	// convert direction of travel into axis
 	if ( VectorNormalize2( s1->pos.trDelta, ent.axis[0] ) == 0 ) {
@@ -932,7 +932,7 @@
 				model.shaderRGBA[2] = 0xff;
 				model.shaderRGBA[3] = 0xff;
 				//
-				model.origin[2] += 56;
+				model.origin[2] += OBELISK_TARGET_HEIGHT;
 				model.hModel = cgs.media.overloadTargetModel;
 				trap_R_AddRefEntityToScene( &model );
 			}
Index: code/cgame/cg_local.h
===================================================================
--- code/cgame/cg_local.h	(revision 3378)
+++ code/cgame/cg_local.h	(working copy)
@@ -156,7 +156,6 @@
 
 	int				muzzleFlashTime;	// move to playerEntity?
 	int				previousEvent;
-	int				teleportFlag;
 
 	int				trailTime;		// so missile trails can handle dropped initial packets
 	int				dustTrailTime;
@@ -167,10 +166,7 @@
 	playerEntity_t	pe;
 
 	int				errorTime;		// decay the error from this time
-	vec3_t			errorOrigin;
-	vec3_t			errorAngles;
-	
-	qboolean		extrapolated;	// false if origin / angles is an interpolation
+
 	vec3_t			rawOrigin;
 	vec3_t			rawAngles;
 
@@ -276,7 +272,6 @@
 	int				ping;
 	int				time;
 	int				scoreFlags;
-	int				powerUps;
 	int				accuracy;
 	int				impressiveCount;
 	int				excellentCount;
@@ -395,7 +390,6 @@
 	void			(*missileTrailFunc)( centity_t *, const struct weaponInfo_s *wi );
 	float			missileDlight;
 	vec3_t			missileDlightColor;
-	int				missileRenderfx;
 
 	void			(*ejectBrassFunc)( centity_t * );
 
@@ -417,11 +411,6 @@
 } itemInfo_t;
 
 
-typedef struct {
-	int				itemNum;
-} powerupInfo_t;
-
-
 #define MAX_SKULLTRAIL		10
 
 typedef struct {
@@ -466,7 +455,7 @@
 
 	int			frametime;		// cg.time - cg.oldTime
 
-	int			time;			// this is the time value that the client
+	int			time;			// this is the server time value that the client
 								// is rendering at.
 	int			oldTime;		// time at last frame, used for missile trails and prediction checking
 
@@ -633,7 +622,7 @@
 // all of the model, shader, and sound references that are
 // loaded at gamestate time are stored in cgMedia_t
 // Other media that can be tied to clients, weapons, or items are
-// stored in the clientInfo_t, itemInfo_t, weaponInfo_t, and powerupInfo_t
+// stored in the clientInfo_t, weaponInfo_t, or itemInfo_t
 typedef struct {
 	qhandle_t	charsetShader;
 	qhandle_t	charsetProp;
@@ -858,7 +847,6 @@
 	sfxHandle_t	respawnSound;
 	sfxHandle_t talkSound;
 	sfxHandle_t landSound;
-	sfxHandle_t fallSound;
 	sfxHandle_t jumpPadSound;
 
 	sfxHandle_t oneMinuteSound;
@@ -994,7 +982,6 @@
 	// parsed from serverinfo
 	gametype_t		gametype;
 	int				dmflags;
-	int				teamflags;
 	int				fraglimit;
 	int				capturelimit;
 	int				timelimit;
@@ -1129,6 +1116,7 @@
 extern	vmCvar_t		cg_lagometer;
 extern	vmCvar_t		cg_drawAttacker;
 extern	vmCvar_t		cg_synchronousClients;
+extern	vmCvar_t		cg_singlePlayer;
 extern	vmCvar_t		cg_teamChatTime;
 extern	vmCvar_t		cg_teamChatHeight;
 extern	vmCvar_t		cg_stats;
@@ -1170,7 +1158,6 @@
 extern	vmCvar_t		cg_blueTeamName;
 extern	vmCvar_t		cg_currentSelectedPlayer;
 extern	vmCvar_t		cg_currentSelectedPlayerName;
-extern	vmCvar_t		cg_singlePlayer;
 extern	vmCvar_t		cg_enableDust;
 extern	vmCvar_t		cg_enableBreath;
 extern  vmCvar_t		cg_recordSPDemo;
Index: code/cgame/cg_marks.c
===================================================================
--- code/cgame/cg_marks.c	(revision 3378)
+++ code/cgame/cg_marks.c	(working copy)
@@ -32,6 +32,11 @@
 ===================================================================
 */
 
+// doubled to support more marks if r_marksOnTriangleMeshes is on, see ioquake3 README
+#define MAX_MARK_FRAGMENTS 256
+#define MAX_MARK_POINTS 768
+#define	MARK_TOTAL_TIME 10000
+#define	MARK_FADE_TIME 1000
 
 markPoly_t	cg_activeMarkPolys;			// double linked list
 markPoly_t	*cg_freeMarkPolys;			// single linked list
@@ -124,9 +129,6 @@
 passed to the renderer.
 =================
 */
-#define	MAX_MARK_FRAGMENTS	128
-#define	MAX_MARK_POINTS		384
-
 void CG_ImpactMark( qhandle_t markShader, const vec3_t origin, const vec3_t dir, 
 				   float orientation, float red, float green, float blue, float alpha,
 				   qboolean alphaFade, float radius, qboolean temporary ) {
@@ -227,9 +229,6 @@
 CG_AddMarks
 ===============
 */
-#define	MARK_TOTAL_TIME		10000
-#define	MARK_FADE_TIME		1000
-
 void CG_AddMarks( void ) {
 	int			j;
 	markPoly_t	*mp, *next;
Index: code/cgame/cg_newdraw.c
===================================================================
--- code/cgame/cg_newdraw.c	(revision 3378)
+++ code/cgame/cg_newdraw.c	(working copy)
@@ -1392,11 +1392,12 @@
 
 
 void CG_DrawMedal(int ownerDraw, rectDef_t *rect, float scale, vec4_t color, qhandle_t shader) {
-	score_t *score = &cg.scores[cg.selectedScore];
+	score_t *score;
 	float value = 0;
 	char *text = NULL;
 	color[3] = 0.25;
 
+	score = &cg.scores[cg.selectedScore];
 	switch (ownerDraw) {
 		case CG_ACCURACY:
 			value = score->accuracy;
Index: code/cgame/cg_players.c
===================================================================
--- code/cgame/cg_players.c	(revision 3378)
+++ code/cgame/cg_players.c	(working copy)
@@ -2687,7 +2687,6 @@
 */
 void CG_ResetPlayerEntity( centity_t *cent ) {
 	cent->errorTime = -99999;		// guarantee no error decay added
-	cent->extrapolated = qfalse;	
 
 	CG_ClearLerpFrame( &cgs.clientinfo[ cent->currentState.clientNum ], &cent->pe.legs, cent->currentState.legsAnim );
 	CG_ClearLerpFrame( &cgs.clientinfo[ cent->currentState.clientNum ], &cent->pe.torso, cent->currentState.torsoAnim );
Index: code/cgame/cg_servercmds.c
===================================================================
--- code/cgame/cg_servercmds.c	(revision 3378)
+++ code/cgame/cg_servercmds.c	(working copy)
@@ -160,7 +160,6 @@
 	cgs.gametype = atoi( Info_ValueForKey( info, "g_gametype" ) );
 	trap_Cvar_SetValue("g_gametype", cgs.gametype);
 	cgs.dmflags = atoi( Info_ValueForKey( info, "dmflags" ) );
-	cgs.teamflags = atoi( Info_ValueForKey( info, "teamflags" ) );
 	cgs.fraglimit = atoi( Info_ValueForKey( info, "fraglimit" ) );
 	cgs.capturelimit = atoi( Info_ValueForKey( info, "capturelimit" ) );
 	cgs.timelimit = atoi( Info_ValueForKey( info, "timelimit" ) );
@@ -1085,7 +1084,7 @@
 	}
 
 	// loaddeferred can be both a servercmd and a consolecmd
-	if ( !strcmp( cmd, "loaddefered" ) ) {	// FIXME: spelled wrong, but not changing for demo
+	if ( !strcmp( cmd, "loaddeferred" ) ) {
 		CG_LoadDeferredPlayers();
 		return;
 	}
Index: code/cgame/cg_weapons.c
===================================================================
--- code/cgame/cg_weapons.c	(revision 3378)
+++ code/cgame/cg_weapons.c	(working copy)
@@ -853,8 +853,7 @@
 	//
 	// powerups have an accompanying ring or sphere
 	//
-	if ( item->giType == IT_POWERUP || item->giType == IT_HEALTH || 
-		item->giType == IT_ARMOR || item->giType == IT_HOLDABLE ) {
+	if ( item->giType == IT_POWERUP || item->giType == IT_HEALTH ) {
 		if ( item->world_model[1] ) {
 			itemInfo->models[1] = trap_R_RegisterModel( item->world_model[1] );
 		}
Index: code/client/cl_main.c
===================================================================
--- code/client/cl_main.c	(revision 3378)
+++ code/client/cl_main.c	(working copy)
@@ -163,17 +163,6 @@
 void CL_ServerStatus_f(void);
 void CL_ServerStatusResponse( netadr_t from, msg_t *msg );
 
-/*
-===============
-CL_CDDialog
-
-Called by Com_Error when a cd is needed
-===============
-*/
-void CL_CDDialog( void ) {
-	cls.cddialog = qtrue;	// start it next frame
-}
-
 #ifdef USE_MUMBLE
 static
 void CL_UpdateMumble(void)
@@ -1550,89 +1539,6 @@
 }
 
 /*
-===================
-CL_RequestAuthorization
-
-Authorization server protocol
------------------------------
-
-All commands are text in Q3 out of band packets (leading 0xff 0xff 0xff 0xff).
-
-Whenever the client tries to get a challenge from the server it wants to
-connect to, it also blindly fires off a packet to the authorize server:
-
-getKeyAuthorize <challenge> <cdkey>
-
-cdkey may be "demo"
-
-
-#OLD The authorize server returns a:
-#OLD 
-#OLD keyAthorize <challenge> <accept | deny>
-#OLD 
-#OLD A client will be accepted if the cdkey is valid and it has not been used by any other IP
-#OLD address in the last 15 minutes.
-
-
-The server sends a:
-
-getIpAuthorize <challenge> <ip>
-
-The authorize server returns a:
-
-ipAuthorize <challenge> <accept | deny | demo | unknown >
-
-A client will be accepted if a valid cdkey was sent by that ip (only) in the last 15 minutes.
-If no response is received from the authorize server after two tries, the client will be let
-in anyway.
-===================
-*/
-#ifndef STANDALONE
-void CL_RequestAuthorization( void ) {
-	char	nums[64];
-	int		i, j, l;
-	cvar_t	*fs;
-
-	if ( !cls.authorizeServer.port ) {
-		Com_Printf( "Resolving %s\n", AUTHORIZE_SERVER_NAME );
-		if ( !NET_StringToAdr( AUTHORIZE_SERVER_NAME, &cls.authorizeServer, NA_IP ) ) {
-			Com_Printf( "Couldn't resolve address\n" );
-			return;
-		}
-
-		cls.authorizeServer.port = BigShort( PORT_AUTHORIZE );
-		Com_Printf( "%s resolved to %i.%i.%i.%i:%i\n", AUTHORIZE_SERVER_NAME,
-			cls.authorizeServer.ip[0], cls.authorizeServer.ip[1],
-			cls.authorizeServer.ip[2], cls.authorizeServer.ip[3],
-			BigShort( cls.authorizeServer.port ) );
-	}
-	if ( cls.authorizeServer.type == NA_BAD ) {
-		return;
-	}
-
-	// only grab the alphanumeric values from the cdkey, to avoid any dashes or spaces
-	j = 0;
-	l = strlen( cl_cdkey );
-	if ( l > 32 ) {
-		l = 32;
-	}
-	for ( i = 0 ; i < l ; i++ ) {
-		if ( ( cl_cdkey[i] >= '0' && cl_cdkey[i] <= '9' )
-				|| ( cl_cdkey[i] >= 'a' && cl_cdkey[i] <= 'z' )
-				|| ( cl_cdkey[i] >= 'A' && cl_cdkey[i] <= 'Z' )
-			 ) {
-			nums[j] = cl_cdkey[i];
-			j++;
-		}
-	}
-	nums[j] = 0;
-
-	fs = Cvar_Get ("cl_anonymous", "0", CVAR_INIT|CVAR_SYSTEMINFO );
-
-	NET_OutOfBandPrint(NS_CLIENT, cls.authorizeServer, "getKeyAuthorize %i %s", fs->integer, nums );
-}
-#endif
-/*
 ======================================================================
 
 CONSOLE COMMANDS
@@ -1759,8 +1665,7 @@
 	else
 		CL_UpdateGUID( NULL, 0 );
 
-	// if we aren't playing on a lan, we need to authenticate
-	// with the cd key
+	// if we aren't playing on a lan, send challenge to prevent connection hijacking
 	if(NET_IsLocalAddress(clc.serverAddress))
 		clc.state = CA_CHALLENGING;
 	else
@@ -2359,12 +2264,6 @@
 
 	switch ( clc.state ) {
 	case CA_CONNECTING:
-		// requesting a challenge .. IPv6 users always get in as authorize server supports no ipv6.
-#ifndef STANDALONE
-		if (!com_standalone->integer && clc.serverAddress.type == NA_IP && !Sys_IsLANAddress( clc.serverAddress ) )
-			CL_RequestAuthorization();
-#endif
-
 		// The challenge request shall be followed by a client challenge so no malicious server can hijack this connection.
 		// Add the gamename so the server knows we're running the correct game or can reject the client
 		// with a meaningful message
@@ -2452,7 +2351,6 @@
 	server->game[0] = '\0';
 	server->gameType = 0;
 	server->netType = 0;
-	server->punkbuster = 0;
 	server->g_humanplayers = 0;
 	server->g_needpass = 0;
 }
@@ -2648,30 +2546,12 @@
 #ifdef LEGACY_PROTOCOL
 		else
 			clc.compat = qtrue;
-		
-		if(clc.compat)
-		{
-			if(!NET_CompareAdr(from, clc.serverAddress))
-			{
-				// This challenge response is not coming from the expected address.
-				// Check whether we have a matching client challenge to prevent
-				// connection hi-jacking.
-			
-				if(!*c || challenge != clc.challenge)
-				{
-					Com_DPrintf("Challenge response received from unexpected source. Ignored.\n");
-					return;
-				}
-			}
-		}
-		else
 #endif
+
+		if(!*c || challenge != clc.challenge)
 		{
-			if(!*c || challenge != clc.challenge)
-			{
-				Com_Printf("Bad challenge for challengeResponse. Ignored.\n");
-				return;
-			}
+			Com_Printf("Bad challenge for challengeResponse. Ignored.\n");
+			return;
 		}
 
 		// start sending challenge response instead of challenge request packets
@@ -2702,26 +2582,21 @@
 			return;
 		}
 
-#ifdef LEGACY_PROTOCOL
-		if(!clc.compat)
-#endif
+		c = Cmd_Argv(1);
+
+		if(*c)
+			challenge = atoi(c);
+		else
 		{
-			c = Cmd_Argv(1);
-
-			if(*c)
-				challenge = atoi(c);
-			else
-			{
-				Com_Printf("Bad connectResponse received. Ignored.\n");
-				return;
-			}
-			
-			if(challenge != clc.challenge)
-			{
-				Com_Printf("ConnectResponse with bad challenge received. Ignored.\n");
-				return;
-			}
+			Com_Printf("Bad connectResponse received. Ignored.\n");
+			return;
 		}
+		
+		if(challenge != clc.challenge)
+		{
+			Com_Printf("ConnectResponse with bad challenge received. Ignored.\n");
+			return;
+		}
 
 #ifdef LEGACY_PROTOCOL
 		Netchan_Setup(NS_CLIENT, &clc.netchan, from, Cvar_VariableValue("net_qport"),
@@ -2757,12 +2632,6 @@
 		return;
 	}
 
-	// cd check
-	if ( !Q_stricmp(c, "keyAuthorize") ) {
-		// we don't use these now, so dump them on the floor
-		return;
-	}
-
 	// global MOTD from id
 	if ( !Q_stricmp(c, "motd") ) {
 		CL_MotdPacket( from );
@@ -2953,11 +2822,7 @@
 	}
 #endif
 
-	if ( cls.cddialog ) {
-		// bring up the cd error dialog if needed
-		cls.cddialog = qfalse;
-		VM_Call( uivm, UI_SET_ACTIVE_MENU, UIMENU_NEED_CD );
-	} else	if ( clc.state == CA_DISCONNECTED && !( Key_GetCatcher( ) & KEYCATCH_UI )
+	if ( clc.state == CA_DISCONNECTED && !( Key_GetCatcher( ) & KEYCATCH_UI )
 		&& !com_sv_running->integer && uivm ) {
 		// if disconnected, bring up the menu
 		S_StopAllSounds();
@@ -3788,7 +3653,6 @@
 			server->netType = atoi(Info_ValueForKey(info, "nettype"));
 			server->minPing = atoi(Info_ValueForKey(info, "minping"));
 			server->maxPing = atoi(Info_ValueForKey(info, "maxping"));
-			server->punkbuster = atoi(Info_ValueForKey(info, "punkbuster"));
 			server->g_humanplayers = atoi(Info_ValueForKey(info, "g_humanplayers"));
 			server->g_needpass = atoi(Info_ValueForKey(info, "g_needpass"));
 		}
@@ -3836,15 +3700,8 @@
 
 	// if this isn't the correct gamename, ignore it
 	gamename = Info_ValueForKey( infoString, "gamename" );
+	gameMismatch = !*gamename || strcmp(gamename, com_gamename->string) != 0;
 
-#ifdef LEGACY_PROTOCOL
-	// gamename is optional for legacy protocol
-	if (com_legacyprotocol->integer && !*gamename)
-		gameMismatch = qfalse;
-	else
-#endif
-		gameMismatch = !*gamename || strcmp(gamename, com_gamename->string) != 0;
-
 	if (gameMismatch)
 	{
 		Com_DPrintf( "Game mismatch in info packet: %s\n", infoString );
@@ -4638,71 +4495,3 @@
 void CL_ShowIP_f(void) {
 	Sys_ShowIP();
 }
-
-/*
-=================
-CL_CDKeyValidate
-=================
-*/
-qboolean CL_CDKeyValidate( const char *key, const char *checksum ) {
-#ifdef STANDALONE
-	return qtrue;
-#else
-	char	ch;
-	byte	sum;
-	char	chs[3];
-	int i, len;
-
-	len = strlen(key);
-	if( len != CDKEY_LEN ) {
-		return qfalse;
-	}
-
-	if( checksum && strlen( checksum ) != CDCHKSUM_LEN ) {
-		return qfalse;
-	}
-
-	sum = 0;
-	// for loop gets rid of conditional assignment warning
-	for (i = 0; i < len; i++) {
-		ch = *key++;
-		if (ch>='a' && ch<='z') {
-			ch -= 32;
-		}
-		switch( ch ) {
-		case '2':
-		case '3':
-		case '7':
-		case 'A':
-		case 'B':
-		case 'C':
-		case 'D':
-		case 'G':
-		case 'H':
-		case 'J':
-		case 'L':
-		case 'P':
-		case 'R':
-		case 'S':
-		case 'T':
-		case 'W':
-			sum += ch;
-			continue;
-		default:
-			return qfalse;
-		}
-	}
-
-	sprintf(chs, "%02x", sum);
-	
-	if (checksum && !Q_stricmp(chs, checksum)) {
-		return qtrue;
-	}
-
-	if (!checksum) {
-		return qtrue;
-	}
-
-	return qfalse;
-#endif
-}
Index: code/client/cl_net_chan.c
===================================================================
--- code/client/cl_net_chan.c	(revision 3378)
+++ code/client/cl_net_chan.c	(working copy)
@@ -24,111 +24,7 @@
 #include "../qcommon/qcommon.h"
 #include "client.h"
 
-#ifdef LEGACY_PROTOCOL
 /*
-==============
-CL_Netchan_Encode
-
-	// first 12 bytes of the data are always:
-	long serverId;
-	long messageAcknowledge;
-	long reliableAcknowledge;
-
-==============
-*/
-static void CL_Netchan_Encode( msg_t *msg ) {
-	int serverId, messageAcknowledge, reliableAcknowledge;
-	int i, index, srdc, sbit, soob;
-	byte key, *string;
-
-	if ( msg->cursize <= CL_ENCODE_START ) {
-		return;
-	}
-
-        srdc = msg->readcount;
-        sbit = msg->bit;
-        soob = msg->oob;
-        
-        msg->bit = 0;
-        msg->readcount = 0;
-        msg->oob = 0;
-        
-        serverId = MSG_ReadLong(msg);
-	messageAcknowledge = MSG_ReadLong(msg);
-	reliableAcknowledge = MSG_ReadLong(msg);
-
-        msg->oob = soob;
-        msg->bit = sbit;
-        msg->readcount = srdc;
-        
-	string = (byte *)clc.serverCommands[ reliableAcknowledge & (MAX_RELIABLE_COMMANDS-1) ];
-	index = 0;
-	//
-	key = clc.challenge ^ serverId ^ messageAcknowledge;
-	for (i = CL_ENCODE_START; i < msg->cursize; i++) {
-		// modify the key with the last received now acknowledged server command
-		if (!string[index])
-			index = 0;
-		if (string[index] > 127 || string[index] == '%') {
-			key ^= '.' << (i & 1);
-		}
-		else {
-			key ^= string[index] << (i & 1);
-		}
-		index++;
-		// encode the data with this key
-		*(msg->data + i) = (*(msg->data + i)) ^ key;
-	}
-}
-
-/*
-==============
-CL_Netchan_Decode
-
-	// first four bytes of the data are always:
-	long reliableAcknowledge;
-
-==============
-*/
-static void CL_Netchan_Decode( msg_t *msg ) {
-	long reliableAcknowledge, i, index;
-	byte key, *string;
-        int	srdc, sbit, soob;
-
-        srdc = msg->readcount;
-        sbit = msg->bit;
-        soob = msg->oob;
-        
-        msg->oob = 0;
-        
-	reliableAcknowledge = MSG_ReadLong(msg);
-
-        msg->oob = soob;
-        msg->bit = sbit;
-        msg->readcount = srdc;
-
-	string = (byte *) clc.reliableCommands[ reliableAcknowledge & (MAX_RELIABLE_COMMANDS-1) ];
-	index = 0;
-	// xor the client challenge with the netchan sequence number (need something that changes every message)
-	key = clc.challenge ^ LittleLong( *(unsigned *)msg->data );
-	for (i = msg->readcount + CL_DECODE_START; i < msg->cursize; i++) {
-		// modify the key with the last sent and with this message acknowledged client command
-		if (!string[index])
-			index = 0;
-		if (string[index] > 127 || string[index] == '%') {
-			key ^= '.' << (i & 1);
-		}
-		else {
-			key ^= string[index] << (i & 1);
-		}
-		index++;
-		// decode the data with this key
-		*(msg->data + i) = *(msg->data + i) ^ key;
-	}
-}
-#endif
-
-/*
 =================
 CL_Netchan_TransmitNextFragment
 =================
@@ -152,11 +48,6 @@
 void CL_Netchan_Transmit( netchan_t *chan, msg_t* msg ) {
 	MSG_WriteByte( msg, clc_EOF );
 
-#ifdef LEGACY_PROTOCOL
-	if(chan->compat)
-		CL_Netchan_Encode(msg);
-#endif
-
 	Netchan_Transmit(chan, msg->cursize, msg->data);
 	
 	// Transmit all fragments without delay
@@ -178,10 +69,5 @@
 	if (!ret)
 		return qfalse;
 
-#ifdef LEGACY_PROTOCOL
-	if(chan->compat)
-		CL_Netchan_Decode(msg);
-#endif
-
 	return qtrue;
 }
Index: code/client/cl_parse.c
===================================================================
--- code/client/cl_parse.c	(revision 3378)
+++ code/client/cl_parse.c	(working copy)
@@ -354,16 +354,9 @@
 	cl.serverId = atoi( Info_ValueForKey( systemInfo, "sv_serverid" ) );
 
 #ifdef USE_VOIP
-#ifdef LEGACY_PROTOCOL
-	if(clc.compat)
-		clc.voipEnabled = qfalse;
-	else
+	s = Info_ValueForKey( systemInfo, "sv_voipProtocol" );
+	clc.voipEnabled = !Q_stricmp(s, "opus");
 #endif
-	{
-		s = Info_ValueForKey( systemInfo, "sv_voipProtocol" );
-		clc.voipEnabled = !Q_stricmp(s, "opus");
-	}
-#endif
 
 	// don't set any vars when playing a demo
 	if ( clc.demoplaying ) {
Index: code/client/cl_ui.c
===================================================================
--- code/client/cl_ui.c	(revision 3378)
+++ code/client/cl_ui.c	(working copy)
@@ -100,7 +100,6 @@
 			servers = &cls.localServers[0];
 			count = MAX_OTHER_SERVERS;
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			servers = &cls.globalServers[0];
 			count = MAX_GLOBAL_SERVERS;
@@ -134,7 +133,6 @@
 			count = &cls.numlocalservers;
 			servers = &cls.localServers[0];
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			max = MAX_GLOBAL_SERVERS;
 			count = &cls.numglobalservers;
@@ -178,7 +176,6 @@
 			count = &cls.numlocalservers;
 			servers = &cls.localServers[0];
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			count = &cls.numglobalservers;
 			servers = &cls.globalServers[0];
@@ -216,7 +213,6 @@
 		case AS_LOCAL :
 			return cls.numlocalservers;
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			return cls.numglobalservers;
 			break;
@@ -240,7 +236,6 @@
 				return;
 			}
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 				Q_strncpyz(buf, NET_AdrToStringwPort( cls.globalServers[n].adr) , buflen );
@@ -272,7 +267,6 @@
 				server = &cls.localServers[n];
 			}
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 				server = &cls.globalServers[n];
@@ -297,7 +291,6 @@
 		Info_SetValueForKey( info, "gametype", va("%i",server->gameType));
 		Info_SetValueForKey( info, "nettype", va("%i",server->netType));
 		Info_SetValueForKey( info, "addr", NET_AdrToStringwPort(server->adr));
-		Info_SetValueForKey( info, "punkbuster", va("%i", server->punkbuster));
 		Info_SetValueForKey( info, "g_needpass", va("%i", server->g_needpass));
 		Info_SetValueForKey( info, "g_humanplayers", va("%i", server->g_humanplayers));
 		Q_strncpyz(buf, info, buflen);
@@ -321,7 +314,6 @@
 				server = &cls.localServers[n];
 			}
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 				server = &cls.globalServers[n];
@@ -351,7 +343,6 @@
 				return &cls.localServers[n];
 			}
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 				return &cls.globalServers[n];
@@ -494,7 +485,6 @@
 			case AS_LOCAL :
 				server = &cls.localServers[0];
 				break;
-			case AS_MPLAYER:
 			case AS_GLOBAL :
 				server = &cls.globalServers[0];
 				count = MAX_GLOBAL_SERVERS;
@@ -516,7 +506,6 @@
 					cls.localServers[n].visible = visible;
 				}
 				break;
-			case AS_MPLAYER:
 			case AS_GLOBAL :
 				if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 					cls.globalServers[n].visible = visible;
@@ -544,7 +533,6 @@
 				return cls.localServers[n].visible;
 			}
 			break;
-		case AS_MPLAYER:
 		case AS_GLOBAL :
 			if (n >= 0 && n < MAX_GLOBAL_SERVERS) {
 				return cls.globalServers[n].visible;
@@ -634,50 +622,6 @@
 
 /*
 ====================
-CLUI_GetCDKey
-====================
-*/
-static void CLUI_GetCDKey( char *buf, int buflen ) {
-#ifndef STANDALONE
-	const char *gamedir;
-	gamedir = Cvar_VariableString( "fs_game" );
-	if (UI_usesUniqueCDKey() && gamedir[0] != 0) {
-		Com_Memcpy( buf, &cl_cdkey[16], 16);
-		buf[16] = 0;
-	} else {
-		Com_Memcpy( buf, cl_cdkey, 16);
-		buf[16] = 0;
-	}
-#else
-	*buf = 0;
-#endif
-}
-
-
-/*
-====================
-CLUI_SetCDKey
-====================
-*/
-#ifndef STANDALONE
-static void CLUI_SetCDKey( char *buf ) {
-	const char *gamedir;
-	gamedir = Cvar_VariableString( "fs_game" );
-	if (UI_usesUniqueCDKey() && gamedir[0] != 0) {
-		Com_Memcpy( &cl_cdkey[16], buf, 16 );
-		cl_cdkey[32] = 0;
-		// set the flag so the fle will be written at the next opportunity
-		cvar_modifiedFlags |= CVAR_ARCHIVE;
-	} else {
-		Com_Memcpy( cl_cdkey, buf, 16 );
-		// set the flag so the fle will be written at the next opportunity
-		cvar_modifiedFlags |= CVAR_ARCHIVE;
-	}
-}
-#endif
-
-/*
-====================
 GetConfigString
 ====================
 */
@@ -988,19 +932,6 @@
 	case UI_MEMORY_REMAINING:
 		return Hunk_MemoryRemaining();
 
-	case UI_GET_CDKEY:
-		CLUI_GetCDKey( VMA(1), args[2] );
-		return 0;
-
-	case UI_SET_CDKEY:
-#ifndef STANDALONE
-		CLUI_SetCDKey( VMA(1) );
-#endif
-		return 0;
-	
-	case UI_SET_PBCLSTATUS:
-		return 0;	
-
 	case UI_R_REGISTERFONT:
 		re.RegisterFont( VMA(1), args[2], VMA(3));
 		return 0;
@@ -1078,9 +1009,6 @@
 		re.RemapShader( VMA(1), VMA(2), VMA(3) );
 		return 0;
 
-	case UI_VERIFY_CDKEY:
-		return CL_CDKeyValidate(VMA(1), VMA(2));
-
 	case UI_R_SETCLIPREGION:
 		re.SetClipRegion( VMA(1) );
 		return 0;
@@ -1114,8 +1042,6 @@
 CL_InitUI
 ====================
 */
-#define UI_OLD_API_VERSION	4
-
 void CL_InitUI( void ) {
 	int		v;
 	vmInterpret_t		interpret;
@@ -1136,12 +1062,7 @@
 
 	// sanity check
 	v = VM_Call( uivm, UI_GETAPIVERSION );
-	if (v == UI_OLD_API_VERSION) {
-//		Com_Printf(S_COLOR_YELLOW "WARNING: loading old Quake III Arena User Interface version %d\n", v );
-		// init for this gamestate
-		VM_Call( uivm, UI_INIT, (clc.state >= CA_AUTHORIZING && clc.state < CA_ACTIVE));
-	}
-	else if (v != UI_API_VERSION) {
+	if (v != UI_API_VERSION) {
 		// Free uivm now, so UI_SHUTDOWN doesn't get called later.
 		VM_Free( uivm );
 		uivm = NULL;
@@ -1151,20 +1072,10 @@
 	}
 	else {
 		// init for this gamestate
-		VM_Call( uivm, UI_INIT, (clc.state >= CA_AUTHORIZING && clc.state < CA_ACTIVE) );
+		VM_Call( uivm, UI_INIT, (clc.state >= CA_CONNECTING && clc.state < CA_ACTIVE) );
 	}
 }
 
-#ifndef STANDALONE
-qboolean UI_usesUniqueCDKey( void ) {
-	if (uivm) {
-		return (VM_Call( uivm, UI_HASUNIQUECDKEY) == qtrue);
-	} else {
-		return qfalse;
-	}
-}
-#endif
-
 /*
 ====================
 UI_GameCommand
Index: code/client/client.h
===================================================================
--- code/client/client.h	(revision 3378)
+++ code/client/client.h	(working copy)
@@ -302,13 +302,11 @@
 	int			maxPing;
 	int			ping;
 	qboolean	visible;
-	int			punkbuster;
 	int			g_humanplayers;
 	int			g_needpass;
 } serverInfo_t;
 
 typedef struct {
-	qboolean	cddialog;			// bring up the cd needed dialog next frame
 
 	// when the server clears the hunk, all of these must be restarted
 	qboolean	rendererStarted;
@@ -342,8 +340,6 @@
 	char		updateChallenge[MAX_TOKEN_CHARS];
 	char		updateInfoString[MAX_INFO_STRING];
 
-	netadr_t	authorizeServer;
-
 	netadr_t	rconAddress;
 
 	// rendering info
@@ -482,7 +478,6 @@
 
 void CL_ShutdownRef( void );
 void CL_InitRef( void );
-qboolean CL_CDKeyValidate( const char *key, const char *checksum );
 int CL_ServerStatus( char *serverAddress, char *serverStatusString, int maxLen );
 
 qboolean CL_CheckPaused(void);
Index: code/client/keycodes.h
===================================================================
--- code/client/keycodes.h	(revision 3378)
+++ code/client/keycodes.h	(working copy)
@@ -296,11 +296,6 @@
 	MAX_KEYS
 } keyNum_t;
 
-// MAX_KEYS replaces K_LAST_KEY, however some mods may have used K_LAST_KEY
-// in detecting binds, so we leave it defined to the old hardcoded value
-// of maxiumum keys to prevent mods from crashing older versions of the engine
-#define K_LAST_KEY              256
-
 // The menu code needs to get both key and char events, but
 // to avoid duplicating the paths, the char events are just
 // distinguished by or'ing in K_CHAR_FLAG (ugly)
Index: code/game/ai_chat.c
===================================================================
--- code/game/ai_chat.c	(revision 3378)
+++ code/game/ai_chat.c	(working copy)
@@ -45,7 +45,9 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
+#include "ai_team.h"
 //
 #include "chars.h"				//characteristics
 #include "inv.h"				//indexes into the inventory
Index: code/game/ai_cmd.c
===================================================================
--- code/game/ai_cmd.c	(revision 3378)
+++ code/game/ai_cmd.c	(working copy)
@@ -45,6 +45,7 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
 #include "ai_team.h"
 //
@@ -1232,7 +1233,7 @@
 	//else it's in meters
 	else space = 32 * atof(buf);
 	//check if the formation intervening space is valid
-	if (space < 48 || space > 500) space = 100;
+	if (space < 48 || space > 500) space = 128;
 	bs->formation_dist = space;
 }
 
Index: code/game/ai_dmnet.c
===================================================================
--- code/game/ai_dmnet.c	(revision 3378)
+++ code/game/ai_dmnet.c	(working copy)
@@ -45,6 +45,7 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
 #include "ai_team.h"
 //data file headers
@@ -748,7 +749,7 @@
 		memcpy(goal, &bs->curpatrolpoint->goal, sizeof(bot_goal_t));
 		return qtrue;
 	}
-#ifdef CTF
+
 	if (gametype == GT_CTF) {
 		//if going for enemy flag
 		if (bs->ltgtype == LTG_GETFLAG) {
@@ -833,7 +834,6 @@
 			return qtrue;
 		}
 	}
-#endif //CTF
 #ifdef MISSIONPACK
 	else if (gametype == GT_1FCTF) {
 		if (bs->ltgtype == LTG_GETFLAG) {
@@ -1876,13 +1876,11 @@
 		if (bs->ltgtype == LTG_DEFENDKEYAREA) range = 400;
 		else range = 150;
 		//
-#ifdef CTF
 		if (gametype == GT_CTF) {
 			//if carrying a flag the bot shouldn't be distracted too much
 			if (BotCTFCarryingFlag(bs))
 				range = 50;
 		}
-#endif //CTF
 #ifdef MISSIONPACK
 		else if (gametype == GT_1FCTF) {
 			if (Bot1FCTFCarryingFlag(bs))
@@ -2061,7 +2059,7 @@
 		// if attacking an obelisk
 		if ( bs->enemy == redobelisk.entitynum ||
 			bs->enemy == blueobelisk.entitynum ) {
-			target[2] += 16;
+			target[2] += OBELISK_TARGET_HEIGHT;
 		}
 #endif
 	}
@@ -2365,7 +2363,7 @@
 			// if attacking an obelisk
 			if ( bs->enemy == redobelisk.entitynum ||
 				bs->enemy == blueobelisk.entitynum ) {
-				target[2] += 16;
+				target[2] += OBELISK_TARGET_HEIGHT;
 			}
 #endif
 		}
@@ -2402,13 +2400,12 @@
 	if (bs->check_time < FloatTime()) {
 		bs->check_time = FloatTime() + 1;
 		range = 150;
-#ifdef CTF
+
 		if (gametype == GT_CTF) {
 			//if carrying a flag the bot shouldn't be distracted too much
 			if (BotCTFCarryingFlag(bs))
 				range = 50;
 		}
-#endif //CTF
 #ifdef MISSIONPACK
 		else if (gametype == GT_1FCTF) {
 			if (Bot1FCTFCarryingFlag(bs))
@@ -2542,7 +2539,7 @@
 			// if attacking an obelisk
 			if ( bs->enemy == redobelisk.entitynum ||
 				bs->enemy == blueobelisk.entitynum ) {
-				target[2] += 16;
+				target[2] += OBELISK_TARGET_HEIGHT;
 			}
 #endif
 		}
Index: code/game/ai_dmq3.c
===================================================================
--- code/game/ai_dmq3.c	(revision 3378)
+++ code/game/ai_dmq3.c	(working copy)
@@ -46,6 +46,7 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
 #include "ai_team.h"
 //
@@ -578,7 +579,7 @@
 					//get the team goal time
 					bs->teamgoal_time = FloatTime() + TEAM_ACCOMPANY_TIME;
 					bs->ltgtype = LTG_TEAMACCOMPANY;
-					bs->formation_dist = 3.5 * 32;		//3.5 meter
+					bs->formation_dist = 128;
 					BotSetTeamStatus(bs);
 					bs->owndecision_time = FloatTime() + 5;
 				}
@@ -655,7 +656,7 @@
 					//get the team goal time
 					bs->teamgoal_time = FloatTime() + TEAM_ACCOMPANY_TIME;
 					bs->ltgtype = LTG_TEAMACCOMPANY;
-					bs->formation_dist = 3.5 * 32;		//3.5 meter
+					bs->formation_dist = 128;
 					//
 					BotSetTeamStatus(bs);
 					bs->owndecision_time = FloatTime() + 5;
@@ -701,9 +702,7 @@
 			bs->ltgtype == LTG_RETURNFLAG ||
 			bs->ltgtype == LTG_CAMPORDER ||
 			bs->ltgtype == LTG_PATROL ||
-			bs->ltgtype == LTG_GETITEM ||
-			bs->ltgtype == LTG_MAKELOVE_UNDER ||
-			bs->ltgtype == LTG_MAKELOVE_ONTOP) {
+			bs->ltgtype == LTG_GETITEM) {
 		return;
 	}
 	//
@@ -854,7 +853,7 @@
 					//get the team goal time
 					bs->teamgoal_time = FloatTime() + TEAM_ACCOMPANY_TIME;
 					bs->ltgtype = LTG_TEAMACCOMPANY;
-					bs->formation_dist = 3.5 * 32;		//3.5 meter
+					bs->formation_dist = 128;
 					BotSetTeamStatus(bs);
 					bs->owndecision_time = FloatTime() + 5;
 					return;
@@ -869,9 +868,7 @@
 					bs->ltgtype == LTG_CAMPORDER ||
 					bs->ltgtype == LTG_PATROL ||
 					bs->ltgtype == LTG_ATTACKENEMYBASE ||
-					bs->ltgtype == LTG_GETITEM ||
-					bs->ltgtype == LTG_MAKELOVE_UNDER ||
-					bs->ltgtype == LTG_MAKELOVE_ONTOP) {
+					bs->ltgtype == LTG_GETITEM) {
 				return;
 			}
 			//if not already attacking the enemy base
@@ -948,9 +945,7 @@
 			bs->ltgtype == LTG_CAMPORDER ||
 			bs->ltgtype == LTG_PATROL ||
 			bs->ltgtype == LTG_ATTACKENEMYBASE ||
-			bs->ltgtype == LTG_GETITEM ||
-			bs->ltgtype == LTG_MAKELOVE_UNDER ||
-			bs->ltgtype == LTG_MAKELOVE_ONTOP) {
+			bs->ltgtype == LTG_GETITEM) {
 		return;
 	}
 	//
@@ -1065,9 +1060,7 @@
 			bs->ltgtype == LTG_CAMPORDER ||
 			bs->ltgtype == LTG_PATROL ||
 			bs->ltgtype == LTG_ATTACKENEMYBASE ||
-			bs->ltgtype == LTG_GETITEM ||
-			bs->ltgtype == LTG_MAKELOVE_UNDER ||
-			bs->ltgtype == LTG_MAKELOVE_ONTOP) {
+			bs->ltgtype == LTG_GETITEM) {
 		return;
 	}
 	//
@@ -1210,9 +1203,7 @@
 			bs->ltgtype == LTG_PATROL ||
 			bs->ltgtype == LTG_ATTACKENEMYBASE ||
 			bs->ltgtype == LTG_HARVEST ||
-			bs->ltgtype == LTG_GETITEM ||
-			bs->ltgtype == LTG_MAKELOVE_UNDER ||
-			bs->ltgtype == LTG_MAKELOVE_ONTOP) {
+			bs->ltgtype == LTG_GETITEM) {
 		return;
 	}
 	//
@@ -1251,7 +1242,7 @@
 			//get the team goal time
 			bs->teamgoal_time = FloatTime() + TEAM_ACCOMPANY_TIME;
 			bs->ltgtype = LTG_TEAMACCOMPANY;
-			bs->formation_dist = 3.5 * 32;		//3.5 meter
+			bs->formation_dist = 128;
 			BotSetTeamStatus(bs);
 			return;
 		}
@@ -3293,7 +3284,7 @@
 		// if attacking an obelisk
 		if ( bs->enemy == redobelisk.entitynum ||
 			bs->enemy == blueobelisk.entitynum ) {
-			target[2] += 32;
+			target[2] += OBELISK_TARGET_HEIGHT;
 		}
 #endif
 		//aim at the obelisk
@@ -3446,10 +3437,11 @@
 				}
 			}
 		}
-		//if the projectile does radial damage
-		if (aim_skill > 0.6 && wi.proj.damagetype & DAMAGETYPE_RADIAL) {
-			//if the enemy isn't standing significantly higher than the bot
-			if (entinfo.origin[2] < bs->origin[2] + 16) {
+		//if the projectile does large radial damage
+		if (aim_skill > 0.6 && (wi.proj.damagetype & DAMAGETYPE_RADIAL) && wi.proj.radius > 50) {
+			//if the enemy isn't standing significantly higher than the bot and isn't in water
+			if (entinfo.origin[2] < bs->origin[2] + 16
+				&& !(trap_AAS_PointContents(entinfo.origin) & (CONTENTS_WATER|CONTENTS_SLIME|CONTENTS_LAVA))) {
 				//try to aim at the ground in front of the enemy
 				VectorCopy(entinfo.origin, end);
 				end[2] -= 64;
@@ -3853,8 +3845,7 @@
 	VectorAdd(mins, maxs, origin);
 	VectorScale(origin, 0.5, origin);
 	//touch distance of the button
-	dist = fabs(movedir[0]) * size[0] + fabs(movedir[1]) * size[1] + fabs(movedir[2]) * size[2];
-	dist *= 0.5;
+	dist = fabs(movedir[0]) * size[0] + fabs(movedir[1]) * size[1] + fabs(movedir[2]) * size[2] - lip;
 	//
 	trap_AAS_FloatForBSPEpairKey(bspent, "health", &health);
 	//if the button is shootable
@@ -4555,7 +4546,7 @@
 
 	// always predict when the goal change or at regular intervals
 	if (bs->predictobstacles_goalareanum == goal->areanum &&
-		bs->predictobstacles_time > FloatTime() - 6) {
+		bs->predictobstacles_time > FloatTime() - 0.5) {
 		return qfalse;
 	}
 	bs->predictobstacles_goalareanum = goal->areanum;
Index: code/game/ai_main.c
===================================================================
--- code/game/ai_main.c	(revision 3378)
+++ code/game/ai_main.c	(working copy)
@@ -47,13 +47,14 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
-#include "ai_vcmd.h"
-
+#include "ai_team.h"
 //
-#include "chars.h"
-#include "inv.h"
-#include "syn.h"
+#include "chars.h"				//characteristics
+#include "inv.h"				//indexes into the inventory
+#include "syn.h"				//synonyms
+#include "match.h"				//string matching types and vars
 
 
 //bot states
Index: code/game/ai_main.h
===================================================================
--- code/game/ai_main.h	(revision 3378)
+++ code/game/ai_main.h	(working copy)
@@ -56,8 +56,6 @@
 #define LTG_KILL					11	//kill someone
 #define LTG_HARVEST					12	//harvest skulls
 #define LTG_ATTACKENEMYBASE			13	//attack the enemy base
-#define LTG_MAKELOVE_UNDER			14
-#define LTG_MAKELOVE_ONTOP			15
 //some goal dedication times
 #define TEAM_HELP_TIME				60	//1 minute teamplay help time
 #define TEAM_ACCOMPANY_TIME			600	//10 minutes teamplay accompany time
Index: code/game/ai_team.c
===================================================================
--- code/game/ai_team.c	(revision 3378)
+++ code/game/ai_team.c	(working copy)
@@ -45,12 +45,15 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
 #include "ai_team.h"
-#include "ai_vcmd.h"
+//
+#include "chars.h"				//characteristics
+#include "inv.h"				//indexes into the inventory
+#include "syn.h"				//synonyms
+#include "match.h"				//string matching types and vars
 
-#include "match.h"
-
 // for the voice chats
 #include "../../ui/menudef.h"
 
@@ -142,7 +145,7 @@
 			goal = &ctf_blueflag;
 	}
 #ifdef MISSIONPACK
-	else {
+	else if (gametype == GT_OBELISK || gametype == GT_HARVESTER) {
 		if (BotTeam(bs) == TEAM_RED)
 			goal = &redobelisk;
 		else
@@ -328,7 +331,7 @@
 
 /*
 ==================
-BotCTFOrders
+BotCTFOrders_BothFlagsNotAtBase
 ==================
 */
 void BotCTFOrders_BothFlagsNotAtBase(bot_state_t *bs) {
@@ -339,7 +342,7 @@
 	numteammates = BotSortTeamMatesByBaseTravelTime(bs, teammates, sizeof(teammates));
 	BotSortTeamMatesByTaskPreference(bs, teammates, numteammates);
 	//different orders based on the number of team mates
-	switch(bs->numteammates) {
+	switch(numteammates) {
 		case 1: break;
 		case 2:
 		{
@@ -419,8 +422,8 @@
 					//
 					ClientName(teammates[i], name, sizeof(name));
 					BotAI_BotInitialChat(bs, "cmd_getflag", name, NULL);
+					BotSayTeamOrder(bs, teammates[i]);
 					BotSayVoiceTeamOrder(bs, teammates[i], VOICECHAT_GETFLAG);
-					BotSayTeamOrder(bs, teammates[i]);
 				}
 			}
 			for (i = 0; i < attackers; i++) {
@@ -442,10 +445,10 @@
 
 /*
 ==================
-BotCTFOrders
+BotCTFOrders_TeamFlagNotAtBase
 ==================
 */
-void BotCTFOrders_FlagNotAtBase(bot_state_t *bs) {
+void BotCTFOrders_TeamFlagNotAtBase(bot_state_t *bs) {
 	int numteammates, defenders, attackers, i;
 	int teammates[MAX_CLIENTS];
 	char name[MAX_NETNAME];
@@ -455,7 +458,7 @@
 	//passive strategy
 	if (!(bs->ctfstrategy & CTFS_AGRESSIVE)) {
 		//different orders based on the number of team mates
-		switch(bs->numteammates) {
+		switch(numteammates) {
 			case 1: break;
 			case 2:
 			{
@@ -509,7 +512,7 @@
 					ClientName(teammates[numteammates - i - 1], name, sizeof(name));
 					BotAI_BotInitialChat(bs, "cmd_getflag", name, NULL);
 					BotSayTeamOrder(bs, teammates[numteammates - i - 1]);
-					BotSayVoiceTeamOrder(bs, teammates[0], VOICECHAT_GETFLAG);
+					BotSayVoiceTeamOrder(bs, teammates[numteammates - i - 1], VOICECHAT_GETFLAG);
 				}
 				//
 				break;
@@ -518,7 +521,7 @@
 	}
 	else {
 		//different orders based on the number of team mates
-		switch(bs->numteammates) {
+		switch(numteammates) {
 			case 1: break;
 			case 2:
 			{
@@ -583,7 +586,7 @@
 
 /*
 ==================
-BotCTFOrders
+BotCTFOrders_EnemyFlagNotAtBase
 ==================
 */
 void BotCTFOrders_EnemyFlagNotAtBase(bot_state_t *bs) {
@@ -599,8 +602,8 @@
 		case 2:
 		{
 			//tell the one not carrying the flag to defend the base
-			if (teammates[0] == bs->flagcarrier) other = teammates[1];
-			else other = teammates[0];
+			if (teammates[0] != bs->flagcarrier) other = teammates[0];
+			else other = teammates[1];
 			ClientName(other, name, sizeof(name));
 			BotAI_BotInitialChat(bs, "cmd_defendbase", name, NULL);
 			BotSayTeamOrder(bs, other);
@@ -673,8 +676,8 @@
 					//
 					ClientName(teammates[numteammates - i - 1], name, sizeof(name));
 					BotAI_BotInitialChat(bs, "cmd_getflag", name, NULL);
+					BotSayTeamOrder(bs, teammates[numteammates - i - 1]);
 					BotSayVoiceTeamOrder(bs, teammates[numteammates - i - 1], VOICECHAT_GETFLAG);
-					BotSayTeamOrder(bs, teammates[numteammates - i - 1]);
 				}
 			}
 			//
@@ -686,7 +689,7 @@
 
 /*
 ==================
-BotCTFOrders
+BotCTFOrders_BothFlagsAtBase
 ==================
 */
 void BotCTFOrders_BothFlagsAtBase(bot_state_t *bs) {
@@ -840,7 +843,7 @@
 	switch(flagstatus) {
 		case 0: BotCTFOrders_BothFlagsAtBase(bs); break;
 		case 1: BotCTFOrders_EnemyFlagNotAtBase(bs); break;
-		case 2: BotCTFOrders_FlagNotAtBase(bs); break;
+		case 2: BotCTFOrders_TeamFlagNotAtBase(bs); break;
 		case 3: BotCTFOrders_BothFlagsNotAtBase(bs); break;
 	}
 }
@@ -1106,8 +1109,8 @@
 			case 2:
 			{
 				//tell the one not carrying the flag to attack the enemy base
-				if (teammates[0] == bs->flagcarrier) other = teammates[1];
-				else other = teammates[0];
+				if (teammates[0] != bs->flagcarrier) other = teammates[0];
+				else other = teammates[1];
 				ClientName(other, name, sizeof(name));
 				BotAI_BotInitialChat(bs, "cmd_attackenemybase", name, NULL);
 				BotSayTeamOrder(bs, other);
@@ -1209,8 +1212,8 @@
 			case 2:
 			{
 				//tell the one not carrying the flag to defend the base
-				if (teammates[0] == bs->flagcarrier) other = teammates[1];
-				else other = teammates[0];
+				if (teammates[0] != bs->flagcarrier) other = teammates[0];
+				else other = teammates[1];
 				ClientName(other, name, sizeof(name));
 				BotAI_BotInitialChat(bs, "cmd_defendbase", name, NULL);
 				BotSayTeamOrder(bs, other);
@@ -1998,7 +2001,7 @@
 				bs->flagstatuschanged = qfalse;
 				bs->forceorders = qfalse;
 			}
-			//if there were no flag captures the last 3 minutes
+			//if there were no flag captures the last 4 minutes
 			if (bs->lastflagcapture_time < FloatTime() - 240) {
 				bs->lastflagcapture_time = FloatTime();
 				//randomly change the CTF strategy
Index: code/game/ai_vcmd.c
===================================================================
--- code/game/ai_vcmd.c	(revision 3378)
+++ code/game/ai_vcmd.c	(working copy)
@@ -45,9 +45,9 @@
 #include "ai_dmq3.h"
 #include "ai_chat.h"
 #include "ai_cmd.h"
+#include "ai_vcmd.h"
 #include "ai_dmnet.h"
 #include "ai_team.h"
-#include "ai_vcmd.h"
 //
 #include "chars.h"				//characteristics
 #include "inv.h"				//indexes into the inventory
@@ -348,7 +348,7 @@
 	bs->teamgoal_time = FloatTime() + TEAM_ACCOMPANY_TIME;
 	//set the ltg type
 	bs->ltgtype = LTG_TEAMACCOMPANY;
-	bs->formation_dist = 3.5 * 32;		//3.5 meter
+	bs->formation_dist = 128;
 	bs->arrive_time = 0;
 	//
 	BotSetTeamStatus(bs);
Index: code/game/bg_lib.c
===================================================================
--- code/game/bg_lib.c	(revision 3378)
+++ code/game/bg_lib.c	(working copy)
@@ -696,7 +696,7 @@
 0.30739505,0.30087304,0.29421096,0.28739907,0.28042645,0.27328078,0.26594810,0.25841250,
 0.25065566,0.24265636,0.23438976,0.22582651,0.21693146,0.20766198,0.19796546,0.18777575,
 0.17700769,0.16554844,0.15324301,0.13986823,0.12508152,0.10830610,0.08841715,0.06251018,
-}
+};
 
 double acos( double x ) {
 	int index;
Index: code/game/bg_local.h
===================================================================
--- code/game/bg_local.h	(revision 3378)
+++ code/game/bg_local.h	(working copy)
@@ -24,13 +24,8 @@
 
 #define	MIN_WALK_NORMAL	0.7f		// can't walk on very steep slopes
 
-#define	STEPSIZE		18
-
 #define	JUMP_VELOCITY	270
 
-#define	TIMER_LAND		130
-#define	TIMER_GESTURE	(34*66+50)
-
 #define	OVERCLIP		1.001f
 
 // all of the locals will be zeroed before each
Index: code/game/bg_misc.c
===================================================================
--- code/game/bg_misc.c	(revision 3378)
+++ code/game/bg_misc.c	(working copy)
@@ -54,7 +54,6 @@
 		0,
 		0,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},	// leave index 0 alone
 
@@ -68,14 +67,12 @@
 		"item_armor_shard", 
 		"sound/misc/ar1_pkup.wav",
 		{ "models/powerups/armor/shard.md3", 
-		"models/powerups/armor/shard_sphere.md3",
-		NULL, NULL} ,
+		NULL, NULL, NULL},
 /* icon */		"icons/iconr_shard",
 /* pickup */	"Armor Shard",
 		5,
 		IT_ARMOR,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -91,7 +88,6 @@
 		50,
 		IT_ARMOR,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -107,7 +103,6 @@
 		100,
 		IT_ARMOR,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -127,7 +122,6 @@
 		5,
 		IT_HEALTH,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -144,7 +138,6 @@
 		25,
 		IT_HEALTH,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -161,7 +154,6 @@
 		50,
 		IT_HEALTH,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -178,7 +170,6 @@
 		100,
 		IT_HEALTH,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -199,7 +190,6 @@
 		0,
 		IT_WEAPON,
 		WP_GAUNTLET,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -215,7 +205,6 @@
 		10,
 		IT_WEAPON,
 		WP_SHOTGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -231,7 +220,6 @@
 		40,
 		IT_WEAPON,
 		WP_MACHINEGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -247,7 +235,6 @@
 		10,
 		IT_WEAPON,
 		WP_GRENADE_LAUNCHER,
-/* precache */ "",
 /* sounds */ "sound/weapons/grenade/hgrenb1a.wav sound/weapons/grenade/hgrenb2a.wav"
 	},
 
@@ -263,7 +250,6 @@
 		10,
 		IT_WEAPON,
 		WP_ROCKET_LAUNCHER,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -279,7 +265,6 @@
 		100,
 		IT_WEAPON,
 		WP_LIGHTNING,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -295,7 +280,6 @@
 		10,
 		IT_WEAPON,
 		WP_RAILGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -311,7 +295,6 @@
 		50,
 		IT_WEAPON,
 		WP_PLASMAGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -327,7 +310,6 @@
 		20,
 		IT_WEAPON,
 		WP_BFG,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -343,7 +325,6 @@
 		0,
 		IT_WEAPON,
 		WP_GRAPPLING_HOOK,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -363,7 +344,6 @@
 		10,
 		IT_AMMO,
 		WP_SHOTGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -379,7 +359,6 @@
 		50,
 		IT_AMMO,
 		WP_MACHINEGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -395,7 +374,6 @@
 		5,
 		IT_AMMO,
 		WP_GRENADE_LAUNCHER,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -411,7 +389,6 @@
 		30,
 		IT_AMMO,
 		WP_PLASMAGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -427,7 +404,6 @@
 		60,
 		IT_AMMO,
 		WP_LIGHTNING,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -443,7 +419,6 @@
 		5,
 		IT_AMMO,
 		WP_ROCKET_LAUNCHER,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -459,7 +434,6 @@
 		10,
 		IT_AMMO,
 		WP_RAILGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -475,7 +449,6 @@
 		15,
 		IT_AMMO,
 		WP_BFG,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -494,7 +467,6 @@
 		60,
 		IT_HOLDABLE,
 		HI_TELEPORTER,
-/* precache */ "",
 /* sounds */ ""
 	},
 /*QUAKED holdable_medkit (.3 .3 1) (-16 -16 -16) (16 16 16) suspended
@@ -504,14 +476,12 @@
 		"sound/items/holdable.wav",
         { 
 		"models/powerups/holdable/medkit.md3", 
-		"models/powerups/holdable/medkit_sphere.md3",
-		NULL, NULL},
+		NULL, NULL, NULL},
 /* icon */		"icons/medkit",
 /* pickup */	"Medkit",
 		60,
 		IT_HOLDABLE,
 		HI_MEDKIT,
-/* precache */ "",
 /* sounds */ "sound/items/use_medkit.wav"
 	},
 
@@ -531,7 +501,6 @@
 		30,
 		IT_POWERUP,
 		PW_QUAD,
-/* precache */ "",
 /* sounds */ "sound/items/damage2.wav sound/items/damage3.wav"
 	},
 
@@ -548,7 +517,6 @@
 		30,
 		IT_POWERUP,
 		PW_BATTLESUIT,
-/* precache */ "",
 /* sounds */ "sound/items/airout.wav sound/items/protect3.wav"
 	},
 
@@ -565,7 +533,6 @@
 		30,
 		IT_POWERUP,
 		PW_HASTE,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -582,7 +549,6 @@
 		30,
 		IT_POWERUP,
 		PW_INVIS,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -599,7 +565,6 @@
 		30,
 		IT_POWERUP,
 		PW_REGEN,
-/* precache */ "",
 /* sounds */ "sound/items/regen.wav"
 	},
 
@@ -616,7 +581,6 @@
 		60,
 		IT_POWERUP,
 		PW_FLIGHT,
-/* precache */ "",
 /* sounds */ "sound/items/flight.wav"
 	},
 
@@ -633,7 +597,6 @@
 		0,
 		IT_TEAM,
 		PW_REDFLAG,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -650,7 +613,6 @@
 		0,
 		IT_TEAM,
 		PW_BLUEFLAG,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -667,7 +629,6 @@
 		60,
 		IT_HOLDABLE,
 		HI_KAMIKAZE,
-/* precache */ "",
 /* sounds */ "sound/items/kamikazerespawn.wav"
 	},
 
@@ -683,7 +644,6 @@
 		60,
 		IT_HOLDABLE,
 		HI_PORTAL,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -699,7 +659,6 @@
 		60,
 		IT_HOLDABLE,
 		HI_INVULNERABILITY,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -715,7 +674,6 @@
 		20,
 		IT_AMMO,
 		WP_NAILGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -731,7 +689,6 @@
 		10,
 		IT_AMMO,
 		WP_PROX_LAUNCHER,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -747,7 +704,6 @@
 		100,
 		IT_AMMO,
 		WP_CHAINGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -766,7 +722,6 @@
 		30,
 		IT_PERSISTANT_POWERUP,
 		PW_SCOUT,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -782,7 +737,6 @@
 		30,
 		IT_PERSISTANT_POWERUP,
 		PW_GUARD,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -798,7 +752,6 @@
 		30,
 		IT_PERSISTANT_POWERUP,
 		PW_DOUBLER,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -814,7 +767,6 @@
 		30,
 		IT_PERSISTANT_POWERUP,
 		PW_AMMOREGEN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -831,7 +783,6 @@
 		0,
 		IT_TEAM,
 		PW_NEUTRALFLAG,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -845,7 +796,6 @@
 		0,
 		IT_TEAM,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -859,7 +809,6 @@
 		0,
 		IT_TEAM,
 		0,
-/* precache */ "",
 /* sounds */ ""
 	},
 /*QUAKED weapon_nailgun (.3 .3 1) (-16 -16 -16) (16 16 16) suspended
@@ -874,7 +823,6 @@
 		10,
 		IT_WEAPON,
 		WP_NAILGUN,
-/* precache */ "",
 /* sounds */ ""
 	},
 
@@ -890,7 +838,6 @@
 		5,
 		IT_WEAPON,
 		WP_PROX_LAUNCHER,
-/* precache */ "",
 /* sounds */ "sound/weapons/proxmine/wstbtick.wav "
 			"sound/weapons/proxmine/wstbactv.wav "
 			"sound/weapons/proxmine/wstbimpl.wav "
@@ -911,7 +858,6 @@
 		80,
 		IT_WEAPON,
 		WP_CHAINGUN,
-/* precache */ "",
 /* sounds */ "sound/weapons/vulcan/wvulwind.wav"
 	},
 #endif
@@ -1342,7 +1288,6 @@
 	"EV_MISSILE_MISS_METAL",
 	"EV_RAILTRAIL",
 	"EV_SHOTGUN",
-	"EV_BULLET",				// otherEntity is the shooter
 
 	"EV_PAIN",
 	"EV_DEATH1",
@@ -1387,9 +1332,6 @@
 Handles the sequence numbers
 ===============
 */
-
-void	trap_Cvar_VariableStringBuffer( const char *var_name, char *buffer, int bufsize );
-
 void BG_AddPredictableEventToPlayerstate( int newEvent, int eventParm, playerState_t *ps ) {
 
 #ifdef _DEBUG
@@ -1609,7 +1551,33 @@
 }
 
 
-int cmdcmp( const void *a, const void *b )
-{
-  return Q_stricmp( (const char *)a, ((dummyCmd_t *)b)->name );
+/*
+======================
+SnapVectorTowards
+
+Round a vector to integers for more efficient network
+transmission, but make sure that it rounds towards a given point
+rather than blindly truncating.  This prevents it from truncating
+into a wall.
+======================
+*/
+void SnapVectorTowards( vec3_t v, vec3_t to ) {
+	int		i;
+
+	for ( i = 0 ; i < 3 ; i++ ) {
+		if ( to[i] <= v[i] ) {
+			v[i] = floor(v[i]);
+		} else {
+			v[i] = ceil(v[i]);
+		}
+	}
 }
+
+/*
+=============
+cmdcmp
+=============
+*/
+int cmdcmp( const void *a, const void *b ) {
+	return Q_stricmp( (const char *)a, ((dummyCmd_t *)b)->name );
+}
Index: code/game/bg_pmove.c
===================================================================
--- code/game/bg_pmove.c	(revision 3378)
+++ code/game/bg_pmove.c	(working copy)
@@ -526,8 +526,11 @@
 		PM_ClipVelocity (pm->ps->velocity, pml.groundTrace.plane.normal, 
 			pm->ps->velocity, OVERCLIP );
 
+		// don't decrease velocity when going up or down a slope
+		if ( VectorLength(pm->ps->velocity) > 1 ) {
 		VectorNormalize(pm->ps->velocity);
 		VectorScale(pm->ps->velocity, vel, pm->ps->velocity);
+		}
 	}
 
 	PM_SlideMove( qfalse );
@@ -793,8 +796,10 @@
 		pm->ps->velocity, OVERCLIP );
 
 	// don't decrease velocity when going up or down a slope
-	VectorNormalize(pm->ps->velocity);
-	VectorScale(pm->ps->velocity, vel, pm->ps->velocity);
+	if ( VectorLength(pm->ps->velocity) > 1 ) {
+		VectorNormalize(pm->ps->velocity);
+		VectorScale(pm->ps->velocity, vel, pm->ps->velocity);
+	}
 
 	// don't do anything if standing still
 	if (!pm->ps->velocity[0] && !pm->ps->velocity[1]) {
@@ -1830,8 +1835,6 @@
 
 ================
 */
-void trap_SnapVector( float *v );
-
 void PmoveSingle (pmove_t *pmove) {
 	pm = pmove;
 
Index: code/game/bg_public.h
===================================================================
--- code/game/bg_public.h	(revision 3378)
+++ code/game/bg_public.h	(working copy)
@@ -51,6 +51,14 @@
 #define CROUCH_VIEWHEIGHT	12
 #define	DEAD_VIEWHEIGHT		-16
 
+#define STEPSIZE			18
+#define	TIMER_GESTURE	2294
+#define	TIMER_LAND		130
+
+#ifdef MISSIONPACK
+#define OBELISK_TARGET_HEIGHT	56
+#endif
+
 //
 // config strings are a general means of communicating variable length strings
 // from the server to all connected clients.
@@ -413,7 +421,6 @@
 	EV_MISSILE_MISS_METAL,
 	EV_RAILTRAIL,
 	EV_SHOTGUN,
-	EV_BULLET,				// otherEntity is the shooter
 
 	EV_PAIN,
 	EV_DEATH1,
@@ -617,6 +624,7 @@
 	MOD_KAMIKAZE,
 	MOD_JUICED,
 #endif
+	MOD_SUICIDE_TEAM_CHANGE,
 	MOD_GRAPPLE
 } meansOfDeath_t;
 
@@ -653,7 +661,6 @@
 
 	int			giTag;
 
-	char		*precaches;		// string of all models and images this item will use
 	char		*sounds;		// string of all sounds this item will use
 } gitem_t;
 
@@ -722,6 +729,7 @@
 
 qboolean	BG_PlayerTouchesItem( playerState_t *ps, entityState_t *item, int atTime );
 
+void	SnapVectorTowards( vec3_t v, vec3_t to );
 
 #define ARENAS_PER_TIER		4
 #define MAX_ARENAS			1024
@@ -759,6 +767,7 @@
   const char *name;
 } dummyCmd_t;
 int cmdcmp( const void *a, const void *b );
+void	trap_SnapVector( float *v );
 // register a command name so the console can perform command completion.
 void	trap_AddCommand( const char *cmdName );
 void	trap_RemoveCommand( const char *cmdName );
@@ -765,3 +774,4 @@
 
 void	trap_Cmd_ExecuteText( int exec_when, const char *text ); // ui: don't use EXEC_NOW!
 void	trap_Cvar_SetValue( const char *var_name, float value );
+float	trap_Cvar_VariableValue( const char *var_name );
Index: code/game/g_active.c
===================================================================
--- code/game/g_active.c	(revision 3378)
+++ code/game/g_active.c	(working copy)
@@ -936,11 +936,10 @@
 				ent->client->ps.pm_type = PM_SPINTERMISSION;
 			}
 		}
-		Pmove (&pm);
-#else
-		Pmove (&pm);
 #endif
 
+	Pmove (&pm);
+
 	// save results of pmove
 	if ( ent->client->ps.eventSequence != oldEventSequence ) {
 		ent->eventTime = level.time;
@@ -1103,7 +1102,7 @@
 ClientEndFrame
 
 Called at the end of each server frame for each connected client
-A fast client will have multiple ClientThink for each ClientEdFrame,
+A fast client will have multiple ClientThink for each ClientEndFrame,
 while a slow client may have multiple ClientEndFrame between ClientThink.
 ==============
 */
Index: code/game/g_arenas.c
===================================================================
--- code/game/g_arenas.c	(revision 3378)
+++ code/game/g_arenas.c	(working copy)
@@ -84,7 +84,7 @@
 		}
 #ifdef MISSIONPACK
 		won = qfalse;
-		if (g_gametype.integer >= GT_CTF) {
+		if (g_gametype.integer >= GT_TEAM) {
 			score1 = level.teamScores[TEAM_RED];
 			score2 = level.teamScores[TEAM_BLUE];
 			if (level.clients[playerClientNum].sess.sessionTeam	== TEAM_RED) {
@@ -212,7 +212,6 @@
 }
 
 
-#define	TIMER_GESTURE	(34*66+50)
 static void CelebrateStart( gentity_t *player ) {
 	player->s.torsoAnim = ( ( player->s.torsoAnim & ANIM_TOGGLEBIT ) ^ ANIM_TOGGLEBIT ) | TORSO_GESTURE;
 	player->nextthink = level.time + TIMER_GESTURE;
Index: code/game/g_bot.c
===================================================================
--- code/game/g_bot.c	(revision 3378)
+++ code/game/g_bot.c	(working copy)
@@ -1184,28 +1184,17 @@
 			return;
 		}
 
-		strValue = Info_ValueForKey( arenainfo, "fraglimit" );
-		fragLimit = atoi( strValue );
-		if ( fragLimit ) {
-			trap_Cvar_Set( "fraglimit", strValue );
-		}
-		else {
-			trap_Cvar_SetValue( "fraglimit", 0 );
-		}
+		fragLimit = atoi( Info_ValueForKey( arenainfo, "fraglimit" ) );
+		timeLimit = atoi( Info_ValueForKey( arenainfo, "timelimit" ) );
 
-		strValue = Info_ValueForKey( arenainfo, "timelimit" );
-		timeLimit = atoi( strValue );
-		if ( timeLimit ) {
-			trap_Cvar_Set( "timelimit", strValue );
-		}
-		else {
-			trap_Cvar_SetValue( "timelimit", 0 );
-		}
-
 		if ( !fragLimit && !timeLimit ) {
 			trap_Cvar_SetValue( "fraglimit", 10 );
 			trap_Cvar_SetValue( "timelimit", 0 );
 		}
+		else {
+			trap_Cvar_SetValue( "fraglimit", fragLimit );
+			trap_Cvar_SetValue( "timelimit", timeLimit );
+		}
 
 		basedelay = BOT_BEGIN_DELAY_BASE;
 		strValue = Info_ValueForKey( arenainfo, "special" );
Index: code/game/g_client.c
===================================================================
--- code/game/g_client.c	(revision 3378)
+++ code/game/g_client.c	(working copy)
@@ -447,11 +447,11 @@
 	body->physicsBounce = 0;		// don't bounce
 	if ( body->s.groundEntityNum == ENTITYNUM_NONE ) {
 		body->s.pos.trType = TR_GRAVITY;
-		body->s.pos.trTime = level.time;
 		VectorCopy( ent->client->ps.velocity, body->s.pos.trDelta );
 	} else {
 		body->s.pos.trType = TR_STATIONARY;
 	}
+	body->s.pos.trTime = level.time;
 	body->s.event = 0;
 
 	// change the animation to the last-frame only, so the sequence
@@ -610,26 +610,6 @@
 
 /*
 ===========
-ForceClientSkin
-
-Forces a client's skin (for teamplay)
-===========
-*/
-/*
-static void ForceClientSkin( gclient_t *client, char *model, const char *skin ) {
-	char *p;
-
-	if ((p = strrchr(model, '/')) != 0) {
-		*p = 0;
-	}
-
-	Q_strcat(model, MAX_QPATH, "/");
-	Q_strcat(model, MAX_QPATH, skin);
-}
-*/
-
-/*
-===========
 ClientCleanName
 ============
 */
@@ -778,28 +758,6 @@
 		Q_strncpyz( model, Info_ValueForKey (userinfo, "model"), sizeof( model ) );
 		Q_strncpyz( headModel, Info_ValueForKey (userinfo, "headmodel"), sizeof( headModel ) );
 	}
-
-/*	NOTE: all client side now
-
-	// team
-	switch( team ) {
-	case TEAM_RED:
-		ForceClientSkin(client, model, "red");
-//		ForceClientSkin(client, headModel, "red");
-		break;
-	case TEAM_BLUE:
-		ForceClientSkin(client, model, "blue");
-//		ForceClientSkin(client, headModel, "blue");
-		break;
-	}
-	// don't ever use a default skin in teamplay, it would just waste memory
-	// however bots will always join a team but they spawn in as spectator
-	if ( g_gametype.integer >= GT_TEAM && team == TEAM_SPECTATOR) {
-		ForceClientSkin(client, model, "red");
-//		ForceClientSkin(client, headModel, "red");
-	}
-*/
-
 #ifdef MISSIONPACK
 	if (g_gametype.integer >= GT_TEAM && !(ent->r.svFlags & SVF_BOT)) {
 		client->pers.teamInfo = qtrue;
Index: code/game/g_cmds.c
===================================================================
--- code/game/g_cmds.c	(revision 3378)
+++ code/game/g_cmds.c	(working copy)
@@ -40,7 +40,7 @@
 	gclient_t	*cl;
 	int			numSorted, scoreFlags, accuracy, perfect;
 
-	// don't send scores to bots, they don't parse it
+	// don't send scores to bots (bots don't parse them)
 	if ( ent->r.svFlags & SVF_BOT ) {
 		return;
 	}
@@ -492,18 +492,24 @@
 */
 void BroadcastTeamChange( gclient_t *client, int oldTeam )
 {
-	if ( client->sess.sessionTeam == TEAM_RED ) {
-		trap_SendServerCommand( -1, va("cp \"%s" S_COLOR_WHITE " joined the red team.\n\"",
+	if ( client->sess.sessionTeam == oldTeam )
+		return;
+
+	if ( client->sess.sessionTeam == TEAM_SPECTATOR ) {
+		trap_SendServerCommand( -1, va("print \"%s" S_COLOR_WHITE " joined the spectators.\n\"",
+		client->pers.netname));
+	} else if ( client->sess.sessionTeam == TEAM_FREE ) {
+		trap_SendServerCommand( -1, va("print \"%s" S_COLOR_WHITE " joined the battle.\n\"",
+		client->pers.netname));
+	} else if ( client->sess.sessionTeam == TEAM_RED ) {
+		trap_SendServerCommand( -1, va("print \"%s" S_COLOR_WHITE " joined the red team.\n\"",
 			client->pers.netname) );
 	} else if ( client->sess.sessionTeam == TEAM_BLUE ) {
-		trap_SendServerCommand( -1, va("cp \"%s" S_COLOR_WHITE " joined the blue team.\n\"",
+		trap_SendServerCommand( -1, va("print \"%s" S_COLOR_WHITE " joined the blue team.\n\"",
 		client->pers.netname));
-	} else if ( client->sess.sessionTeam == TEAM_SPECTATOR && oldTeam != TEAM_SPECTATOR ) {
-		trap_SendServerCommand( -1, va("cp \"%s" S_COLOR_WHITE " joined the spectators.\n\"",
-		client->pers.netname));
-	} else if ( client->sess.sessionTeam == TEAM_FREE ) {
-		trap_SendServerCommand( -1, va("cp \"%s" S_COLOR_WHITE " joined the battle.\n\"",
-		client->pers.netname));
+	} else {
+		trap_SendServerCommand( -1, va("print \"%s" S_COLOR_WHITE " joined the %s team.\n\"",
+		client->pers.netname, TeamName(client->sess.sessionTeam)));
 	}
 }
 
@@ -612,7 +618,7 @@
 		// Kill him (makes sure he loses flags, etc)
 		ent->flags &= ~FL_GODMODE;
 		ent->client->ps.stats[STAT_HEALTH] = ent->health = 0;
-		player_die (ent, ent, ent, 100000, MOD_SUICIDE);
+		player_die (ent, ent, ent, 100000, MOD_SUICIDE_TEAM_CHANGE);
 
 	}
 
@@ -683,22 +689,10 @@
 	int			oldTeam;
 	char		s[MAX_TOKEN_CHARS];
 
+	oldTeam = ent->client->sess.sessionTeam;
+
 	if ( trap_Argc() != 2 ) {
-		oldTeam = ent->client->sess.sessionTeam;
-		switch ( oldTeam ) {
-		case TEAM_BLUE:
-			trap_SendServerCommand( ent-g_entities, "print \"Blue team\n\"" );
-			break;
-		case TEAM_RED:
-			trap_SendServerCommand( ent-g_entities, "print \"Red team\n\"" );
-			break;
-		case TEAM_FREE:
-			trap_SendServerCommand( ent-g_entities, "print \"Free team\n\"" );
-			break;
-		case TEAM_SPECTATOR:
-			trap_SendServerCommand( ent-g_entities, "print \"Spectator team\n\"" );
-			break;
-		}
+		trap_SendServerCommand( ent-g_entities, va( "print \"You are on the %s team.\n\"", TeamName( oldTeam ) ) );
 		return;
 	}
 
@@ -717,7 +711,9 @@
 
 	SetTeam( ent, s );
 
-	ent->client->switchTeamTime = level.time + 5000;
+	if ( oldTeam != ent->client->sess.sessionTeam ) {
+		ent->client->switchTeamTime = level.time + 5000;
+	}
 }
 
 
@@ -1338,7 +1334,7 @@
 	} else if ( !Q_stricmp( arg1, "fraglimit" ) ) {
 	} else {
 		trap_SendServerCommand( ent-g_entities, "print \"Invalid vote string.\n\"" );
-		trap_SendServerCommand( ent-g_entities, "print \"Vote commands are: map_restart, nextmap, map <mapname>, g_gametype <n>, kick <player>, clientkick <clientnum>, g_doWarmup, timelimit <time>, fraglimit <frags>.\n\"" );
+		trap_SendServerCommand( ent-g_entities, "print \"Vote commands are: map_restart, nextmap, map <mapname>, g_gametype <n>, kick <player>, clientkick <clientnum>, g_doWarmup, timelimit <time>, fraglimit <frags>, capturelimit <captures>.\n\"" );
 		return;
 	}
 
Index: code/game/g_combat.c
===================================================================
--- code/game/g_combat.c	(revision 3378)
+++ code/game/g_combat.c	(working copy)
@@ -132,6 +132,8 @@
 /*
 =================
 TossClientCubes
+
+Spawn cube at neutral obelisk.
 =================
 */
 extern gentity_t	*neutralObelisk;
@@ -310,6 +312,7 @@
 	"MOD_KAMIKAZE",
 	"MOD_JUICED",
 #endif
+	"MOD_SUICIDE_TEAM_CHANGE",
 	"MOD_GRAPPLE"
 };
 
@@ -492,12 +495,15 @@
 		killer, self->s.number, meansOfDeath, killerName, 
 		self->client->pers.netname, obit );
 
-	// broadcast the death event to everyone
-	ent = G_TempEntity( self->r.currentOrigin, EV_OBITUARY );
-	ent->s.eventParm = meansOfDeath;
-	ent->s.otherEntityNum = self->s.number;
-	ent->s.otherEntityNum2 = killer;
-	ent->r.svFlags = SVF_BROADCAST;	// send to everyone
+	// don't send death obituary when swiching teams
+	if (meansOfDeath != MOD_SUICIDE_TEAM_CHANGE) {
+		// broadcast the death event to everyone
+		ent = G_TempEntity( self->r.currentOrigin, EV_OBITUARY );
+		ent->s.eventParm = meansOfDeath;
+		ent->s.otherEntityNum = self->s.number;
+		ent->s.otherEntityNum2 = killer;
+		ent->r.svFlags = SVF_BROADCAST;	// send to everyone
+	}
 
 	self->enemy = attacker;
 
@@ -547,7 +553,7 @@
 	Team_FragBonuses(self, inflictor, attacker);
 
 	// if I committed suicide, the flag does not fall, it returns.
-	if (meansOfDeath == MOD_SUICIDE) {
+	if (meansOfDeath == MOD_SUICIDE || meansOfDeath == MOD_SUICIDE_TEAM_CHANGE) {
 		if ( self->client->ps.powerups[PW_NEUTRALFLAG] ) {		// only happens in One Flag CTF
 			Team_ReturnFlag( TEAM_FREE );
 			self->client->ps.powerups[PW_NEUTRALFLAG] = 0;
@@ -992,11 +998,7 @@
 	// the total will be turned into screen blends and view angle kicks
 	// at the end of the frame
 	if ( client ) {
-		if ( attacker ) {
-			client->ps.persistant[PERS_ATTACKER] = attacker->s.number;
-		} else {
-			client->ps.persistant[PERS_ATTACKER] = ENTITYNUM_WORLD;
-		}
+		client->ps.persistant[PERS_ATTACKER] = attacker->s.number;
 		client->damage_armor += asave;
 		client->damage_blood += take;
 		client->damage_knockback += knockback;
Index: code/game/g_local.h
===================================================================
--- code/game/g_local.h	(revision 3378)
+++ code/game/g_local.h	(working copy)
@@ -31,10 +31,8 @@
 // the "gameversion" client command will print this plus compile date
 #define	GAMEVERSION	BASEGAME
 
-#define BODY_QUEUE_SIZE		8
+#define BODY_QUEUE_SIZE		64
 
-#define INFINITE			1000000
-
 #define	FRAMETIME			100					// msec
 #define	CARNAGE_REWARD_TIME	3000
 #define REWARD_SPRITE_TIME	2000
@@ -139,7 +137,6 @@
 
 	int			pain_debounce_time;
 	int			fly_sound_debounce_time;	// wind tunnel
-	int			last_move_time;
 
 	int			health;
 
@@ -200,16 +197,8 @@
 
 	int			location;
 
-	int			captures;
-	int			basedefense;
-	int			carrierdefense;
-	int			flagrecovery;
-	int			fragcarrier;
-	int			assists;
-
 	float		lasthurtcarrier;
 	float		lastreturnedflag;
-	float		flagsince;
 	float		lastfraggedcarrier;
 } playerTeamState_t;
 
@@ -438,14 +427,10 @@
 void RespawnItem( gentity_t *ent );
 
 void UseHoldableItem( gentity_t *ent );
-void PrecacheItem (gitem_t *it);
 gentity_t *Drop_Item( gentity_t *ent, gitem_t *item, float angle );
 gentity_t *LaunchItem( gitem_t *item, vec3_t origin, vec3_t velocity );
-void SetRespawn (gentity_t *ent, float delay);
 void G_SpawnItem (gentity_t *ent, gitem_t *item);
 void FinishSpawningItem( gentity_t *ent );
-void Think_Weapon (gentity_t *ent);
-int ArmorIndex (gentity_t *ent);
 void	Add_Ammo (gentity_t *ent, int weapon, int count);
 void Touch_Item (gentity_t *ent, gentity_t *other, trace_t *trace);
 
@@ -551,7 +536,6 @@
 //
 qboolean LogAccuracyHit( gentity_t *target, gentity_t *attacker );
 void CalcMuzzlePoint ( gentity_t *ent, vec3_t forward, vec3_t right, vec3_t up, vec3_t muzzlePoint );
-void SnapVectorTowards( vec3_t v, vec3_t to );
 qboolean CheckGauntletAttack( gentity_t *ent );
 void Weapon_HookFree (gentity_t *ent);
 void Weapon_HookThink (gentity_t *ent);
@@ -595,8 +579,8 @@
 //
 // g_cmds.c
 //
+void DeathmatchScoreboardMessage( gentity_t *ent );
 char      *ConcatArgs( int start );
-void DeathmatchScoreboardMessage( gentity_t *ent );
 
 //
 // g_main.c
@@ -671,7 +655,9 @@
 void Svcmd_BotList_f( void );
 void BotInterbreedEndMatch( void );
 
+//
 // ai_main.c
+//
 #define MAX_FILEPATH			144
 
 //bot settings
Index: code/game/g_main.c
===================================================================
--- code/game/g_main.c	(revision 3378)
+++ code/game/g_main.c	(working copy)
@@ -81,6 +81,7 @@
 vmCvar_t	pmove_msec;
 vmCvar_t	g_rankings;
 vmCvar_t	g_listEntity;
+vmCvar_t	g_singlePlayer;
 vmCvar_t	g_localTeamPref;
 #ifdef MISSIONPACK
 vmCvar_t	g_obeliskHealth;
@@ -90,7 +91,6 @@
 vmCvar_t	g_cubeTimeout;
 vmCvar_t	g_redteam;
 vmCvar_t	g_blueteam;
-vmCvar_t	g_singlePlayer;
 vmCvar_t	g_enableDust;
 vmCvar_t	g_enableBreath;
 vmCvar_t	g_proxMineTimeout;
@@ -162,7 +162,7 @@
 	{ &g_obeliskHealth, "g_obeliskHealth", "2500", 0, 0, qfalse },
 	{ &g_obeliskRegenPeriod, "g_obeliskRegenPeriod", "1", 0, 0, qfalse },
 	{ &g_obeliskRegenAmount, "g_obeliskRegenAmount", "15", 0, 0, qfalse },
-	{ &g_obeliskRespawnDelay, "g_obeliskRespawnDelay", "10", CVAR_SERVERINFO, 0, qfalse },
+	{ &g_obeliskRespawnDelay, "g_obeliskRespawnDelay", "10", CVAR_SYSTEMINFO, 0, qfalse },
 
 	{ &g_cubeTimeout, "g_cubeTimeout", "30", 0, 0, qfalse },
 	{ &g_redteam, "g_redteam", DEFAULT_REDTEAM_NAME, CVAR_ARCHIVE | CVAR_SYSTEMINFO , 0, qtrue, qtrue },
Index: code/game/g_public.h
===================================================================
--- code/game/g_public.h	(revision 3378)
+++ code/game/g_public.h	(working copy)
@@ -55,9 +55,6 @@
 
 
 typedef struct {
-	entityState_t	unused;			// apparently this field was put here accidentally
-									//  (and is kept only for compatibility, as a struct pad)
-
 	qboolean	linked;				// qfalse if not in any good cluster
 	int			linkcount;
 
Index: code/game/g_team.c
===================================================================
--- code/game/g_team.c	(revision 3378)
+++ code/game/g_team.c	(working copy)
@@ -307,7 +307,6 @@
 	if (targ->client->ps.powerups[enemy_flag_pw]) {
 		attacker->client->pers.teamState.lastfraggedcarrier = level.time;
 		AddScore(attacker, targ->r.currentOrigin, CTF_FRAG_CARRIER_BONUS);
-		attacker->client->pers.teamState.fragcarrier++;
 		PrintMsg(NULL, "%s" S_COLOR_WHITE " fragged %s's flag carrier!\n",
 			attacker->client->pers.netname, TeamName(team));
 
@@ -326,7 +325,6 @@
 
 		attacker->client->pers.teamState.lastfraggedcarrier = level.time;
 		AddScore(attacker, targ->r.currentOrigin, CTF_FRAG_CARRIER_BONUS * tokens * tokens);
-		attacker->client->pers.teamState.fragcarrier++;
 		PrintMsg(NULL, "%s" S_COLOR_WHITE " fragged %s's skull carrier!\n",
 			attacker->client->pers.netname, TeamName(team));
 
@@ -347,7 +345,6 @@
 		// fragged a guy who hurt our flag carrier
 		AddScore(attacker, targ->r.currentOrigin, CTF_CARRIER_DANGER_PROTECT_BONUS);
 
-		attacker->client->pers.teamState.carrierdefense++;
 		targ->client->pers.teamState.lasthurtcarrier = 0;
 
 		attacker->client->ps.persistant[PERS_DEFEND_COUNT]++;
@@ -426,7 +423,6 @@
 
 		// we defended the base flag
 		AddScore(attacker, targ->r.currentOrigin, CTF_FLAG_DEFENSE_BONUS);
-		attacker->client->pers.teamState.basedefense++;
 
 		attacker->client->ps.persistant[PERS_DEFEND_COUNT]++;
 		// add the sprite over the player's head
@@ -447,7 +443,6 @@
 				trap_InPVS(carrier->r.currentOrigin, attacker->r.currentOrigin ) ) ) &&
 			attacker->client->sess.sessionTeam != targ->client->sess.sessionTeam) {
 			AddScore(attacker, targ->r.currentOrigin, CTF_CARRIER_PROTECT_BONUS);
-			attacker->client->pers.teamState.carrierdefense++;
 
 			attacker->client->ps.persistant[PERS_DEFEND_COUNT]++;
 			// add the sprite over the player's head
@@ -694,7 +689,7 @@
 		PrintMsg( NULL, "%s" S_COLOR_WHITE " returned the %s flag!\n", 
 			cl->pers.netname, TeamName(team));
 		AddScore(other, ent->r.currentOrigin, CTF_RECOVERY_BONUS);
-		other->client->pers.teamState.flagrecovery++;
+
 		other->client->pers.teamState.lastreturnedflag = level.time;
 		//ResetFlag will remove this entity!  We must return zero
 		Team_ReturnFlagSound(Team_ResetFlag(team), team);
@@ -728,7 +723,6 @@
 	AddTeamScore(ent->s.pos.trBase, other->client->sess.sessionTeam, 1);
 	Team_ForceGesture(other->client->sess.sessionTeam);
 
-	other->client->pers.teamState.captures++;
 	// add the sprite over the player's head
 	other->client->ps.eFlags &= ~(EF_AWARD_IMPRESSIVE | EF_AWARD_EXCELLENT | EF_AWARD_GAUNTLET | EF_AWARD_ASSIST | EF_AWARD_DEFEND | EF_AWARD_CAP );
 	other->client->ps.eFlags |= EF_AWARD_CAP;
@@ -760,7 +754,6 @@
 			if (player->client->pers.teamState.lastreturnedflag + 
 				CTF_RETURN_FLAG_ASSIST_TIMEOUT > level.time) {
 				AddScore (player, ent->r.currentOrigin, CTF_RETURN_FLAG_ASSIST_BONUS);
-				other->client->pers.teamState.assists++;
 
 				player->client->ps.persistant[PERS_ASSIST_COUNT]++;
 				// add the sprite over the player's head
@@ -772,7 +765,7 @@
 			if (player->client->pers.teamState.lastfraggedcarrier + 
 				CTF_FRAG_CARRIER_ASSIST_TIMEOUT > level.time) {
 				AddScore(player, ent->r.currentOrigin, CTF_FRAG_CARRIER_ASSIST_BONUS);
-				other->client->pers.teamState.assists++;
+
 				player->client->ps.persistant[PERS_ASSIST_COUNT]++;
 				// add the sprite over the player's head
 				player->client->ps.eFlags &= ~(EF_AWARD_IMPRESSIVE | EF_AWARD_EXCELLENT | EF_AWARD_GAUNTLET | EF_AWARD_ASSIST | EF_AWARD_DEFEND | EF_AWARD_CAP );
@@ -820,7 +813,6 @@
 
 	AddScore(other, ent->r.currentOrigin, CTF_FLAG_BONUS);
 #endif
-	cl->pers.teamState.flagsince = level.time;
 	Team_TakeFlagSound( ent, team );
 
 	return -1; // Do not respawn this automatically, but do delete it if it was FL_DROPPED
@@ -893,6 +885,10 @@
 	float			bestlen, len;
 	vec3_t			origin;
 
+	if ( !ent ) {
+		return NULL;
+	}
+
 	best = NULL;
 	bestlen = 3*8192.0*8192.0;
 
Index: code/game/g_utils.c
===================================================================
--- code/game/g_utils.c	(revision 3378)
+++ code/game/g_utils.c	(working copy)
@@ -589,7 +589,6 @@
 		bits = ( bits + EV_EVENT_BIT1 ) & EV_EVENT_BITS;
 		ent->client->ps.externalEvent = event | bits;
 		ent->client->ps.externalEventParm = eventParm;
-		ent->client->ps.externalEventTime = level.time;
 	} else {
 		bits = ent->s.event & EV_EVENT_BITS;
 		bits = ( bits + EV_EVENT_BIT1 ) & EV_EVENT_BITS;
Index: code/game/g_weapon.c
===================================================================
--- code/game/g_weapon.c	(revision 3378)
+++ code/game/g_weapon.c	(working copy)
@@ -131,28 +131,6 @@
 ======================================================================
 */
 
-/*
-======================
-SnapVectorTowards
-
-Round a vector to integers for more efficient network
-transmission, but make sure that it rounds towards a given point
-rather than blindly truncating.  This prevents it from truncating 
-into a wall.
-======================
-*/
-void SnapVectorTowards( vec3_t v, vec3_t to ) {
-	int		i;
-
-	for ( i = 0 ; i < 3 ; i++ ) {
-		if ( to[i] <= v[i] ) {
-			v[i] = floor(v[i]);
-		} else {
-			v[i] = ceil(v[i]);
-		}
-	}
-}
-
 #ifdef MISSIONPACK
 #define CHAINGUN_SPREAD		600
 #define CHAINGUN_DAMAGE		7
Index: code/null/null_client.c
===================================================================
--- code/null/null_client.c	(revision 3378)
+++ code/null/null_client.c	(working copy)
@@ -77,9 +77,6 @@
 void CL_InitKeyCommands( void ) {
 }
 
-void CL_CDDialog( void ) {
-}
-
 void CL_FlushMemory(void)
 {
 }
@@ -99,4 +96,3 @@
 {
 }
 
-qboolean CL_CDKeyValidate( const char *key, const char *checksum ) { return qtrue; }
Index: code/q3_ui
===================================================================
--- code/q3_ui	(revision 3378)
+++ code/q3_ui	(working copy)

Property changes on: code/q3_ui
___________________________________________________________________
Added: svn:ignore
## -0,0 +1 ##
+ui_cdkey.c
Index: code/q3_ui/ui_addbots.c
===================================================================
--- code/q3_ui/ui_addbots.c	(revision 3378)
+++ code/q3_ui/ui_addbots.c	(working copy)
@@ -207,6 +207,14 @@
 	name1 = Info_ValueForKey( info1, "name" );
 	name2 = Info_ValueForKey( info2, "name" );
 
+	// put random option first
+	if (Q_stricmp(name1, "Random") == 0) {
+		return -1;
+	}
+	if (Q_stricmp(name2, "Random") == 0) {
+		return 1;
+	}
+
 	return Q_stricmp( name1, name2 );
 }
 
Index: code/q3_ui/ui_atoms.c
===================================================================
--- code/q3_ui/ui_atoms.c	(revision 3378)
+++ code/q3_ui/ui_atoms.c	(working copy)
@@ -793,18 +793,6 @@
 	return qfalse;
 }
 
-static void NeedCDAction( qboolean result ) {
-	if ( !result ) {
-		trap_Cmd_ExecuteText( EXEC_APPEND, "quit\n" );
-	}
-}
-
-static void NeedCDKeyAction( qboolean result ) {
-	if ( !result ) {
-		trap_Cmd_ExecuteText( EXEC_APPEND, "quit\n" );
-	}
-}
-
 void UI_SetActiveMenu( uiMenuCommand_t menu ) {
 	// this should be the ONLY way the menu system is brought up
 	// ensure minimum menu data is cached
@@ -817,12 +805,6 @@
 	case UIMENU_MAIN:
 		UI_MainMenu();
 		return;
-	case UIMENU_NEED_CD:
-		UI_ConfirmMenu( "Insert the CD", 0, NeedCDAction );
-		return;
-	case UIMENU_BAD_CD_KEY:
-		UI_ConfirmMenu( "Bad CD Key", 0, NeedCDKeyAction );
-		return;
 	case UIMENU_INGAME:
 		/*
 		//GRank
@@ -989,7 +971,6 @@
 //	UI_LoadConfig_Cache();
 //	UI_SaveConfigMenu_Cache();
 	UI_BotSelectMenu_Cache();
-	UI_CDKeyMenu_Cache();
 	UI_ModsMenu_Cache();
 
 }
@@ -1046,11 +1027,6 @@
 		return qtrue;
 	}
 
-	if ( Q_stricmp (cmd, "ui_cdkey") == 0 ) {
-		UI_CDKeyMenu_f();
-		return qtrue;
-	}
-
 	return qfalse;
 }
 
Index: code/q3_ui/ui_cdkey.c
===================================================================
--- code/q3_ui/ui_cdkey.c	(revision 3378)
+++ code/q3_ui/ui_cdkey.c	(nonexistent)
@@ -1,291 +0,0 @@
-/*
-===========================================================================
-Copyright (C) 1999-2005 Id Software, Inc.
-
-This file is part of Quake III Arena source code.
-
-Quake III Arena source code is free software; you can redistribute it
-and/or modify it under the terms of the GNU General Public License as
-published by the Free Software Foundation; either version 2 of the License,
-or (at your option) any later version.
-
-Quake III Arena source code is distributed in the hope that it will be
-useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with Quake III Arena source code; if not, write to the Free Software
-Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-===========================================================================
-*/
-//
-/*
-=======================================================================
-
-CD KEY MENU
-
-=======================================================================
-*/
-
-
-#include "ui_local.h"
-
-
-#define ART_FRAME		"menu/art/cut_frame"
-#define ART_ACCEPT0		"menu/art/accept_0"
-#define ART_ACCEPT1		"menu/art/accept_1"	
-#define ART_BACK0		"menu/art/back_0"
-#define ART_BACK1		"menu/art/back_1"	
-
-#define ID_CDKEY		10
-#define ID_ACCEPT		11
-#define ID_BACK			12
-
-
-typedef struct {
-	menuframework_s	menu;
-
-	menutext_s		banner;
-	menubitmap_s	frame;
-
-	menufield_s		cdkey;
-
-	menubitmap_s	accept;
-	menubitmap_s	back;
-} cdkeyMenuInfo_t;
-
-static cdkeyMenuInfo_t	cdkeyMenuInfo;
-
-
-/*
-===============
-UI_CDKeyMenu_Event
-===============
-*/
-static void UI_CDKeyMenu_Event( void *ptr, int event ) {
-	if( event != QM_ACTIVATED ) {
-		return;
-	}
-
-	switch( ((menucommon_s*)ptr)->id ) {
-	case ID_ACCEPT:
-		if( cdkeyMenuInfo.cdkey.field.buffer[0] ) {
-			trap_SetCDKey( cdkeyMenuInfo.cdkey.field.buffer );
-		}
-		UI_PopMenu();
-		break;
-
-	case ID_BACK:
-		UI_PopMenu();
-		break;
-	}
-}
-
-
-/*
-=================
-UI_CDKeyMenu_PreValidateKey
-=================
-*/
-static int UI_CDKeyMenu_PreValidateKey( const char *key ) {
-	char	ch;
-
-	if( strlen( key ) != 16 ) {
-		return 1;
-	}
-
-	while( ( ch = *key++ ) ) {
-		switch( ch ) {
-		case '2':
-		case '3':
-		case '7':
-		case 'a':
-		case 'b':
-		case 'c':
-		case 'd':
-		case 'g':
-		case 'h':
-		case 'j':
-		case 'l':
-		case 'p':
-		case 'r':
-		case 's':
-		case 't':
-		case 'w':
-			continue;
-		default:
-			return -1;
-		}
-	}
-
-	return 0;
-}
-
-
-/*
-=================
-UI_CDKeyMenu_DrawKey
-=================
-*/
-static void UI_CDKeyMenu_DrawKey( void *self ) {
-	menufield_s		*f;
-	qboolean		focus;
-	int				style;
-	char			c;
-	float			*color;
-	int				x, y;
-	int				val;
-
-	f = (menufield_s *)self;
-
-	focus = (f->generic.parent->cursor == f->generic.menuPosition);
-
-	style = UI_LEFT;
-	if( focus ) {
-		color = color_yellow;
-	}
-	else {
-		color = color_orange;
-	}
-
-	x = 320 - 8 * BIGCHAR_WIDTH;
-	y = 240 - BIGCHAR_HEIGHT / 2;
-	UI_FillRect( x, y, 16 * BIGCHAR_WIDTH, BIGCHAR_HEIGHT, listbar_color );
-	UI_DrawString( x, y, f->field.buffer, style, color );
-
-	// draw cursor if we have focus
-	if( focus ) {
-		if ( trap_Key_GetOverstrikeMode() ) {
-			c = 11;
-		} else {
-			c = 10;
-		}
-
-		style &= ~UI_PULSE;
-		style |= UI_BLINK;
-
-		UI_DrawChar( x + f->field.cursor * BIGCHAR_WIDTH, y, c, style, color_white );
-	}
-
-	val = UI_CDKeyMenu_PreValidateKey( f->field.buffer );
-	if( val == 1 ) {
-		UI_DrawProportionalString( 320, 376, "Please enter your CD Key", UI_CENTER|UI_SMALLFONT, color_yellow );
-	}
-	else if ( val == 0 ) {
-		UI_DrawProportionalString( 320, 376, "The CD Key appears to be valid, thank you", UI_CENTER|UI_SMALLFONT, color_white );
-	}
-	else {
-		UI_DrawProportionalString( 320, 376, "The CD Key is not valid", UI_CENTER|UI_SMALLFONT, color_red );
-	}
-}
-
-
-/*
-===============
-UI_CDKeyMenu_Init
-===============
-*/
-static void UI_CDKeyMenu_Init( void ) {
-	trap_Cvar_Set( "ui_cdkeychecked", "1" );
-
-	UI_CDKeyMenu_Cache();
-
-	memset( &cdkeyMenuInfo, 0, sizeof(cdkeyMenuInfo) );
-	cdkeyMenuInfo.menu.wrapAround = qtrue;
-	cdkeyMenuInfo.menu.fullscreen = qtrue;
-
-	cdkeyMenuInfo.banner.generic.type				= MTYPE_BTEXT;
-	cdkeyMenuInfo.banner.generic.x					= 320;
-	cdkeyMenuInfo.banner.generic.y					= 16;
-	cdkeyMenuInfo.banner.string						= "CD KEY";
-	cdkeyMenuInfo.banner.color						= color_white;
-	cdkeyMenuInfo.banner.style						= UI_CENTER;
-
-	cdkeyMenuInfo.frame.generic.type				= MTYPE_BITMAP;
-	cdkeyMenuInfo.frame.generic.name				= ART_FRAME;
-	cdkeyMenuInfo.frame.generic.flags				= QMF_INACTIVE;
-	cdkeyMenuInfo.frame.generic.x					= 142;
-	cdkeyMenuInfo.frame.generic.y					= 118;
-	cdkeyMenuInfo.frame.width  						= 359;
-	cdkeyMenuInfo.frame.height  					= 256;
-
-	cdkeyMenuInfo.cdkey.generic.type				= MTYPE_FIELD;
-	cdkeyMenuInfo.cdkey.generic.name				= "CD Key:";
-	cdkeyMenuInfo.cdkey.generic.flags				= QMF_LOWERCASE;
-	cdkeyMenuInfo.cdkey.generic.x					= 320 - BIGCHAR_WIDTH * 2.5;
-	cdkeyMenuInfo.cdkey.generic.y					= 240 - BIGCHAR_HEIGHT / 2;
-	cdkeyMenuInfo.cdkey.field.widthInChars			= 16;
-	cdkeyMenuInfo.cdkey.field.maxchars				= 16;
-	cdkeyMenuInfo.cdkey.generic.ownerdraw			= UI_CDKeyMenu_DrawKey;
-
-	cdkeyMenuInfo.accept.generic.type				= MTYPE_BITMAP;
-	cdkeyMenuInfo.accept.generic.name				= ART_ACCEPT0;
-	cdkeyMenuInfo.accept.generic.flags				= QMF_RIGHT_JUSTIFY|QMF_PULSEIFFOCUS;
-	cdkeyMenuInfo.accept.generic.id					= ID_ACCEPT;
-	cdkeyMenuInfo.accept.generic.callback			= UI_CDKeyMenu_Event;
-	cdkeyMenuInfo.accept.generic.x					= 640;
-	cdkeyMenuInfo.accept.generic.y					= 480-64;
-	cdkeyMenuInfo.accept.width						= 128;
-	cdkeyMenuInfo.accept.height						= 64;
-	cdkeyMenuInfo.accept.focuspic					= ART_ACCEPT1;
-
-	cdkeyMenuInfo.back.generic.type					= MTYPE_BITMAP;
-	cdkeyMenuInfo.back.generic.name					= ART_BACK0;
-	cdkeyMenuInfo.back.generic.flags				= QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS;
-	cdkeyMenuInfo.back.generic.id					= ID_BACK;
-	cdkeyMenuInfo.back.generic.callback				= UI_CDKeyMenu_Event;
-	cdkeyMenuInfo.back.generic.x					= 0;
-	cdkeyMenuInfo.back.generic.y					= 480-64;
-	cdkeyMenuInfo.back.width						= 128;
-	cdkeyMenuInfo.back.height						= 64;
-	cdkeyMenuInfo.back.focuspic						= ART_BACK1;
-
-	Menu_AddItem( &cdkeyMenuInfo.menu, &cdkeyMenuInfo.banner );
-	Menu_AddItem( &cdkeyMenuInfo.menu, &cdkeyMenuInfo.frame );
-	Menu_AddItem( &cdkeyMenuInfo.menu, &cdkeyMenuInfo.cdkey );
-	Menu_AddItem( &cdkeyMenuInfo.menu, &cdkeyMenuInfo.accept );
-	if( uis.menusp ) {
-		Menu_AddItem( &cdkeyMenuInfo.menu, &cdkeyMenuInfo.back );
-	}
-
-	trap_GetCDKey( cdkeyMenuInfo.cdkey.field.buffer, cdkeyMenuInfo.cdkey.field.maxchars + 1 );
-	if( trap_VerifyCDKey( cdkeyMenuInfo.cdkey.field.buffer, NULL ) == qfalse ) {
-		cdkeyMenuInfo.cdkey.field.buffer[0] = 0;
-	}
-}
-
-
-/*
-=================
-UI_CDKeyMenu_Cache
-=================
-*/
-void UI_CDKeyMenu_Cache( void ) {
-	trap_R_RegisterShaderNoMip( ART_ACCEPT0 );
-	trap_R_RegisterShaderNoMip( ART_ACCEPT1 );
-	trap_R_RegisterShaderNoMip( ART_BACK0 );
-	trap_R_RegisterShaderNoMip( ART_BACK1 );
-	trap_R_RegisterShaderNoMip( ART_FRAME );
-}
-
-
-/*
-===============
-UI_CDKeyMenu
-===============
-*/
-void UI_CDKeyMenu( void ) {
-	UI_CDKeyMenu_Init();
-	UI_PushMenu( &cdkeyMenuInfo.menu );
-}
-
-
-/*
-===============
-UI_CDKeyMenu_f
-===============
-*/
-void UI_CDKeyMenu_f( void ) {
-	UI_CDKeyMenu();
-}
Index: code/q3_ui/ui_controls2.c
===================================================================
--- code/q3_ui/ui_controls2.c	(revision 3378)
+++ code/q3_ui/ui_controls2.c	(working copy)
@@ -175,7 +175,7 @@
 	menuaction_s		sidestep;
 	menuaction_s		run;
 	menuaction_s		machinegun;
-	menuaction_s		chainsaw;
+	menuaction_s		gauntlet;
 	menuaction_s		shotgun;
 	menuaction_s		grenadelauncher;
 	menuaction_s		rocketlauncher;
@@ -183,6 +183,11 @@
 	menuaction_s		railgun;
 	menuaction_s		plasma;
 	menuaction_s		bfg;
+#ifdef MISSIONPACK
+	menuaction_s		nailgun;
+	menuaction_s		proxylauncher;
+	menuaction_s		chaingun;
+#endif
 	menuaction_s		attack;
 	menuaction_s		prevweapon;
 	menuaction_s		nextweapon;
@@ -255,6 +260,11 @@
 	{"weapon 7",		"railgun",			ID_WEAPON7,		ANIM_WEAPON7,	'7',			-1,		-1, -1},
 	{"weapon 8",		"plasma gun",		ID_WEAPON8,		ANIM_WEAPON8,	'8',			-1,		-1, -1},
 	{"weapon 9",		"BFG",				ID_WEAPON9,		ANIM_WEAPON9,	'9',			-1,		-1, -1},
+#ifdef MISSIONPACK
+	{"weapon 11",		"nail gun",			ID_WEAPON11,	ANIM_WEAPON11,	-1,				-1,		-1, -1},
+	{"weapon 12",		"proximity mine",	ID_WEAPON12,	ANIM_WEAPON12,	-1,				-1,		-1, -1},
+	{"weapon 13",		"chain gun",		ID_WEAPON13,	ANIM_WEAPON13,	-1,				-1,		-1, -1},
+#endif
 	{"+attack", 		"attack",			ID_ATTACK,		ANIM_ATTACK,	K_CTRL,			-1,		-1, -1},
 	{"weapprev",		"prev weapon",		ID_WEAPPREV,	ANIM_IDLE,		'[',			-1,		-1, -1},
 	{"weapnext", 		"next weapon",		ID_WEAPNEXT,	ANIM_IDLE,		']',			-1,		-1, -1},
@@ -301,7 +311,7 @@
 	(menucommon_s *)&s_controls.nextweapon,
 	(menucommon_s *)&s_controls.prevweapon,
 	(menucommon_s *)&s_controls.autoswitch,    
-	(menucommon_s *)&s_controls.chainsaw,         
+	(menucommon_s *)&s_controls.gauntlet,      
 	(menucommon_s *)&s_controls.machinegun,
 	(menucommon_s *)&s_controls.shotgun,          
 	(menucommon_s *)&s_controls.grenadelauncher,
@@ -310,6 +320,11 @@
 	(menucommon_s *)&s_controls.railgun,          
 	(menucommon_s *)&s_controls.plasma,           
 	(menucommon_s *)&s_controls.bfg,              
+#ifdef MISSIONPACK
+	(menucommon_s *)&s_controls.nailgun,
+	(menucommon_s *)&s_controls.proxylauncher,
+	(menucommon_s *)&s_controls.chaingun,
+#endif
 	NULL,
 };
 
@@ -524,6 +539,20 @@
 		s_controls.playerWeapon = WP_GRAPPLING_HOOK;
 		break;
 
+#ifdef MISSIONPACK
+	case ANIM_WEAPON11:
+		s_controls.playerWeapon = WP_NAILGUN;
+		break;
+
+	case ANIM_WEAPON12:
+		s_controls.playerWeapon = WP_PROX_LAUNCHER;
+		break;
+
+	case ANIM_WEAPON13:
+		s_controls.playerWeapon = WP_CHAINGUN;
+		break;
+#endif
+
 	case ANIM_ATTACK:
 		s_controls.playerTorso = TORSO_ATTACK;
 		break;
@@ -1342,11 +1371,11 @@
 	s_controls.run.generic.ownerdraw = Controls_DrawKeyBinding;
 	s_controls.run.generic.id        = ID_SPEED;
 
-	s_controls.chainsaw.generic.type	  = MTYPE_ACTION;
-	s_controls.chainsaw.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
-	s_controls.chainsaw.generic.callback  = Controls_ActionEvent;
-	s_controls.chainsaw.generic.ownerdraw = Controls_DrawKeyBinding;
-	s_controls.chainsaw.generic.id        = ID_WEAPON1;
+	s_controls.gauntlet.generic.type	  = MTYPE_ACTION;
+	s_controls.gauntlet.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
+	s_controls.gauntlet.generic.callback  = Controls_ActionEvent;
+	s_controls.gauntlet.generic.ownerdraw = Controls_DrawKeyBinding;
+	s_controls.gauntlet.generic.id        = ID_WEAPON1;
 
 	s_controls.machinegun.generic.type	    = MTYPE_ACTION;
 	s_controls.machinegun.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
@@ -1396,6 +1425,26 @@
 	s_controls.bfg.generic.ownerdraw = Controls_DrawKeyBinding;
 	s_controls.bfg.generic.id        = ID_WEAPON9;
 
+#ifdef MISSIONPACK
+	s_controls.nailgun.generic.type	     = MTYPE_ACTION;
+	s_controls.nailgun.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
+	s_controls.nailgun.generic.callback  = Controls_ActionEvent;
+	s_controls.nailgun.generic.ownerdraw = Controls_DrawKeyBinding;
+	s_controls.nailgun.generic.id        = ID_WEAPON11;
+
+	s_controls.proxylauncher.generic.type	   = MTYPE_ACTION;
+	s_controls.proxylauncher.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
+	s_controls.proxylauncher.generic.callback  = Controls_ActionEvent;
+	s_controls.proxylauncher.generic.ownerdraw = Controls_DrawKeyBinding;
+	s_controls.proxylauncher.generic.id        = ID_WEAPON12;
+
+	s_controls.chaingun.generic.type	  = MTYPE_ACTION;
+	s_controls.chaingun.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
+	s_controls.chaingun.generic.callback  = Controls_ActionEvent;
+	s_controls.chaingun.generic.ownerdraw = Controls_DrawKeyBinding;
+	s_controls.chaingun.generic.id        = ID_WEAPON13;
+#endif
+
 	s_controls.attack.generic.type	    = MTYPE_ACTION;
 	s_controls.attack.generic.flags     = QMF_LEFT_JUSTIFY|QMF_PULSEIFFOCUS|QMF_GRAYED|QMF_HIDDEN;
 	s_controls.attack.generic.callback  = Controls_ActionEvent;
@@ -1607,7 +1656,7 @@
 	Menu_AddItem( &s_controls.menu, &s_controls.nextweapon );
 	Menu_AddItem( &s_controls.menu, &s_controls.prevweapon );
 	Menu_AddItem( &s_controls.menu, &s_controls.autoswitch );
-	Menu_AddItem( &s_controls.menu, &s_controls.chainsaw );
+	Menu_AddItem( &s_controls.menu, &s_controls.gauntlet );
 	Menu_AddItem( &s_controls.menu, &s_controls.machinegun );
 	Menu_AddItem( &s_controls.menu, &s_controls.shotgun );
 	Menu_AddItem( &s_controls.menu, &s_controls.grenadelauncher );
@@ -1616,6 +1665,11 @@
 	Menu_AddItem( &s_controls.menu, &s_controls.railgun );
 	Menu_AddItem( &s_controls.menu, &s_controls.plasma );
 	Menu_AddItem( &s_controls.menu, &s_controls.bfg );
+#ifdef MISSIONPACK
+	Menu_AddItem( &s_controls.menu, &s_controls.nailgun );
+	Menu_AddItem( &s_controls.menu, &s_controls.proxylauncher );
+	Menu_AddItem( &s_controls.menu, &s_controls.chaingun );
+#endif
 
 	Menu_AddItem( &s_controls.menu, &s_controls.showscores );
 	Menu_AddItem( &s_controls.menu, &s_controls.useitem );
Index: code/q3_ui/ui_gameinfo.c
===================================================================
--- code/q3_ui/ui_gameinfo.c	(revision 3378)
+++ code/q3_ui/ui_gameinfo.c	(working copy)
@@ -363,8 +363,18 @@
 	char*		dirptr;
 	int			i;
 	int			dirlen;
+	char		info[MAX_INFO_STRING];
 
 	ui_numBots = 0;
+	// setup random bot option
+	memset(info, 0, MAX_INFO_STRING);
+	Info_SetValueForKey(info, "name", "Random");
+	Info_SetValueForKey(info, "model", "random");
+	ui_botInfos[ui_numBots] = UI_Alloc(strlen(info) + strlen("\\num\\") + strlen(va("%d", MAX_ARENAS)) + 1);
+	if (ui_botInfos[ui_numBots]) {
+		strcpy(ui_botInfos[ui_numBots], info);
+	}
+	ui_numBots++;
 
 	trap_Cvar_Register( &botsFile, "g_botsFile", "", CVAR_INIT|CVAR_ROM );
 	if( *botsFile.string ) {
Index: code/q3_ui/ui_local.h
===================================================================
--- code/q3_ui/ui_local.h	(revision 3378)
+++ code/q3_ui/ui_local.h	(working copy)
@@ -90,8 +90,6 @@
 extern vmCvar_t	ui_server15;
 extern vmCvar_t	ui_server16;
 
-extern vmCvar_t	ui_cdkey;
-extern vmCvar_t	ui_cdkeychecked;
 extern vmCvar_t	ui_ioq3;
 
 
@@ -381,13 +379,6 @@
 extern void UI_ModsMenu_Cache( void );
 
 //
-// ui_cdkey.c
-//
-extern void UI_CDKeyMenu( void );
-extern void UI_CDKeyMenu_Cache( void );
-extern void UI_CDKeyMenu_f( void );
-
-//
 // ui_playermodel.c
 //
 extern void UI_PlayerModelMenu( void );
@@ -682,13 +673,7 @@
 void			trap_LAN_GetPing( int n, char *buf, int buflen, int *pingtime );
 void			trap_LAN_GetPingInfo( int n, char *buf, int buflen );
 int				trap_MemoryRemaining( void );
-void			trap_GetCDKey( char *buf, int buflen );
-void			trap_SetCDKey( char *buf );
 
-qboolean               trap_VerifyCDKey( const char *key, const char *chksum);
-
-void			trap_SetPbClStatus( int status );
-
 //
 // ui_addbots.c
 //
Index: code/q3_ui/ui_main.c
===================================================================
--- code/q3_ui/ui_main.c	(revision 3378)
+++ code/q3_ui/ui_main.c	(working copy)
@@ -78,8 +78,6 @@
 	case UI_DRAW_CONNECT_SCREEN:
 		UI_DrawConnectScreen( arg0 );
 		return 0;
-	case UI_HASUNIQUECDKEY:				// mod authors need to observe this
-		return qtrue;  // change this to qfalse for mods!
 	}
 
 	return -1;
@@ -154,7 +152,6 @@
 vmCvar_t	ui_server15;
 vmCvar_t	ui_server16;
 
-vmCvar_t	ui_cdkeychecked;
 vmCvar_t	ui_ioq3;
 
 static cvarTable_t		cvarTable[] = {
@@ -213,7 +210,6 @@
 	{ &ui_server15, "server15", "", CVAR_ARCHIVE },
 	{ &ui_server16, "server16", "", CVAR_ARCHIVE },
 
-	{ &ui_cdkeychecked, "ui_cdkeychecked", "0", CVAR_ROM },
 	{ &ui_ioq3, "ui_ioq3", "1", CVAR_ROM },
 	{ NULL, "g_localTeamPref", "", 0 }
 };
Index: code/q3_ui/ui_menu.c
===================================================================
--- code/q3_ui/ui_menu.c	(revision 3378)
+++ code/q3_ui/ui_menu.c	(working copy)
@@ -273,16 +273,6 @@
 
 	trap_Cvar_Set( "sv_killserver", "1" );
 
-	if( !uis.demoversion && !ui_cdkeychecked.integer ) {
-		char	key[17];
-
-		trap_GetCDKey( key, sizeof(key) );
-		if( trap_VerifyCDKey( key, NULL ) == qfalse ) {
-			UI_CDKeyMenu();
-			return;
-		}
-	}
-	
 	memset( &s_main, 0 ,sizeof(mainmenu_t) );
 	memset( &s_errorMessage, 0 ,sizeof(errorMessage_t) );
 
Index: code/q3_ui/ui_players.c
===================================================================
--- code/q3_ui/ui_players.c	(revision 3378)
+++ code/q3_ui/ui_players.c	(working copy)
@@ -87,12 +87,11 @@
 		goto tryagain;
 	}
 
-	if ( weaponNum == WP_MACHINEGUN || weaponNum == WP_GAUNTLET || weaponNum == WP_BFG ) {
 		COM_StripExtension( item->world_model[0], path, sizeof(path) );
 		Q_strcat( path, sizeof(path), "_barrel.md3" );
 		pi->barrelModel = trap_R_RegisterModel( path );
-	}
 
+
 	COM_StripExtension( item->world_model[0], path, sizeof(path) );
 	Q_strcat( path, sizeof(path), "_flash.md3" );
 	pi->flashModel = trap_R_RegisterModel( path );
@@ -138,6 +137,20 @@
 		MAKERGB( pi->flashDlightColor, 0.6f, 0.6f, 1 );
 		break;
 
+#ifdef MISSIONPACK
+	case WP_NAILGUN:
+		MAKERGB( pi->flashDlightColor, 1, 0.75f, 0 );
+		break;
+
+	case WP_PROX_LAUNCHER:
+		MAKERGB( pi->flashDlightColor, 1, 0.70f, 0 );
+		break;
+
+	case WP_CHAINGUN:
+		MAKERGB( pi->flashDlightColor, 1, 1, 0 );
+		break;
+#endif
+
 	default:
 		MAKERGB( pi->flashDlightColor, 1, 1, 1 );
 		break;
@@ -660,7 +673,7 @@
 
 	memset( &ent, 0, sizeof( ent ) );
 	VectorCopy( origin, ent.origin );
-	ent.origin[2] += 48;
+	ent.origin[2] += 42;
 	ent.reType = RT_SPRITE;
 	ent.customShader = shader;
 	ent.radius = 10;
@@ -858,7 +871,7 @@
 	//
 	// add the spinning barrel
 	//
-	if ( pi->realWeapon == WP_MACHINEGUN || pi->realWeapon == WP_GAUNTLET || pi->realWeapon == WP_BFG ) {
+	if ( pi->barrelModel ) {
 		vec3_t	angles;
 
 		memset( &barrel, 0, sizeof(barrel) );
Index: code/q3_ui/ui_servers2.c
===================================================================
--- code/q3_ui/ui_servers2.c	(revision 3378)
+++ code/q3_ui/ui_servers2.c	(working copy)
@@ -59,7 +59,6 @@
 #define ART_UNKNOWNMAP			"menu/art/unknownmap"
 #define ART_REMOVE0				"menu/art/delete_0"
 #define ART_REMOVE1				"menu/art/delete_1"
-#define ART_PUNKBUSTER		"menu/art/pblogo"
 
 #define ID_MASTER			10
 #define ID_GAMETYPE			11
@@ -75,7 +74,6 @@
 #define ID_CREATE			21
 #define ID_CONNECT			22
 #define ID_REMOVE			23
-#define ID_PUNKBUSTER 24
 
 #define GR_LOGO				30
 #define GR_LETTERS			31
@@ -162,20 +160,6 @@
 
 static char quake3worldMessage[] = "Visit www.quake3world.com - News, Community, Events, Files";
 
-const char* punkbuster_items[] = {
-	"Disabled",
-	"Enabled",
-	NULL
-};
-
-const char* punkbuster_msg[] = {
-	"PunkBuster will be",
-	"disabled the next time",
-	"Quake III Arena",
-	"is started.",
-	NULL
-};
-
 typedef struct {
 	char	adrstr[MAX_ADDRESSLENGTH];
 	int		start;
@@ -193,7 +177,6 @@
 	int		nettype;
 	int		minPing;
 	int		maxPing;
-	qboolean bPB;
 
 } servernode_t; 
 
@@ -242,8 +225,6 @@
 	char				favoriteaddresses[MAX_FAVORITESERVERS][MAX_ADDRESSLENGTH];
 	int					numfavoriteaddresses;
 
-	menulist_s		punkbuster;
-	menubitmap_s	pblogo;
 } arenaservers_t;
 
 static arenaservers_t	g_arenaservers;
@@ -434,7 +415,6 @@
 			g_arenaservers.list.generic.flags		&= ~QMF_GRAYED;
 			g_arenaservers.refresh.generic.flags	&= ~QMF_GRAYED;
 			g_arenaservers.go.generic.flags			&= ~QMF_GRAYED;
-			g_arenaservers.punkbuster.generic.flags &= ~QMF_GRAYED;
 
 			// update status bar
 			if( g_servertype >= UIAS_GLOBAL0 && g_servertype <= UIAS_GLOBAL5 ) {
@@ -460,7 +440,6 @@
 			g_arenaservers.list.generic.flags		|= QMF_GRAYED;
 			g_arenaservers.refresh.generic.flags	|= QMF_GRAYED;
 			g_arenaservers.go.generic.flags			|= QMF_GRAYED;
-			g_arenaservers.punkbuster.generic.flags |= QMF_GRAYED;
 		}
 		else {
 			if( g_arenaservers.numqueriedservers < 0 ) {
@@ -487,7 +466,6 @@
 			g_arenaservers.list.generic.flags		|= QMF_GRAYED;
 			g_arenaservers.refresh.generic.flags	&= ~QMF_GRAYED;
 			g_arenaservers.go.generic.flags			|= QMF_GRAYED;
-			g_arenaservers.punkbuster.generic.flags &= ~QMF_GRAYED;
 		}
 
 		// zero out list box
@@ -562,10 +540,10 @@
 			pingColor = S_COLOR_RED;
 		}
 
-		Com_sprintf( buff, MAX_LISTBOXWIDTH, "%-20.20s %-12.12s %2d/%2d %-8.8s %4s%s%3d " S_COLOR_YELLOW "%s", 
+		Com_sprintf( buff, MAX_LISTBOXWIDTH, "%-20.20s %-12.12s %2d/%2d %-8.8s %4s%s%3d " S_COLOR_YELLOW "", 
 			servernodeptr->hostname, servernodeptr->mapname, servernodeptr->numclients,
  			servernodeptr->maxclients, servernodeptr->gamename,
-			netnames[servernodeptr->nettype], pingColor, servernodeptr->pingtime, servernodeptr->bPB ? "Yes" : "No" );
+			netnames[servernodeptr->nettype], pingColor, servernodeptr->pingtime );
 		j++;
 	}
 
@@ -681,7 +659,6 @@
 	servernodeptr->pingtime   = pingtime;
 	servernodeptr->minPing    = atoi( Info_ValueForKey( info, "minPing") );
 	servernodeptr->maxPing    = atoi( Info_ValueForKey( info, "maxPing") );
-	servernodeptr->bPB = atoi( Info_ValueForKey( info, "punkbuster") );
 
 	/*
 	s = Info_ValueForKey( info, "nettype" );
@@ -1164,7 +1141,7 @@
 		g_arenaservers.currentping       = *g_arenaservers.numservers;
 		g_arenaservers.numqueriedservers = *g_arenaservers.numservers; 
 		ArenaServers_UpdateMenu();
-		strcpy(g_arenaservers.status.string,"hit refresh to update");
+		strcpy( g_arenaservers.status.string, "Hit Refresh to Update." );
 	}
 	
 	return type;
@@ -1172,28 +1149,6 @@
 
 /*
 =================
-PunkBuster_Confirm
-=================
-*/
-static void Punkbuster_ConfirmEnable( qboolean result ) {
-	if (result)
-	{		
-		trap_SetPbClStatus(1);
-	}
-	g_arenaservers.punkbuster.curvalue = Com_Clamp( 0, 1, trap_Cvar_VariableValue( "cl_punkbuster" ) );
-}
-
-static void Punkbuster_ConfirmDisable( qboolean result ) {
-	if (result)
-	{
-		trap_SetPbClStatus(0);
-		UI_Message( punkbuster_msg );
-	}
-	g_arenaservers.punkbuster.curvalue = Com_Clamp( 0, 1, trap_Cvar_VariableValue( "cl_punkbuster" ) );
-}
-
-/*
-=================
 ArenaServers_Event
 =================
 */
@@ -1276,17 +1231,6 @@
 		ArenaServers_Remove();
 		ArenaServers_UpdateMenu();
 		break;
-	
-	case ID_PUNKBUSTER:
-		if (g_arenaservers.punkbuster.curvalue)			
-		{
-			UI_ConfirmMenu_Style( "Enable Punkbuster?",  UI_CENTER|UI_INVERSE|UI_SMALLFONT, 0, Punkbuster_ConfirmEnable );
-		}
-		else
-		{
-			UI_ConfirmMenu_Style( "Disable Punkbuster?", UI_CENTER|UI_INVERSE|UI_SMALLFONT, 0, Punkbuster_ConfirmDisable );
-		}
-		break;
 	}
 }
 
@@ -1542,24 +1486,6 @@
 	g_arenaservers.go.height				= 64;
 	g_arenaservers.go.focuspic				= ART_CONNECT1;
 
-	g_arenaservers.punkbuster.generic.type			= MTYPE_SPINCONTROL;
-	g_arenaservers.punkbuster.generic.name			= "Punkbuster:";
-	g_arenaservers.punkbuster.generic.flags			= QMF_PULSEIFFOCUS|QMF_SMALLFONT;
-	g_arenaservers.punkbuster.generic.callback		= ArenaServers_Event;
-	g_arenaservers.punkbuster.generic.id			= ID_PUNKBUSTER;
-	g_arenaservers.punkbuster.generic.x				= 480+32;
-	g_arenaservers.punkbuster.generic.y				= 144;
-	g_arenaservers.punkbuster.itemnames				= punkbuster_items;
-	
-	g_arenaservers.pblogo.generic.type			= MTYPE_BITMAP;
-	g_arenaservers.pblogo.generic.name			= ART_PUNKBUSTER;
-	g_arenaservers.pblogo.generic.flags			= QMF_LEFT_JUSTIFY|QMF_INACTIVE;
-	g_arenaservers.pblogo.generic.x				= 526;
-	g_arenaservers.pblogo.generic.y				= 176;
-	g_arenaservers.pblogo.width					= 32;
-	g_arenaservers.pblogo.height				= 16;
-	g_arenaservers.pblogo.errorpic				= ART_UNKNOWNMAP;
-	
 	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.banner );
 
 	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.master );
@@ -1582,9 +1508,6 @@
 	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.refresh );
 	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.create );
 	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.go );
-
-	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.punkbuster );
-	Menu_AddItem( &g_arenaservers.menu, (void*) &g_arenaservers.pblogo );
 	
 	ArenaServers_LoadFavorites();
 
@@ -1601,8 +1524,6 @@
 
 	g_emptyservers = Com_Clamp( 0, 1, ui_browserShowEmpty.integer );
 	g_arenaservers.showempty.curvalue = g_emptyservers;
-	
-	g_arenaservers.punkbuster.curvalue = Com_Clamp( 0, 1, trap_Cvar_VariableValue( "cl_punkbuster" ) );
 
 	// force to initial state and refresh
 	g_arenaservers.master.curvalue = g_servertype = ArenaServers_SetType(g_servertype);
@@ -1631,7 +1552,6 @@
 	trap_R_RegisterShaderNoMip( ART_ARROWS_UP );
 	trap_R_RegisterShaderNoMip( ART_ARROWS_DOWN );
 	trap_R_RegisterShaderNoMip( ART_UNKNOWNMAP );
-	trap_R_RegisterShaderNoMip( ART_PUNKBUSTER );
 }
 
 
Index: code/q3_ui/ui_setup.c
===================================================================
--- code/q3_ui/ui_setup.c	(revision 3378)
+++ code/q3_ui/ui_setup.c	(working copy)
@@ -43,11 +43,10 @@
 #define ID_CUSTOMIZECONTROLS	11
 #define ID_SYSTEMCONFIG			12
 #define ID_GAME					13
-#define ID_CDKEY				14
-#define ID_LOAD					15
-#define ID_SAVE					16
-#define ID_DEFAULTS				17
-#define ID_BACK					18
+#define ID_LOAD					14
+#define ID_SAVE					15
+#define ID_DEFAULTS				16
+#define ID_BACK					17
 
 
 typedef struct {
@@ -60,7 +59,6 @@
 	menutext_s		setupcontrols;
 	menutext_s		setupsystem;
 	menutext_s		game;
-	menutext_s		cdkey;
 //	menutext_s		load;
 //	menutext_s		save;
 	menutext_s		defaults;
@@ -123,10 +121,6 @@
 		UI_PreferencesMenu();
 		break;
 
-	case ID_CDKEY:
-		UI_CDKeyMenu();
-		break;
-
 //	case ID_LOAD:
 //		UI_LoadConfigMenu();
 //		break;
@@ -227,17 +221,6 @@
 	setupMenuInfo.game.color						= color_red;
 	setupMenuInfo.game.style						= UI_CENTER;
 
-	y += SETUP_MENU_VERTICAL_SPACING;
-	setupMenuInfo.cdkey.generic.type				= MTYPE_PTEXT;
-	setupMenuInfo.cdkey.generic.flags				= QMF_CENTER_JUSTIFY|QMF_PULSEIFFOCUS;
-	setupMenuInfo.cdkey.generic.x					= 320;
-	setupMenuInfo.cdkey.generic.y					= y;
-	setupMenuInfo.cdkey.generic.id					= ID_CDKEY;
-	setupMenuInfo.cdkey.generic.callback			= UI_SetupMenu_Event; 
-	setupMenuInfo.cdkey.string						= "CD Key";
-	setupMenuInfo.cdkey.color						= color_red;
-	setupMenuInfo.cdkey.style						= UI_CENTER;
-
 	if( !trap_Cvar_VariableValue( "cl_paused" ) ) {
 #if 0
 		y += SETUP_MENU_VERTICAL_SPACING;
@@ -293,7 +276,6 @@
 	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.setupcontrols );
 	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.setupsystem );
 	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.game );
-	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.cdkey );
 //	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.load );
 //	Menu_AddItem( &setupMenuInfo.menu, &setupMenuInfo.save );
 	if( !trap_Cvar_VariableValue( "cl_paused" ) ) {
Index: code/q3_ui/ui_sound.c
===================================================================
--- code/q3_ui/ui_sound.c	(revision 3378)
+++ code/q3_ui/ui_sound.c	(working copy)
@@ -53,7 +53,7 @@
 #define DEFAULT_SDL_SND_SPEED 22050
 
 static const char *quality_items[] = {
-	"Low", "Medium", "High", NULL
+	"Low (11k)", "Medium (22k)", "High (44.1k)", "Very High (48k)", NULL
 };
 
 #define UISND_SDL 0
Index: code/q3_ui/ui_startserver.c
===================================================================
--- code/q3_ui/ui_startserver.c	(revision 3378)
+++ code/q3_ui/ui_startserver.c	(working copy)
@@ -99,9 +99,6 @@
 static int gametype_remap[] = {GT_FFA, GT_TEAM, GT_TOURNAMENT, GT_CTF};
 static int gametype_remap2[] = {0, 2, 0, 1, 3};
 
-// use ui_servers2.c definition
-extern const char* punkbuster_items[];
-
 static void UI_ServerOptionsMenu( qboolean multiplayer );
 
 
@@ -656,8 +653,6 @@
 	qboolean			newBot;
 	int					newBotIndex;
 	char				newBotName[16];
-	
-	menulist_s		punkbuster;
 } serveroptions_t;
 
 static serveroptions_t s_serveroptions;
@@ -787,8 +782,6 @@
 	trap_Cvar_SetValue( "g_friendlyfire", friendlyfire );
 	trap_Cvar_SetValue( "sv_pure", pure );
 	trap_Cvar_Set("sv_hostname", s_serveroptions.hostname.field.buffer );
-	
-	trap_Cvar_SetValue( "sv_punkbuster", s_serveroptions.punkbuster.curvalue );
 
 	// the wait commands will allow the dedicated to take effect
 	info = UI_GetArenaInfoByNumber( s_startserver.maplist[ s_startserver.currentmap ]);
@@ -1248,7 +1241,6 @@
 	s_serveroptions.multiplayer = multiplayer;
 	s_serveroptions.gametype = (int) Com_Clamp(0, ARRAY_LEN(gametype_remap2) - 1,
 						trap_Cvar_VariableValue("g_gametype"));
-	s_serveroptions.punkbuster.curvalue = Com_Clamp( 0, 1, trap_Cvar_VariableValue( "sv_punkbuster" ) );
 
 	ServerOptions_Cache();
 
@@ -1350,15 +1342,6 @@
 		s_serveroptions.hostname.field.maxchars     = 64;
 	}
 
-	y += BIGCHAR_HEIGHT+2;
-	s_serveroptions.punkbuster.generic.type			= MTYPE_SPINCONTROL;
-	s_serveroptions.punkbuster.generic.name			= "Punkbuster:";
-	s_serveroptions.punkbuster.generic.flags			= QMF_PULSEIFFOCUS|QMF_SMALLFONT;
-	s_serveroptions.punkbuster.generic.id			= 0;
-	s_serveroptions.punkbuster.generic.x				= OPTIONS_X;
-	s_serveroptions.punkbuster.generic.y				= y;
-	s_serveroptions.punkbuster.itemnames				= punkbuster_items;
-	
 	y = 80;
 	s_serveroptions.botSkill.generic.type			= MTYPE_SPINCONTROL;
 	s_serveroptions.botSkill.generic.flags			= QMF_PULSEIFFOCUS|QMF_SMALLFONT;
@@ -1482,8 +1465,6 @@
 	Menu_AddItem( &s_serveroptions.menu, &s_serveroptions.next );
 	Menu_AddItem( &s_serveroptions.menu, &s_serveroptions.go );
 
-	Menu_AddItem( &s_serveroptions.menu, (void*) &s_serveroptions.punkbuster );
-	
 	ServerOptions_SetMenuItems();
 }
 
Index: code/qcommon/cm_load.c
===================================================================
--- code/qcommon/cm_load.c	(revision 3378)
+++ code/qcommon/cm_load.c	(working copy)
@@ -23,24 +23,6 @@
 
 #include "cm_local.h"
 
-#ifdef BSPC
-
-#include "../bspc/l_qfiles.h"
-
-void SetPlaneSignbits (cplane_t *out) {
-	int	bits, j;
-
-	// for fast box on planeside test
-	bits = 0;
-	for (j=0 ; j<3 ; j++) {
-		if (out->normal[j] < 0) {
-			bits |= 1<<j;
-		}
-	}
-	out->signbits = bits;
-}
-#endif //BSPC
-
 // to allow boxes to be treated as brush models, we allocate
 // some extra indexes along with those needed by the map
 #define	BOX_BRUSHES		1
Index: code/qcommon/cm_polylib.c
===================================================================
--- code/qcommon/cm_polylib.c	(revision 3378)
+++ code/qcommon/cm_polylib.c	(working copy)
@@ -98,6 +98,8 @@
 		VectorNormalize2(v2,v2);
 		if (DotProduct(v1, v2) < 0.999)
 		{
+			if (nump >= MAX_POINTS_ON_WINDING)
+				Com_Error (ERR_DROP, "RemoveColinearPoints: MAX_POINTS_ON_WINDING");
 			VectorCopy (w->p[i], p[nump]);
 			nump++;
 		}
@@ -407,9 +409,9 @@
 	}
 	
 	if (f->numpoints > maxpts || b->numpoints > maxpts)
-		Com_Error (ERR_DROP, "ClipWinding: points exceeded estimate");
+		Com_Error (ERR_DROP, "ClipWindingEpsilon: points exceeded estimate");
 	if (f->numpoints > MAX_POINTS_ON_WINDING || b->numpoints > MAX_POINTS_ON_WINDING)
-		Com_Error (ERR_DROP, "ClipWinding: MAX_POINTS_ON_WINDING");
+		Com_Error (ERR_DROP, "ClipWindingEpsilon: MAX_POINTS_ON_WINDING");
 }
 
 
@@ -506,9 +508,9 @@
 	}
 	
 	if (f->numpoints > maxpts)
-		Com_Error (ERR_DROP, "ClipWinding: points exceeded estimate");
+		Com_Error (ERR_DROP, "ChopWindingInPlace: points exceeded estimate");
 	if (f->numpoints > MAX_POINTS_ON_WINDING)
-		Com_Error (ERR_DROP, "ClipWinding: MAX_POINTS_ON_WINDING");
+		Com_Error (ERR_DROP, "ChopWindingInPlace: MAX_POINTS_ON_WINDING");
 
 	FreeWinding (in);
 	*inout = f;
@@ -565,7 +567,7 @@
 
 		for (j=0 ; j<3 ; j++)
 			if (p1[j] > MAX_MAP_BOUNDS || p1[j] < -MAX_MAP_BOUNDS)
-				Com_Error (ERR_DROP, "CheckFace: BUGUS_RANGE: %f",p1[j]);
+				Com_Error (ERR_DROP, "CheckWinding: BOGUS_RANGE: %f",p1[j]);
 
 		j = i+1 == w->numpoints ? 0 : i+1;
 		
Index: code/qcommon/cm_trace.c
===================================================================
--- code/qcommon/cm_trace.c	(revision 3378)
+++ code/qcommon/cm_trace.c	(working copy)
@@ -833,7 +833,7 @@
 	VectorSet(start2d, start[0], start[1], 0);
 	VectorSet(end2d, end[0], end[1], 0);
 	VectorSet(org2d, origin[0], origin[1], 0);
-	// if between lower and upper cylinder bounds
+	// if start is between lower and upper cylinder bounds
 	if (start[2] <= origin[2] + halfheight &&
 				start[2] >= origin[2] - halfheight) {
 		// if inside the cylinder
Index: code/qcommon/common.c
===================================================================
--- code/qcommon/common.c	(revision 3378)
+++ code/qcommon/common.c	(working copy)
@@ -73,9 +73,7 @@
 cvar_t	*com_singlePlayerActive;
 cvar_t	*com_blood;
 cvar_t	*com_buildScript;	// for automated data building scripts
-#ifdef CINEMATICS_INTRO
 cvar_t	*com_introPlayed;
-#endif
 cvar_t	*cl_paused;
 cvar_t	*sv_paused;
 cvar_t  *cl_packetdelay;
@@ -299,7 +297,7 @@
 	Q_vsnprintf (com_errorMessage, sizeof(com_errorMessage),fmt,argptr);
 	va_end (argptr);
 
-	if (code != ERR_DISCONNECT && code != ERR_NEED_CD)
+	if (code != ERR_DISCONNECT)
 		Cvar_Set("com_errorMessage", com_errorMessage);
 
 	restartClient = com_gameClientRestarting && !( com_cl_running && com_cl_running->integer );
@@ -333,26 +331,6 @@
 		FS_PureServerSetLoadedPaks("", "");
 		com_errorEntered = qfalse;
 		longjmp (abortframe, -1);
-	} else if ( code == ERR_NEED_CD ) {
-		VM_Forced_Unload_Start();
-		SV_Shutdown( "Server didn't have CD" );
-		if ( restartClient ) {
-			CL_Init();
-		}
-		if ( com_cl_running && com_cl_running->integer ) {
-			CL_Disconnect( qtrue );
-			CL_FlushMemory( );
-			VM_Forced_Unload_Done();
-			CL_CDDialog();
-		} else {
-			Com_Printf("Server didn't have CD\n" );
-			VM_Forced_Unload_Done();
-		}
-
-		FS_PureServerSetLoadedPaks("", "");
-
-		com_errorEntered = qfalse;
-		longjmp (abortframe, -1);
 	} else {
 		VM_Forced_Unload_Start();
 		CL_Shutdown(va("Client fatal crashed: %s", com_errorMessage), qtrue, qtrue);
@@ -1742,9 +1720,9 @@
 		Hunk_Log();
 		Hunk_SmallLog();
 
-		Com_Error(ERR_DROP, "Hunk_Alloc failed on %i: %s, line: %d (%s)", size, file, line, label);
+		Com_Error(ERR_DROP, "Hunk_Alloc failed on %i bytes (increase com_hunkMegs cvar value, current value %d): %s, line: %d (%s)", size, Cvar_VariableIntegerValue("com_hunkMegs"), file, line, label);
 #else
-		Com_Error(ERR_DROP, "Hunk_Alloc failed on %i", size);
+		Com_Error(ERR_DROP, "Hunk_Alloc failed on %i bytes (increase com_hunkMegs cvar value, current value %d)", size, Cvar_VariableIntegerValue("com_hunkMegs"));
 #endif
 	}
 
@@ -1804,7 +1782,7 @@
 	size = PAD(size, sizeof(intptr_t)) + sizeof( hunkHeader_t );
 
 	if ( hunk_temp->temp + hunk_permanent->permanent + size > s_hunkTotal ) {
-		Com_Error( ERR_DROP, "Hunk_AllocateTempMemory: failed on %i", size );
+		Com_Error( ERR_DROP, "Hunk_AllocateTempMemory: failed on %i bytes (increase com_hunkMegs cvar value, current value %d)", size, Cvar_VariableIntegerValue( "com_hunkMegs" ) );
 	}
 
 	if ( hunk_temp == &hunk_low ) {
@@ -2445,129 +2423,6 @@
 	Com_GameRestart(0, qtrue);
 }
 
-#ifndef STANDALONE
-
-// TTimo: centralizing the cl_cdkey stuff after I discovered a buffer overflow problem with the dedicated server version
-//   not sure it's necessary to have different defaults for regular and dedicated, but I don't want to risk it
-//   https://zerowing.idsoftware.com/bugzilla/show_bug.cgi?id=470
-#ifndef DEDICATED
-char	cl_cdkey[34] = "                                ";
-#else
-char	cl_cdkey[34] = "123456789";
-#endif
-
-/*
-=================
-Com_ReadCDKey
-=================
-*/
-qboolean CL_CDKeyValidate( const char *key, const char *checksum );
-void Com_ReadCDKey( const char *filename ) {
-	fileHandle_t	f;
-	char			buffer[33];
-	char			fbuffer[MAX_OSPATH];
-
-	Com_sprintf(fbuffer, sizeof(fbuffer), "%s/q3key", filename);
-
-	FS_SV_FOpenFileRead( fbuffer, &f );
-	if ( !f ) {
-		Q_strncpyz( cl_cdkey, "                ", 17 );
-		return;
-	}
-
-	Com_Memset( buffer, 0, sizeof(buffer) );
-
-	FS_Read( buffer, 16, f );
-	FS_FCloseFile( f );
-
-	if (CL_CDKeyValidate(buffer, NULL)) {
-		Q_strncpyz( cl_cdkey, buffer, 17 );
-	} else {
-		Q_strncpyz( cl_cdkey, "                ", 17 );
-	}
-}
-
-/*
-=================
-Com_AppendCDKey
-=================
-*/
-void Com_AppendCDKey( const char *filename ) {
-	fileHandle_t	f;
-	char			buffer[33];
-	char			fbuffer[MAX_OSPATH];
-
-	Com_sprintf(fbuffer, sizeof(fbuffer), "%s/q3key", filename);
-
-	FS_SV_FOpenFileRead( fbuffer, &f );
-	if (!f) {
-		Q_strncpyz( &cl_cdkey[16], "                ", 17 );
-		return;
-	}
-
-	Com_Memset( buffer, 0, sizeof(buffer) );
-
-	FS_Read( buffer, 16, f );
-	FS_FCloseFile( f );
-
-	if (CL_CDKeyValidate(buffer, NULL)) {
-		strcat( &cl_cdkey[16], buffer );
-	} else {
-		Q_strncpyz( &cl_cdkey[16], "                ", 17 );
-	}
-}
-
-#ifndef DEDICATED
-/*
-=================
-Com_WriteCDKey
-=================
-*/
-static void Com_WriteCDKey( const char *filename, const char *ikey ) {
-	fileHandle_t	f;
-	char			fbuffer[MAX_OSPATH];
-	char			key[17];
-#ifndef _WIN32
-	mode_t			savedumask;
-#endif
-
-
-	Com_sprintf(fbuffer, sizeof(fbuffer), "%s/q3key", filename);
-
-
-	Q_strncpyz( key, ikey, 17 );
-
-	if(!CL_CDKeyValidate(key, NULL) ) {
-		return;
-	}
-
-#ifndef _WIN32
-	savedumask = umask(0077);
-#endif
-	f = FS_SV_FOpenFileWrite( fbuffer );
-	if ( !f ) {
-		Com_Printf ("Couldn't write CD key to %s.\n", fbuffer );
-		goto out;
-	}
-
-	FS_Write( key, 16, f );
-
-	FS_Printf( f, "\n// generated by quake, do not modify\r\n" );
-	FS_Printf( f, "// Do not give this file to ANYONE.\r\n" );
-	FS_Printf( f, "// id Software and Activision will NOT ask you to send this file to them.\r\n");
-
-	FS_FCloseFile( f );
-out:
-#ifndef _WIN32
-	umask(savedumask);
-#else
-	;
-#endif
-}
-#endif
-
-#endif // STANDALONE
-
 static void Com_DetectAltivec(void)
 {
 	// Only detect if user hasn't forcibly disabled it.
@@ -2772,9 +2627,7 @@
 	com_busyWait = Cvar_Get("com_busyWait", "0", CVAR_ARCHIVE);
 	Cvar_Get("com_errorMessage", "", CVAR_ROM | CVAR_NORESTART);
 
-#ifdef CINEMATICS_INTRO
 	com_introPlayed = Cvar_Get( "com_introplayed", "0", CVAR_ARCHIVE);
-#endif
 
 	s = va("%s %s %s", Q3_VERSION, PLATFORM_STRING, PRODUCT_DATE );
 	com_version = Cvar_Get ("version", s, CVAR_ROM | CVAR_SERVERINFO );
@@ -2822,12 +2675,10 @@
 #ifdef CINEMATICS_LOGO
 			Cbuf_AddText ("cinematic " CINEMATICS_LOGO "\n");
 #endif
-#ifdef CINEMATICS_INTRO
 			if( !com_introPlayed->integer ) {
 				Cvar_Set( com_introPlayed->name, "1" );
 				Cvar_Set( "nextmap", "cinematic " CINEMATICS_INTRO );
 			}
-#endif
 		}
 	}
 
@@ -2918,7 +2769,7 @@
 		return;
 	}
 
-	FS_Printf (f, "// generated by quake, do not modify\n");
+	FS_Printf (f, "// Generated by " PRODUCT_NAME ", do not modify\n");
 	Key_WriteBindings (f);
 	Cvar_WriteVariables (f);
 	FS_FCloseFile( f );
@@ -2945,20 +2796,6 @@
 	cvar_modifiedFlags &= ~CVAR_ARCHIVE;
 
 	Com_WriteConfigToFile( Q3CONFIG_CFG );
-
-	// not needed for dedicated or standalone
-#if !defined(DEDICATED) && !defined(STANDALONE)
-	if(!com_standalone->integer)
-	{
-		const char *gamedir;
-		gamedir = Cvar_VariableString( "fs_game" );
-		if (UI_usesUniqueCDKey() && gamedir[0] != 0) {
-			Com_WriteCDKey( gamedir, &cl_cdkey[16] );
-		} else {
-			Com_WriteCDKey( BASEGAME, cl_cdkey );
-		}
-	}
-#endif
 }
 
 
Index: code/qcommon/cvar.c
===================================================================
--- code/qcommon/cvar.c	(revision 3378)
+++ code/qcommon/cvar.c	(working copy)
@@ -623,6 +623,8 @@
 /*
 ============
 Cvar_Set
+
+Force cvar to a value.
 ============
 */
 void Cvar_Set( const char *var_name, const char *value) {
@@ -632,6 +634,8 @@
 /*
 ============
 Cvar_SetSafe
+
+Try to set cvar to a value. respects CVAR_ROM, etc.
 ============
 */
 void Cvar_SetSafe( const char *var_name, const char *value )
@@ -920,7 +924,7 @@
 
 	for (var = cvar_vars; var; var = var->next)
 	{
-		if(!var->name || Q_stricmp( var->name, "cl_cdkey" ) == 0)
+		if(!var->name)
 			continue;
 
 		if( var->flags & CVAR_ARCHIVE ) {
Index: code/qcommon/files.c
===================================================================
--- code/qcommon/files.c	(revision 3378)
+++ code/qcommon/files.c	(working copy)
@@ -172,7 +172,7 @@
 
 */
 
-// every time a new demo pk3 file is built, this checksum must be updated.
+// every time a new pk3 file is built, this checksum must be updated.
 // the easiest way to get it is to just run the game and see what it spits out
 #ifndef STANDALONE
 #define	DEMO_PAK0_CHECKSUM	2985612116u
@@ -203,7 +203,6 @@
 // executable with the production windows pak before the mac/linux products
 // hit the shelves a little later
 // NOW defined in build files
-//#define PRE_RELEASE_TADEMO
 
 #define MAX_ZPATH			256
 #define	MAX_SEARCH_PATHS	4096
@@ -222,10 +221,10 @@
 	char			pakBasename[MAX_OSPATH];	// pak0
 	char			pakGamename[MAX_OSPATH];	// baseq3
 	unzFile			handle;						// handle to zip file
-	int				checksum;					// regular checksum
+	int				checksum;					// checksum of the zip
 	int				pure_checksum;				// checksum for pure
 	int				numfiles;					// number of files in pk3
-	int				referenced;					// referenced file flags
+	int				referenced;					// is pk3 referenced?
 	int				hashSize;					// hash table size (power of 2)
 	fileInPack_t*	*hashTable;					// hash table
 	fileInPack_t*	buildBuffer;				// buffer with the filenames etc.
@@ -1167,17 +1166,6 @@
 		return -1;
 	}
 
-	// make sure the q3key file is only readable by the quake3.exe at initialization
-	// any other time the key should only be accessed in memory using the provided functions
-	if(com_fullyInitialized && strstr(filename, "q3key"))
-	{
-		if(file == NULL)
-			return qfalse;
-
-		*file = 0;
-		return -1;
-	}
-
 	if(file == NULL)
 	{
 		// just wants to see if file is there
@@ -2620,6 +2608,7 @@
 			}
 		}
 
+		// if there was a game pk3 or .pk3dir, add mod to list
 		if (nPaks > 0 || nPakDirs > 0) {
 			nLen = strlen(name) + 1;
 			// nLen is the length of the mod path
@@ -2635,6 +2624,7 @@
 				nTotal += nLen + nDescLen;
 				nMods++;
 			} else {
+				Com_Printf( S_COLOR_YELLOW "WARNING: Ran out of space for mods in mod list (%d mods fit in the %d byte buffer)\n", nMods, bufsize );
 				break;
 			}
 		}
@@ -2809,7 +2799,7 @@
 	searchpath_t	*s;
 	int				i;
 
-	Com_Printf ("We are looking in the current search path:\n");
+	Com_Printf ("Current search path:\n");
 	for (s = fs_searchpaths; s; s = s->next) {
 		if (s->pack) {
 			Com_Printf ("%s (%i files)\n", s->pack->pakFilename, s->pack->numfiles);
@@ -3294,10 +3284,6 @@
 #endif
 }
 
-#ifndef STANDALONE
-void Com_AppendCDKey( const char *filename );
-void Com_ReadCDKey( const char *filename );
-#endif
 
 /*
 ================
@@ -3442,14 +3428,6 @@
 		}
 	}
 
-#ifndef STANDALONE
-	if (!com_standalone->integer) {
-		Com_ReadCDKey(BASEGAME);
-		if (fs_gamedirvar->string[0]) {
-			Com_AppendCDKey(fs_gamedirvar->string);
-		}
-	}
-#endif
 
 	// add our commands
 	Cmd_AddCommand ("path", FS_Path_f);
Index: code/qcommon/net_chan.c
===================================================================
--- code/qcommon/net_chan.c	(revision 3378)
+++ code/qcommon/net_chan.c	(working copy)
@@ -123,10 +123,7 @@
 		MSG_WriteShort( &send, qport->integer );
 	}
 
-#ifdef LEGACY_PROTOCOL
-	if(!chan->compat)
-#endif
-		MSG_WriteLong(&send, NETCHAN_GENCHECKSUM(chan->challenge, chan->outgoingSequence));
+	MSG_WriteLong(&send, NETCHAN_GENCHECKSUM(chan->challenge, chan->outgoingSequence));
 
 	// copy the reliable message to the packet first
 	fragmentLength = FRAGMENT_SIZE;
@@ -204,10 +201,7 @@
 	if(chan->sock == NS_CLIENT)
 		MSG_WriteShort(&send, qport->integer);
 
-#ifdef LEGACY_PROTOCOL
-	if(!chan->compat)
-#endif
-		MSG_WriteLong(&send, NETCHAN_GENCHECKSUM(chan->challenge, chan->outgoingSequence));
+	MSG_WriteLong(&send, NETCHAN_GENCHECKSUM(chan->challenge, chan->outgoingSequence));
 
 	chan->outgoingSequence++;
 
@@ -242,7 +236,7 @@
 =================
 */
 qboolean Netchan_Process( netchan_t *chan, msg_t *msg ) {
-	int			sequence;
+	int			sequence, checksum;
 	int			fragmentStart, fragmentLength;
 	qboolean	fragmented;
 
@@ -266,16 +260,11 @@
 		MSG_ReadShort( msg );
 	}
 
-#ifdef LEGACY_PROTOCOL
-	if(!chan->compat)
-#endif
-	{
-		int checksum = MSG_ReadLong(msg);
+	checksum = MSG_ReadLong(msg);
 
-		// UDP spoofing protection
-		if(NETCHAN_GENCHECKSUM(chan->challenge, sequence) != checksum)
-			return qfalse;
-	}
+	// UDP spoofing protection
+	if(NETCHAN_GENCHECKSUM(chan->challenge, sequence) != checksum)
+		return qfalse;
 
 	// read the fragment information
 	if ( fragmented ) {
Index: code/qcommon/q_shared.h
===================================================================
--- code/qcommon/q_shared.h	(revision 3378)
+++ code/qcommon/q_shared.h	(working copy)
@@ -300,8 +300,7 @@
 	ERR_FATAL,					// exit the entire game with a popup window
 	ERR_DROP,					// print to console and disconnect from game
 	ERR_SERVERDISCONNECT,		// don't kill server
-	ERR_DISCONNECT,				// client disconnected from the server
-	ERR_NEED_CD					// pop up the need-cd dialog
+	ERR_DISCONNECT				// client disconnected from the server
 } errorParm_t;
 
 
@@ -1334,7 +1333,6 @@
 typedef enum {
 	CA_UNINITIALIZED,
 	CA_DISCONNECTED, 	// not talking to a server
-	CA_AUTHORIZING,		// not used any more, was checking cd key 
 	CA_CONNECTING,		// sending request packets to the server
 	CA_CHALLENGING,		// sending challenge packets to the server
 	CA_CONNECTED,		// netchan_t established, getting gamestate
@@ -1393,11 +1391,9 @@
 
 
 // server browser sources
-// TTimo: AS_MPLAYER is no longer used
 #define AS_LOCAL			0
-#define AS_MPLAYER		1
-#define AS_GLOBAL			2
-#define AS_FAVORITES	3
+#define AS_GLOBAL			1
+#define AS_FAVORITES	2
 
 
 // cinematic states
@@ -1430,10 +1426,6 @@
 #define SAY_TEAM	1
 #define SAY_TELL	2
 
-#define CDKEY_LEN 16
-#define CDCHKSUM_LEN 2
-
-
 #define LERP( a, b, w ) ( ( a ) * ( 1.0f - ( w ) ) + ( b ) * ( w ) )
 #define LUMA( red, green, blue ) ( 0.2126f * ( red ) + 0.7152f * ( green ) + 0.0722f * ( blue ) )
 
Index: code/qcommon/qcommon.h
===================================================================
--- code/qcommon/qcommon.h	(revision 3378)
+++ code/qcommon/qcommon.h	(working copy)
@@ -32,8 +32,6 @@
 #endif
 #endif
 
-//#define	PRE_RELEASE_DEMO
-
 //============================================================================
 
 //
@@ -775,10 +773,6 @@
 ==============================================================
 */
 
-// centralizing the declarations for cl_cdkey
-// https://zerowing.idsoftware.com/bugzilla/show_bug.cgi?id=470
-extern char cl_cdkey[34];
-
 // returned by Sys_GetProcessorFeatures
 typedef enum
 {
@@ -1014,9 +1008,6 @@
 // things like godmode, noclip, etc, are commands directed to the server,
 // so when they are typed in at the console, they will need to be forwarded.
 
-void CL_CDDialog( void );
-// bring up the "need a cd to play" dialog
-
 void CL_FlushMemory( void );
 // dump all memory on an error
 
@@ -1061,7 +1052,6 @@
 // UI interface
 //
 qboolean UI_GameCommand( void );
-qboolean UI_usesUniqueCDKey(void);
 
 //
 // input interface
Index: code/qcommon/vm.c
===================================================================
--- code/qcommon/vm.c	(revision 3378)
+++ code/qcommon/vm.c	(working copy)
@@ -811,7 +811,7 @@
 	int i;
 
 	if(!vm || !vm->name[0])
-		Com_Error(ERR_FATAL, "VM_Call with NULL vm");
+		Com_Error(ERR_FATAL, "VM_Call with NULL vm (callnum is %d)", callnum);
 
 	oldVM = currentVM;
 	currentVM = vm;
Index: code/renderercommon/tr_image_tga.c
===================================================================
--- code/renderercommon/tr_image_tga.c	(revision 3378)
+++ code/renderercommon/tr_image_tga.c	(working copy)
@@ -313,3 +313,4 @@
 
   ri.FS_FreeFile (buffer.v);
 }
+
Index: code/renderergl2/tr_main.c
===================================================================
--- code/renderergl2/tr_main.c	(revision 3378)
+++ code/renderergl2/tr_main.c	(working copy)
@@ -1564,7 +1564,7 @@
 
 	//
 	// the weapon model must be handled special --
-	// we don't want the hacked weapon position showing in 
+	// we don't want the hacked first person weapon position showing in 
 	// mirrors, because the true body position will already be drawn
 	//
 	if ( (ent->e.renderfx & RF_FIRST_PERSON) && (tr.viewParms.flags & VPF_NOVIEWMODEL)) {
Index: code/renderergl2/tr_mesh.c
===================================================================
--- code/renderergl2/tr_mesh.c	(revision 3378)
+++ code/renderergl2/tr_mesh.c	(working copy)
@@ -291,7 +291,7 @@
 	int             cubemapIndex;
 	qboolean		personalModel;
 
-	// don't add third_person objects if not in a portal
+	// don't add third_person objects if not in a mirror/portal
 	personalModel = (ent->e.renderfx & RF_THIRD_PERSON) && !(tr.viewParms.isPortal 
 	                 || (tr.viewParms.flags & (VPF_SHADOWMAP | VPF_DEPTHSHADOW)));
 
Index: code/renderergl2/tr_model_iqm.c
===================================================================
--- code/renderergl2/tr_model_iqm.c	(revision 3378)
+++ code/renderergl2/tr_model_iqm.c	(working copy)
@@ -1237,7 +1237,7 @@
 	data = tr.currentModel->modelData;
 	surface = data->surfaces;
 
-	// don't add third_person objects if not in a portal
+	// don't add third_person objects if not in a mirror/portal
 	personalModel = (ent->e.renderfx & RF_THIRD_PERSON) && !(tr.viewParms.isPortal
 	                 || (tr.viewParms.flags & (VPF_SHADOWMAP | VPF_DEPTHSHADOW)));
 
Index: code/server/server.h
===================================================================
--- code/server/server.h	(revision 3378)
+++ code/server/server.h	(working copy)
@@ -124,9 +124,6 @@
 typedef struct netchan_buffer_s {
 	msg_t           msg;
 	byte            msgBuffer[MAX_MSGLEN];
-#ifdef LEGACY_PROTOCOL
-	char		clientCommandString[MAX_STRING_CHARS];	// valid command string for SV_Netchan_Encode
-#endif
 	struct netchan_buffer_s *next;
 } netchan_buffer_t;
 
@@ -213,8 +210,6 @@
 // while not allowing a single ip to grab all challenge resources
 #define MAX_CHALLENGES_MULTI (MAX_CHALLENGES / 2)
 
-#define	AUTHORIZE_TIMEOUT	5000
-
 typedef struct {
 	netadr_t	adr;
 	int			challenge;
@@ -221,7 +216,6 @@
 	int			clientChallenge;		// challenge number coming from the client
 	int			time;				// time the last packet was sent to the autherize server
 	int			pingTime;			// time the challenge response was sent to client
-	int			firstTime;			// time the adr was first used, for authorize timeout checks
 	qboolean	wasrefused;
 	qboolean	connected;
 } challenge_t;
@@ -241,9 +235,6 @@
 	int			nextHeartbeatTime;
 	challenge_t	challenges[MAX_CHALLENGES];	// to prevent invalid IPs from connecting
 	netadr_t	redirectAddress;			// for rcon return messages
-#ifndef STANDALONE
-	netadr_t	authorizeAddress;			// authorize server address
-#endif
 	int			masterResolveTime[MAX_MASTER_SERVERS]; // next svs.time that server should do dns lookup for master server
 } serverStatic_t;
 
@@ -291,9 +282,6 @@
 extern	cvar_t	*sv_pure;
 extern	cvar_t	*sv_floodProtect;
 extern	cvar_t	*sv_lanForceRate;
-#ifndef STANDALONE
-extern	cvar_t	*sv_strictAuth;
-#endif
 extern	cvar_t	*sv_banFile;
 
 extern	serverBan_t serverBans[SERVER_MAXBANS];
@@ -367,10 +355,6 @@
 
 void SV_DirectConnect( netadr_t from );
 
-#ifndef STANDALONE
-void SV_AuthorizeIpPacket( netadr_t from );
-#endif
-
 void SV_ExecuteClientMessage( client_t *cl, msg_t *msg );
 void SV_UserinfoChanged( client_t *cl );
 
Index: code/server/sv_ccmds.c
===================================================================
--- code/server/sv_ccmds.c	(revision 3378)
+++ code/server/sv_ccmds.c	(working copy)
@@ -158,7 +158,8 @@
 	char		mapname[MAX_QPATH];
 
 	map = Cmd_Argv(1);
-	if ( !map ) {
+	if ( !*map ) {
+		Com_Printf("Usage: %s <mapname>\n", Cmd_Argv(0) );
 		return;
 	}
 
@@ -511,122 +512,8 @@
 	cl->lastPacketTime = svs.time;	// in case there is a funny zombie
 }
 
-#ifndef STANDALONE
-// these functions require the auth server which of course is not available anymore for stand-alone games.
-
 /*
 ==================
-SV_Ban_f
-
-Ban a user from being able to play on this server through the auth
-server
-==================
-*/
-static void SV_Ban_f( void ) {
-	client_t	*cl;
-
-	// make sure server is running
-	if ( !com_sv_running->integer ) {
-		Com_Printf( "Server is not running.\n" );
-		return;
-	}
-
-	if ( Cmd_Argc() != 2 ) {
-		Com_Printf ("Usage: banUser <player name>\n");
-		return;
-	}
-
-	cl = SV_GetPlayerByHandle();
-
-	if (!cl) {
-		return;
-	}
-
-	if( cl->netchan.remoteAddress.type == NA_LOOPBACK ) {
-		Com_Printf("Cannot kick host player\n");
-		return;
-	}
-
-	// look up the authorize server's IP
-	if ( !svs.authorizeAddress.ip[0] && svs.authorizeAddress.type != NA_BAD ) {
-		Com_Printf( "Resolving %s\n", AUTHORIZE_SERVER_NAME );
-		if ( !NET_StringToAdr( AUTHORIZE_SERVER_NAME, &svs.authorizeAddress, NA_IP ) ) {
-			Com_Printf( "Couldn't resolve address\n" );
-			return;
-		}
-		svs.authorizeAddress.port = BigShort( PORT_AUTHORIZE );
-		Com_Printf( "%s resolved to %i.%i.%i.%i:%i\n", AUTHORIZE_SERVER_NAME,
-			svs.authorizeAddress.ip[0], svs.authorizeAddress.ip[1],
-			svs.authorizeAddress.ip[2], svs.authorizeAddress.ip[3],
-			BigShort( svs.authorizeAddress.port ) );
-	}
-
-	// otherwise send their ip to the authorize server
-	if ( svs.authorizeAddress.type != NA_BAD ) {
-		NET_OutOfBandPrint( NS_SERVER, svs.authorizeAddress,
-			"banUser %i.%i.%i.%i", cl->netchan.remoteAddress.ip[0], cl->netchan.remoteAddress.ip[1], 
-								   cl->netchan.remoteAddress.ip[2], cl->netchan.remoteAddress.ip[3] );
-		Com_Printf("%s was banned from coming back\n", cl->name);
-	}
-}
-
-/*
-==================
-SV_BanNum_f
-
-Ban a user from being able to play on this server through the auth
-server
-==================
-*/
-static void SV_BanNum_f( void ) {
-	client_t	*cl;
-
-	// make sure server is running
-	if ( !com_sv_running->integer ) {
-		Com_Printf( "Server is not running.\n" );
-		return;
-	}
-
-	if ( Cmd_Argc() != 2 ) {
-		Com_Printf ("Usage: banClient <client number>\n");
-		return;
-	}
-
-	cl = SV_GetPlayerByNum();
-	if ( !cl ) {
-		return;
-	}
-	if( cl->netchan.remoteAddress.type == NA_LOOPBACK ) {
-		Com_Printf("Cannot kick host player\n");
-		return;
-	}
-
-	// look up the authorize server's IP
-	if ( !svs.authorizeAddress.ip[0] && svs.authorizeAddress.type != NA_BAD ) {
-		Com_Printf( "Resolving %s\n", AUTHORIZE_SERVER_NAME );
-		if ( !NET_StringToAdr( AUTHORIZE_SERVER_NAME, &svs.authorizeAddress, NA_IP ) ) {
-			Com_Printf( "Couldn't resolve address\n" );
-			return;
-		}
-		svs.authorizeAddress.port = BigShort( PORT_AUTHORIZE );
-		Com_Printf( "%s resolved to %i.%i.%i.%i:%i\n", AUTHORIZE_SERVER_NAME,
-			svs.authorizeAddress.ip[0], svs.authorizeAddress.ip[1],
-			svs.authorizeAddress.ip[2], svs.authorizeAddress.ip[3],
-			BigShort( svs.authorizeAddress.port ) );
-	}
-
-	// otherwise send their ip to the authorize server
-	if ( svs.authorizeAddress.type != NA_BAD ) {
-		NET_OutOfBandPrint( NS_SERVER, svs.authorizeAddress,
-			"banUser %i.%i.%i.%i", cl->netchan.remoteAddress.ip[0], cl->netchan.remoteAddress.ip[1], 
-								   cl->netchan.remoteAddress.ip[2], cl->netchan.remoteAddress.ip[3] );
-		Com_Printf("%s was banned from coming back\n", cl->name);
-	}
-}
-#endif
-
-/*
-==================
 SV_RehashBans_f
 
 Load saved bans from file.
@@ -1527,13 +1414,6 @@
 
 	Cmd_AddCommand ("heartbeat", SV_Heartbeat_f);
 	Cmd_AddCommand ("kick", SV_Kick_f);
-#ifndef STANDALONE
-	if(!com_standalone->integer)
-	{
-		Cmd_AddCommand ("banUser", SV_Ban_f);
-		Cmd_AddCommand ("banClient", SV_BanNum_f);
-	}
-#endif
 	Cmd_AddCommand ("kickbots", SV_KickBots_f);
 	Cmd_AddCommand ("kickall", SV_KickAll_f);
 	Cmd_AddCommand ("kicknum", SV_KickNum_f);
@@ -1546,14 +1426,8 @@
 	Cmd_AddCommand ("sectorlist", SV_SectorList_f);
 	Cmd_AddCommand ("map", SV_Map_f);
 	Cmd_SetCommandCompletionFunc( "map", SV_CompleteMapName );
-#ifndef PRE_RELEASE_DEMO
 	Cmd_AddCommand ("devmap", SV_Map_f);
 	Cmd_SetCommandCompletionFunc( "devmap", SV_CompleteMapName );
-	Cmd_AddCommand ("spmap", SV_Map_f);
-	Cmd_SetCommandCompletionFunc( "spmap", SV_CompleteMapName );
-	Cmd_AddCommand ("spdevmap", SV_Map_f);
-	Cmd_SetCommandCompletionFunc( "spdevmap", SV_CompleteMapName );
-#endif
 	Cmd_AddCommand ("killserver", SV_KillServer_f);
 	if( com_dedicated->integer ) {
 		Cmd_AddCommand ("say", SV_ConSay_f);
Index: code/server/sv_client.c
===================================================================
--- code/server/sv_client.c	(revision 3378)
+++ code/server/sv_client.c	(working copy)
@@ -36,18 +36,9 @@
 flood the server with invalid connection IPs.  With a
 challenge, they must give a valid IP address.
 
-If we are authorizing, a challenge request will cause a packet
-to be sent to the authorize server.
-
-When an authorizeip is returned, a challenge response will be
-sent to that ip.
-
 ioquake3: we added a possibility for clients to add a challenge
 to their packets, to make it more difficult for malicious servers
 to hi-jack client connections.
-Also, the auth stuff is completely disabled for com_standalone games
-as well as IPv6 connections, since there is no way to use the
-v4-only auth server for these new types of connections.
 =================
 */
 void SV_GetChallenge(netadr_t from)
@@ -82,15 +73,8 @@
 	}
 
 	gameName = Cmd_Argv(2);
+	gameMismatch = !*gameName || strcmp(gameName, com_gamename->string) != 0;
 
-#ifdef LEGACY_PROTOCOL
-	// gamename is optional for legacy protocol
-	if (com_legacyprotocol->integer && !*gameName)
-		gameMismatch = qfalse;
-	else
-#endif
-		gameMismatch = !*gameName || strcmp(gameName, com_gamename->string) != 0;
-
 	// reject client if the gamename string sent by the client doesn't match ours
 	if (gameMismatch)
 	{
@@ -135,7 +119,6 @@
 		challenge = &svs.challenges[oldest];
 		challenge->clientChallenge = clientChallenge;
 		challenge->adr = from;
-		challenge->firstTime = svs.time;
 		challenge->connected = qfalse;
 	}
 
@@ -143,141 +126,12 @@
 	challenge->challenge = ( ((unsigned int)rand() << 16) ^ (unsigned int)rand() ) ^ svs.time;
 	challenge->wasrefused = qfalse;
 	challenge->time = svs.time;
-
-#ifndef STANDALONE
-	// Drop the authorize stuff if this client is coming in via v6 as the auth server does not support ipv6.
-	// Drop also for addresses coming in on local LAN and for stand-alone games independent from id's assets.
-	if(challenge->adr.type == NA_IP && !com_standalone->integer && !Sys_IsLANAddress(from))
-	{
-		// look up the authorize server's IP
-		if (svs.authorizeAddress.type == NA_BAD)
-		{
-			Com_Printf( "Resolving %s\n", AUTHORIZE_SERVER_NAME );
-			
-			if (NET_StringToAdr(AUTHORIZE_SERVER_NAME, &svs.authorizeAddress, NA_IP))
-			{
-				svs.authorizeAddress.port = BigShort( PORT_AUTHORIZE );
-				Com_Printf( "%s resolved to %i.%i.%i.%i:%i\n", AUTHORIZE_SERVER_NAME,
-					svs.authorizeAddress.ip[0], svs.authorizeAddress.ip[1],
-					svs.authorizeAddress.ip[2], svs.authorizeAddress.ip[3],
-					BigShort( svs.authorizeAddress.port ) );
-			}
-		}
-
-		// we couldn't contact the auth server, let them in.
-		if(svs.authorizeAddress.type == NA_BAD)
-			Com_Printf("Couldn't resolve auth server address\n");
-
-		// if they have been challenging for a long time and we
-		// haven't heard anything from the authorize server, go ahead and
-		// let them in, assuming the id server is down
-		else if(svs.time - oldestClientTime > AUTHORIZE_TIMEOUT)
-			Com_DPrintf( "authorize server timed out\n" );
-		else
-		{
-			// otherwise send their ip to the authorize server
-			const char *game;
-
-			Com_DPrintf( "sending getIpAuthorize for %s\n", NET_AdrToString( from ));
-		
-			game = Cvar_VariableString( "fs_game" );
-			if (game[0] == 0) {
-				game = BASEGAME;
-			}
-			
-			// the 0 is for backwards compatibility with obsolete sv_allowanonymous flags
-			// getIpAuthorize <challenge> <IP> <game> 0 <auth-flag>
-			NET_OutOfBandPrint( NS_SERVER, svs.authorizeAddress,
-				"getIpAuthorize %i %i.%i.%i.%i %s 0 %s",  challenge->challenge,
-				from.ip[0], from.ip[1], from.ip[2], from.ip[3], game, sv_strictAuth->string );
-			
-			return;
-		}
-	}
-#endif
-
 	challenge->pingTime = svs.time;
 	NET_OutOfBandPrint(NS_SERVER, challenge->adr, "challengeResponse %d %d %d",
 			   challenge->challenge, clientChallenge, com_protocol->integer);
 }
 
-#ifndef STANDALONE
 /*
-====================
-SV_AuthorizeIpPacket
-
-A packet has been returned from the authorize server.
-If we have a challenge adr for that ip, send the
-challengeResponse to it
-====================
-*/
-void SV_AuthorizeIpPacket( netadr_t from ) {
-	int		challenge;
-	int		i;
-	char	*s;
-	char	*r;
-	challenge_t *challengeptr;
-
-	if ( !NET_CompareBaseAdr( from, svs.authorizeAddress ) ) {
-		Com_Printf( "SV_AuthorizeIpPacket: not from authorize server\n" );
-		return;
-	}
-
-	challenge = atoi( Cmd_Argv( 1 ) );
-
-	for (i = 0 ; i < MAX_CHALLENGES ; i++) {
-		if ( svs.challenges[i].challenge == challenge ) {
-			break;
-		}
-	}
-	if ( i == MAX_CHALLENGES ) {
-		Com_Printf( "SV_AuthorizeIpPacket: challenge not found\n" );
-		return;
-	}
-	
-	challengeptr = &svs.challenges[i];
-
-	// send a packet back to the original client
-	challengeptr->pingTime = svs.time;
-	s = Cmd_Argv( 2 );
-	r = Cmd_Argv( 3 );			// reason
-
-	if ( !Q_stricmp( s, "demo" ) ) {
-		// they are a demo client trying to connect to a real server
-		NET_OutOfBandPrint( NS_SERVER, challengeptr->adr, "print\nServer is not a demo server\n" );
-		// clear the challenge record so it won't timeout and let them through
-		Com_Memset( challengeptr, 0, sizeof( *challengeptr ) );
-		return;
-	}
-	if ( !Q_stricmp( s, "accept" ) ) {
-		NET_OutOfBandPrint(NS_SERVER, challengeptr->adr,
-			"challengeResponse %d %d %d", challengeptr->challenge, challengeptr->clientChallenge, com_protocol->integer);
-		return;
-	}
-	if ( !Q_stricmp( s, "unknown" ) ) {
-		if (!r) {
-			NET_OutOfBandPrint( NS_SERVER, challengeptr->adr, "print\nAwaiting CD key authorization\n" );
-		} else {
-			NET_OutOfBandPrint( NS_SERVER, challengeptr->adr, "print\n%s\n", r);
-		}
-		// clear the challenge record so it won't timeout and let them through
-		Com_Memset( challengeptr, 0, sizeof( *challengeptr ) );
-		return;
-	}
-
-	// authorization failed
-	if (!r) {
-		NET_OutOfBandPrint( NS_SERVER, challengeptr->adr, "print\nSomeone is using this CD Key\n" );
-	} else {
-		NET_OutOfBandPrint( NS_SERVER, challengeptr->adr, "print\n%s\n", r );
-	}
-
-	// clear the challenge record so it won't timeout and let them through
-	Com_Memset( challengeptr, 0, sizeof(*challengeptr) );
-}
-#endif
-
-/*
 ==================
 SV_IsBanned
 
@@ -284,7 +138,6 @@
 Check whether a certain address is banned
 ==================
 */
-
 static qboolean SV_IsBanned(netadr_t *from, qboolean isexception)
 {
 	int index;
@@ -1416,13 +1269,6 @@
 			cl->rate = 3000;
 		}
 	}
-	val = Info_ValueForKey (cl->userinfo, "handicap");
-	if (strlen(val)) {
-		i = atoi(val);
-		if (i<=0 || i>100 || strlen(val) > 4) {
-			Info_SetValueForKey( cl->userinfo, "handicap", "100" );
-		}
-	}
 
 	// snaps command
 	val = Info_ValueForKey (cl->userinfo, "snaps");
@@ -1449,16 +1295,9 @@
 	}
 	
 #ifdef USE_VOIP
-#ifdef LEGACY_PROTOCOL
-	if(cl->compat)
-		cl->hasVoip = qfalse;
-	else
+	val = Info_ValueForKey(cl->userinfo, "cl_voipProtocol");
+	cl->hasVoip = !Q_stricmp( val, "opus" );
 #endif
-	{
-		val = Info_ValueForKey(cl->userinfo, "cl_voipProtocol");
-		cl->hasVoip = !Q_stricmp( val, "opus" );
-	}
-#endif
 
 	// TTimo
 	// maintain the IP information
Index: code/server/sv_init.c
===================================================================
--- code/server/sv_init.c	(revision 3378)
+++ code/server/sv_init.c	(working copy)
@@ -683,9 +683,6 @@
 	sv_killserver = Cvar_Get ("sv_killserver", "0", 0);
 	sv_mapChecksum = Cvar_Get ("sv_mapChecksum", "", CVAR_ROM);
 	sv_lanForceRate = Cvar_Get ("sv_lanForceRate", "1", CVAR_ARCHIVE );
-#ifndef STANDALONE
-	sv_strictAuth = Cvar_Get ("sv_strictAuth", "1", CVAR_ARCHIVE );
-#endif
 	sv_banFile = Cvar_Get("sv_banFile", "serverbans.dat", CVAR_ARCHIVE);
 
 	// initialize bot cvars so they are listed and can be set before loading the botlib
Index: code/server/sv_main.c
===================================================================
--- code/server/sv_main.c	(revision 3378)
+++ code/server/sv_main.c	(working copy)
@@ -58,9 +58,6 @@
 cvar_t	*sv_pure;
 cvar_t	*sv_floodProtect;
 cvar_t	*sv_lanForceRate; // dedicated 1 (LAN) server forces local client rates to 99999 (bug #491)
-#ifndef STANDALONE
-cvar_t	*sv_strictAuth;
-#endif
 cvar_t	*sv_banFile;
 
 serverBan_t serverBans[SERVER_MAXBANS];
@@ -196,6 +193,7 @@
 	// and should maybe be addressed later, but this certainly
 	// fixes the problem for now
 	if ( strlen ((char *)message) > 1022 ) {
+		Com_Printf( S_COLOR_YELLOW "WARNING: Dropped long reliable command for client %d: %s\n", (int)( cl - svs.clients ), message );
 		return;
 	}
 
@@ -806,10 +804,6 @@
 		SV_GetChallenge(from);
 	} else if (!Q_stricmp(c, "connect")) {
 		SV_DirectConnect( from );
-#ifndef STANDALONE
-	} else if (!Q_stricmp(c, "ipAuthorize")) {
-		SV_AuthorizeIpPacket( from );
-#endif
 	} else if (!Q_stricmp(c, "rcon")) {
 		SVC_RemoteCommand( from, msg );
 	} else if (!Q_stricmp(c, "disconnect")) {
Index: code/server/sv_net_chan.c
===================================================================
--- code/server/sv_net_chan.c	(revision 3378)
+++ code/server/sv_net_chan.c	(working copy)
@@ -24,116 +24,7 @@
 #include "../qcommon/qcommon.h"
 #include "server.h"
 
-#ifdef LEGACY_PROTOCOL
 /*
-==============
-SV_Netchan_Encode
-
-	// first four bytes of the data are always:
-	long reliableAcknowledge;
-
-==============
-*/
-static void SV_Netchan_Encode(client_t *client, msg_t *msg, const char *clientCommandString)
-{
-	long i, index;
-	byte key, *string;
-	int	srdc, sbit;
-	qboolean soob;
-
-	if ( msg->cursize < SV_ENCODE_START ) {
-		return;
-	}
-
-	srdc = msg->readcount;
-	sbit = msg->bit;
-	soob = msg->oob;
-
-	msg->bit = 0;
-	msg->readcount = 0;
-	msg->oob = qfalse;
-
-	/* reliableAcknowledge = */ MSG_ReadLong(msg);
-
-	msg->oob = soob;
-	msg->bit = sbit;
-	msg->readcount = srdc;
-
-	string = (byte *) clientCommandString;
-	index = 0;
-	// xor the client challenge with the netchan sequence number
-	key = client->challenge ^ client->netchan.outgoingSequence;
-	for (i = SV_ENCODE_START; i < msg->cursize; i++) {
-		// modify the key with the last received and with this message acknowledged client command
-		if (!string[index])
-			index = 0;
-		if (string[index] > 127 || string[index] == '%') {
-			key ^= '.' << (i & 1);
-		}
-		else {
-			key ^= string[index] << (i & 1);
-		}
-		index++;
-		// encode the data with this key
-		*(msg->data + i) = *(msg->data + i) ^ key;
-	}
-}
-
-/*
-==============
-SV_Netchan_Decode
-
-	// first 12 bytes of the data are always:
-	long serverId;
-	long messageAcknowledge;
-	long reliableAcknowledge;
-
-==============
-*/
-static void SV_Netchan_Decode( client_t *client, msg_t *msg ) {
-	int serverId, messageAcknowledge, reliableAcknowledge;
-	int i, index, srdc, sbit;
-	qboolean soob;
-	byte key, *string;
-
-	srdc = msg->readcount;
-	sbit = msg->bit;
-	soob = msg->oob;
-
-	msg->oob = qfalse;
-
-	serverId = MSG_ReadLong(msg);
-	messageAcknowledge = MSG_ReadLong(msg);
-	reliableAcknowledge = MSG_ReadLong(msg);
-
-	msg->oob = soob;
-	msg->bit = sbit;
-	msg->readcount = srdc;
-
-	string = (byte *)client->reliableCommands[ reliableAcknowledge & (MAX_RELIABLE_COMMANDS-1) ];
-	index = 0;
-	//
-	key = client->challenge ^ serverId ^ messageAcknowledge;
-	for (i = msg->readcount + SV_DECODE_START; i < msg->cursize; i++) {
-		// modify the key with the last sent and acknowledged server command
-		if (!string[index])
-			index = 0;
-		if (string[index] > 127 || string[index] == '%') {
-			key ^= '.' << (i & 1);
-		}
-		else {
-			key ^= string[index] << (i & 1);
-		}
-		index++;
-		// decode the data with this key
-		*(msg->data + i) = *(msg->data + i) ^ key;
-	}
-}
-#endif
-
-
-
-/*
 =================
 SV_Netchan_FreeQueue
 =================
@@ -164,11 +55,6 @@
 	Com_DPrintf("#462 Netchan_TransmitNextFragment: popping a queued message for transmit\n");
 	netbuf = client->netchan_start_queue;
 
-#ifdef LEGACY_PROTOCOL
-	if(client->compat)
-		SV_Netchan_Encode(client, &netbuf->msg, netbuf->clientCommandString);
-#endif
-
 	Netchan_Transmit(&client->netchan, netbuf->msg.cursize, netbuf->msg.data);
 
 	// pop from queue
@@ -232,13 +118,6 @@
 		netbuf = (netchan_buffer_t *) Z_Malloc(sizeof(netchan_buffer_t));
 		// store the msg, we can't store it encoded, as the encoding depends on stuff we still have to finish sending
 		MSG_Copy(&netbuf->msg, netbuf->msgBuffer, sizeof( netbuf->msgBuffer ), msg);
-#ifdef LEGACY_PROTOCOL
-		if(client->compat)
-		{
-			Q_strncpyz(netbuf->clientCommandString, client->lastClientCommandString,
-				   sizeof(netbuf->clientCommandString));
-		}
-#endif
 		netbuf->next = NULL;
 		// insert it in the queue, the message will be encoded and sent later
 		*client->netchan_end_queue = netbuf;
@@ -246,10 +125,6 @@
 	}
 	else
 	{
-#ifdef LEGACY_PROTOCOL
-		if(client->compat)
-			SV_Netchan_Encode(client, msg, client->lastClientCommandString);
-#endif
 		Netchan_Transmit( &client->netchan, msg->cursize, msg->data );
 	}
 }
@@ -265,11 +140,6 @@
 	if (!ret)
 		return qfalse;
 
-#ifdef LEGACY_PROTOCOL
-	if(client->compat)
-		SV_Netchan_Decode(client, msg);
-#endif
-
 	return qtrue;
 }
 
Index: code/ui/ui_atoms.c
===================================================================
--- code/ui/ui_atoms.c	(revision 3378)
+++ code/ui/ui_atoms.c	(working copy)
@@ -27,8 +27,6 @@
 **********************************************************************/
 #include "ui_local.h"
 
-qboolean		m_entersound;		// after a frame, so caching won't disrupt the sound
-
 void QDECL Com_Error( int level, const char *error, ... ) {
 	va_list		argptr;
 	char		text[1024];
@@ -51,47 +49,6 @@
 	trap_Print( text );
 }
 
-qboolean newUI = qfalse;
-
-
-/*
-=================
-UI_ClampCvar
-=================
-*/
-float UI_ClampCvar( float min, float max, float value )
-{
-	if ( value < min ) return min;
-	if ( value > max ) return max;
-	return value;
-}
-
-/*
-=================
-UI_StartDemoLoop
-=================
-*/
-void UI_StartDemoLoop( void ) {
-	trap_Cmd_ExecuteText( EXEC_APPEND, "d1\n" );
-}
-
-
-#ifndef MISSIONPACK
-static void NeedCDAction( qboolean result ) {
-	if ( !result ) {
-		trap_Cmd_ExecuteText( EXEC_APPEND, "quit\n" );
-	}
-}
-#endif // MISSIONPACK
-
-#ifndef MISSIONPACK
-static void NeedCDKeyAction( qboolean result ) {
-	if ( !result ) {
-		trap_Cmd_ExecuteText( EXEC_APPEND, "quit\n" );
-	}
-}
-#endif // MISSIONPACK
-
 char *UI_Argv( int arg ) {
 	static char	buffer[MAX_STRING_CHARS];
 
@@ -394,12 +351,6 @@
 		return qtrue;
 	}
 
-
-	if ( Q_stricmp (cmd, "ui_cdkey") == 0 ) {
-		//UI_CDKeyMenu_f();
-		return qtrue;
-	}
-
 	return qfalse;
 }
 
@@ -426,14 +377,6 @@
 	*h *= uiInfo.uiDC.yscale;
 }
 
-void UI_DrawNamedPic( float x, float y, float width, float height, const char *picname ) {
-	qhandle_t	hShader;
-
-	hShader = trap_R_RegisterShaderNoMip( picname );
-	UI_AdjustFrom640( &x, &y, &width, &height );
-	trap_R_DrawStretchPic( x, y, width, height, 0, 0, 1, 1, hShader );
-}
-
 void UI_DrawHandlePic( float x, float y, float w, float h, qhandle_t hShader ) {
 	float	s0;
 	float	s1;
@@ -533,29 +476,3 @@
 
 	trap_R_SetColor( NULL );
 }
-
-void UI_SetColor( const float *rgba ) {
-	trap_R_SetColor( rgba );
-}
-
-void UI_UpdateScreen( void ) {
-	trap_UpdateScreen();
-}
-
-
-void UI_DrawTextBox (int x, int y, int width, int lines)
-{
-	UI_FillRect( x + BIGCHAR_WIDTH/2, y + BIGCHAR_HEIGHT/2, ( width + 1 ) * BIGCHAR_WIDTH, ( lines + 1 ) * BIGCHAR_HEIGHT, colorBlack );
-	UI_DrawRect( x + BIGCHAR_WIDTH/2, y + BIGCHAR_HEIGHT/2, ( width + 1 ) * BIGCHAR_WIDTH, ( lines + 1 ) * BIGCHAR_HEIGHT, colorWhite );
-}
-
-qboolean UI_CursorInRect (int x, int y, int width, int height)
-{
-	if (uiInfo.uiDC.cursorx < x ||
-		uiInfo.uiDC.cursory < y ||
-		uiInfo.uiDC.cursorx > x+width ||
-		uiInfo.uiDC.cursory > y+height)
-		return qfalse;
-
-	return qtrue;
-}
Index: code/ui/ui_gameinfo.c
===================================================================
--- code/ui/ui_gameinfo.c	(revision 3378)
+++ code/ui/ui_gameinfo.c	(working copy)
@@ -38,11 +38,6 @@
 static int		ui_numArenas;
 static char		*ui_arenaInfos[MAX_ARENAS];
 
-#ifndef MISSIONPACK
-static int		ui_numSinglePlayerArenas;
-static int		ui_numSpecialSinglePlayerArenas;
-#endif
-
 /*
 ===============
 UI_ParseInfos
@@ -330,5 +325,5 @@
 	if (info) {
 		return Info_ValueForKey( info, "name" );
 	}
-	return "Sarge";
+	return "Random";
 }
Index: code/ui/ui_local.h
===================================================================
--- code/ui/ui_local.h	(revision 3378)
+++ code/ui/ui_local.h	(working copy)
@@ -32,35 +32,10 @@
 
 // global display context
 
-extern vmCvar_t	ui_ffa_fraglimit;
-extern vmCvar_t	ui_ffa_timelimit;
-
-extern vmCvar_t	ui_tourney_fraglimit;
-extern vmCvar_t	ui_tourney_timelimit;
-
-extern vmCvar_t	ui_team_fraglimit;
-extern vmCvar_t	ui_team_timelimit;
-extern vmCvar_t	ui_team_friendly;
-
-extern vmCvar_t	ui_ctf_capturelimit;
-extern vmCvar_t	ui_ctf_timelimit;
-extern vmCvar_t	ui_ctf_friendly;
-
 extern vmCvar_t	ui_arenasFile;
 extern vmCvar_t	ui_botsFile;
-extern vmCvar_t	ui_spScores1;
-extern vmCvar_t	ui_spScores2;
-extern vmCvar_t	ui_spScores3;
-extern vmCvar_t	ui_spScores4;
-extern vmCvar_t	ui_spScores5;
-extern vmCvar_t	ui_spAwards;
-extern vmCvar_t	ui_spVideos;
 extern vmCvar_t	ui_spSkill;
 
-extern vmCvar_t	ui_spSelection;
-
-extern vmCvar_t	ui_browserMaster;
-extern vmCvar_t	ui_browserGameType;
 extern vmCvar_t	ui_browserShowFull;
 extern vmCvar_t	ui_browserShowEmpty;
 
@@ -69,26 +44,6 @@
 extern vmCvar_t	ui_drawCrosshairNames;
 extern vmCvar_t	ui_marks;
 
-extern vmCvar_t	ui_server1;
-extern vmCvar_t	ui_server2;
-extern vmCvar_t	ui_server3;
-extern vmCvar_t	ui_server4;
-extern vmCvar_t	ui_server5;
-extern vmCvar_t	ui_server6;
-extern vmCvar_t	ui_server7;
-extern vmCvar_t	ui_server8;
-extern vmCvar_t	ui_server9;
-extern vmCvar_t	ui_server10;
-extern vmCvar_t	ui_server11;
-extern vmCvar_t	ui_server12;
-extern vmCvar_t	ui_server13;
-extern vmCvar_t	ui_server14;
-extern vmCvar_t	ui_server15;
-extern vmCvar_t	ui_server16;
-
-extern vmCvar_t	ui_cdkey;
-extern vmCvar_t	ui_cdkeychecked;
-
 extern vmCvar_t	ui_captureLimit;
 extern vmCvar_t	ui_fragLimit;
 extern vmCvar_t	ui_gameType;
@@ -131,181 +86,6 @@
 extern vmCvar_t ui_serverStatusTimeOut;
 
 
-
-//
-// ui_qmenu.c
-//
-
-#define RCOLUMN_OFFSET			( BIGCHAR_WIDTH )
-#define LCOLUMN_OFFSET			(-BIGCHAR_WIDTH )
-
-#define SLIDER_RANGE			10
-#define	MAX_EDIT_LINE			256
-
-#define MAX_MENUDEPTH			8
-#define MAX_MENUITEMS			96
-
-#define MTYPE_NULL				0
-#define MTYPE_SLIDER			1	
-#define MTYPE_ACTION			2
-#define MTYPE_SPINCONTROL		3
-#define MTYPE_FIELD				4
-#define MTYPE_RADIOBUTTON		5
-#define MTYPE_BITMAP			6	
-#define MTYPE_TEXT				7
-#define MTYPE_SCROLLLIST		8
-#define MTYPE_PTEXT				9
-#define MTYPE_BTEXT				10
-
-#define QMF_BLINK				0x00000001
-#define QMF_SMALLFONT			0x00000002
-#define QMF_LEFT_JUSTIFY		0x00000004
-#define QMF_CENTER_JUSTIFY		0x00000008
-#define QMF_RIGHT_JUSTIFY		0x00000010
-#define QMF_NUMBERSONLY			0x00000020	// edit field is only numbers
-#define QMF_HIGHLIGHT			0x00000040
-#define QMF_HIGHLIGHT_IF_FOCUS	0x00000080	// steady focus
-#define QMF_PULSEIFFOCUS		0x00000100	// pulse if focus
-#define QMF_HASMOUSEFOCUS		0x00000200
-#define QMF_NOONOFFTEXT			0x00000400
-#define QMF_MOUSEONLY			0x00000800	// only mouse input allowed
-#define QMF_HIDDEN				0x00001000	// skips drawing
-#define QMF_GRAYED				0x00002000	// grays and disables
-#define QMF_INACTIVE			0x00004000	// disables any input
-#define QMF_NODEFAULTINIT		0x00008000	// skip default initialization
-#define QMF_OWNERDRAW			0x00010000
-#define QMF_PULSE				0x00020000
-#define QMF_LOWERCASE			0x00040000	// edit field is all lower case
-#define QMF_UPPERCASE			0x00080000	// edit field is all upper case
-#define QMF_SILENT				0x00100000
-
-// callback notifications
-#define QM_GOTFOCUS				1
-#define QM_LOSTFOCUS			2
-#define QM_ACTIVATED			3
-
-typedef struct _tag_menuframework
-{
-	int	cursor;
-	int cursor_prev;
-
-	int	nitems;
-	void *items[MAX_MENUITEMS];
-
-	void (*draw) (void);
-	sfxHandle_t (*key) (int key);
-
-	qboolean	wrapAround;
-	qboolean	fullscreen;
-	qboolean	showlogo;
-} menuframework_s;
-
-typedef struct
-{
-	int type;
-	const char *name;
-	int	id;
-	int x, y;
-	int left;
-	int	top;
-	int	right;
-	int	bottom;
-	menuframework_s *parent;
-	int menuPosition;
-	unsigned flags;
-
-	void (*callback)( void *self, int event );
-	void (*statusbar)( void *self );
-	void (*ownerdraw)( void *self );
-} menucommon_s;
-
-typedef struct {
-	int		cursor;
-	int		scroll;
-	int		widthInChars;
-	char	buffer[MAX_EDIT_LINE];
-	int		maxchars;
-} mfield_t;
-
-typedef struct
-{
-	menucommon_s	generic;
-	mfield_t		field;
-} menufield_s;
-
-typedef struct 
-{
-	menucommon_s generic;
-
-	float minvalue;
-	float maxvalue;
-	float curvalue;
-
-	float range;
-} menuslider_s;
-
-typedef struct
-{
-	menucommon_s generic;
-
-	int	oldvalue;
-	int curvalue;
-	int	numitems;
-	int	top;
-		
-	const char **itemnames;
-
-	int width;
-	int height;
-	int	columns;
-	int	separation;
-} menulist_s;
-
-typedef struct
-{
-	menucommon_s generic;
-} menuaction_s;
-
-typedef struct
-{
-	menucommon_s generic;
-	int curvalue;
-} menuradiobutton_s;
-
-typedef struct
-{
-	menucommon_s	generic;
-	char*			focuspic;	
-	char*			errorpic;
-	qhandle_t		shader;
-	qhandle_t		focusshader;
-	int				width;
-	int				height;
-	float*			focuscolor;
-} menubitmap_s;
-
-typedef struct
-{
-	menucommon_s	generic;
-	char*			string;
-	int				style;
-	float*			color;
-} menutext_s;
-
-extern void			Menu_Cache( void );
-extern void			Menu_Focus( menucommon_s *m );
-extern void			Menu_AddItem( menuframework_s *menu, void *item );
-extern void			Menu_AdjustCursor( menuframework_s *menu, int dir );
-extern void			Menu_Draw( menuframework_s *menu );
-extern void			*Menu_ItemAtCursor( menuframework_s *m );
-extern sfxHandle_t	Menu_ActivateItem( menuframework_s *s, menucommon_s* item );
-extern void			Menu_SetCursor( menuframework_s *s, int cursor );
-extern void			Menu_SetCursorToItem( menuframework_s *m, void* ptr );
-extern sfxHandle_t	Menu_DefaultKey( menuframework_s *s, int key );
-extern void			Bitmap_Init( menubitmap_s *b );
-extern void			Bitmap_Draw( menubitmap_s *b );
-extern void			ScrollList_Draw( menulist_s *l );
-extern sfxHandle_t	ScrollList_Key( menulist_s *l, int key );
 extern sfxHandle_t	menu_in_sound;
 extern sfxHandle_t	menu_move_sound;
 extern sfxHandle_t	menu_out_sound;
@@ -338,17 +118,6 @@
 extern char	*ui_medalSounds[];
 
 //
-// ui_mfield.c
-//
-extern void			MField_Clear( mfield_t *edit );
-extern void			MField_KeyDownEvent( mfield_t *edit, int key );
-extern void			MField_CharEvent( mfield_t *edit, int ch );
-extern void			MField_Draw( mfield_t *edit, int x, int y, int style, vec4_t color );
-extern void			MenuField_Init( menufield_s* m );
-extern void			MenuField_Draw( menufield_s *f );
-extern sfxHandle_t	MenuField_Key( menufield_s* m, int* key );
-
-//
 // ui_main.c
 //
 void UI_Report( void );
@@ -360,142 +129,15 @@
 void UI_ClearScores( void );
 void UI_LoadArenas(void);
 void UI_LoadArenasIntoMapList(void);
+void UI_RegisterCvars(void);
+void UI_UpdateCvars(void);
 
 //
-// ui_menu.c
-//
-extern void MainMenu_Cache( void );
-extern void UI_MainMenu(void);
-extern void UI_RegisterCvars( void );
-extern void UI_UpdateCvars( void );
-
-//
-// ui_credits.c
-//
-extern void UI_CreditMenu( void );
-
-//
-// ui_ingame.c
-//
-extern void InGame_Cache( void );
-extern void UI_InGameMenu(void);
-
-//
-// ui_confirm.c
-//
-extern void ConfirmMenu_Cache( void );
-extern void UI_ConfirmMenu( const char *question, void (*draw)( void ), void (*action)( qboolean result ) );
-
-//
-// ui_setup.c
-//
-extern void UI_SetupMenu_Cache( void );
-extern void UI_SetupMenu(void);
-
-//
-// ui_team.c
-//
-extern void UI_TeamMainMenu( void );
-extern void TeamMain_Cache( void );
-
-//
 // ui_connect.c
 //
 extern void UI_DrawConnectScreen( qboolean overlay );
 
 //
-// ui_controls2.c
-//
-extern void UI_ControlsMenu( void );
-extern void Controls_Cache( void );
-
-//
-// ui_demo2.c
-//
-extern void UI_DemosMenu( void );
-extern void Demos_Cache( void );
-
-//
-// ui_cinematics.c
-//
-extern void UI_CinematicsMenu( void );
-extern void UI_CinematicsMenu_f( void );
-extern void UI_CinematicsMenu_Cache( void );
-
-//
-// ui_mods.c
-//
-extern void UI_ModsMenu( void );
-extern void UI_ModsMenu_Cache( void );
-
-//
-// ui_cdkey.c
-//
-extern void UI_CDKeyMenu( void );
-extern void UI_CDKeyMenu_Cache( void );
-extern void UI_CDKeyMenu_f( void );
-
-//
-// ui_playermodel.c
-//
-extern void UI_PlayerModelMenu( void );
-extern void PlayerModel_Cache( void );
-
-//
-// ui_playersettings.c
-//
-extern void UI_PlayerSettingsMenu( void );
-extern void PlayerSettings_Cache( void );
-
-//
-// ui_preferences.c
-//
-extern void UI_PreferencesMenu( void );
-extern void Preferences_Cache( void );
-
-//
-// ui_specifyleague.c
-//
-extern void UI_SpecifyLeagueMenu( void );
-extern void SpecifyLeague_Cache( void );
-
-//
-// ui_specifyserver.c
-//
-extern void UI_SpecifyServerMenu( void );
-extern void SpecifyServer_Cache( void );
-
-//
-// ui_servers2.c
-//
-#define MAX_FAVORITESERVERS 16
-
-extern void UI_ArenaServersMenu( void );
-extern void ArenaServers_Cache( void );
-
-//
-// ui_startserver.c
-//
-extern void UI_StartServerMenu( qboolean multiplayer );
-extern void StartServer_Cache( void );
-extern void ServerOptions_Cache( void );
-extern void UI_BotSelectMenu( char *bot );
-extern void UI_BotSelectMenu_Cache( void );
-
-//
-// ui_serverinfo.c
-//
-extern void UI_ServerInfoMenu( void );
-extern void ServerInfo_Cache( void );
-
-//
-// ui_video.c
-//
-extern void UI_GraphicsOptionsMenu( void );
-extern void GraphicsOptions_Cache( void );
-extern void DriverInfo_Cache( void );
-
-//
 // ui_players.c
 //
 
@@ -576,34 +218,7 @@
 void UI_PlayerInfo_SetInfo( playerInfo_t *pi, int legsAnim, int torsoAnim, vec3_t viewAngles, vec3_t moveAngles, weapon_t weaponNum, qboolean chat );
 qboolean UI_RegisterClientModelname( playerInfo_t *pi, const char *modelSkinName , const char *headName, const char *teamName);
 
-//
-// ui_atoms.c
-//
-// this is only used in the old ui, the new ui has its own version
-typedef struct {
-	int					frametime;
-	int					realtime;
-	int					cursorx;
-	int					cursory;
-	glconfig_t 	glconfig;
-	qboolean		debug;
-	qhandle_t		whiteShader;
-	qhandle_t		menuBackShader;
-	qhandle_t		menuBackNoLogoShader;
-	qhandle_t		charset;
-	qhandle_t		charsetProp;
-	qhandle_t		charsetPropGlow;
-	qhandle_t		charsetPropB;
-	qhandle_t		cursor;
-	qhandle_t		rb_on;
-	qhandle_t		rb_off;
-	float				scale;
-	float				bias;
-	qboolean		demoversion;
-	qboolean		firstdraw;
-} uiStatic_t;
 
-
 // new ui stuff
 #define UI_NUMFX 7
 #define MAX_HEADS 64
@@ -852,7 +467,6 @@
 extern void			UI_MouseEvent( int dx, int dy );
 extern void			UI_Refresh( int realtime );
 extern qboolean		UI_ConsoleCommand( int realTime );
-extern float		UI_ClampCvar( float min, float max, float value );
 extern void			UI_DrawNamedPic( float x, float y, float width, float height, const char *picname );
 extern void			UI_DrawHandlePic( float x, float y, float w, float h, qhandle_t hShader ); 
 extern void			UI_FillRect( float x, float y, float width, float height, const float *color );
@@ -859,8 +473,6 @@
 extern void			UI_DrawRect( float x, float y, float width, float height, const float *color );
 extern void     UI_DrawTopBottom(float x, float y, float w, float h);
 extern void     UI_DrawSides(float x, float y, float w, float h);
-extern void			UI_UpdateScreen( void );
-extern void			UI_SetColor( const float *rgba );
 extern void			UI_LerpColor(vec4_t a, vec4_t b, vec4_t c, float t);
 extern void			UI_DrawBannerString( int x, int y, const char* str, int style, vec4_t color );
 extern float		UI_ProportionalSizeScale( int style );
@@ -868,13 +480,9 @@
 extern int			UI_ProportionalStringWidth( const char* str );
 extern void			UI_DrawString( int x, int y, const char* str, int style, vec4_t color );
 extern void			UI_DrawChar( int x, int y, int ch, int style, vec4_t color );
-extern qboolean 	UI_CursorInRect (int x, int y, int width, int height);
 extern void			UI_AdjustFrom640( float *x, float *y, float *w, float *h );
-extern void			UI_DrawTextBox (int x, int y, int width, int lines);
 extern qboolean		UI_IsFullscreen( void );
 extern void			UI_SetActiveMenu( uiMenuCommand_t menu );
-extern void			UI_PushMenu ( menuframework_s *menu );
-extern void			UI_PopMenu (void);
 extern void			UI_ForceMenuOff (void);
 extern char			*UI_Argv( int arg );
 extern char			*UI_Cvar_VariableString( const char *var_name );
@@ -882,37 +490,9 @@
 extern void			UI_ClearClipRegion( void );
 extern void			UI_Refresh( int time );
 extern void			UI_KeyEvent( int key );
-extern void			UI_StartDemoLoop( void );
-extern qboolean		m_entersound;
 void UI_LoadBestScores(const char *map, int game);
-extern uiStatic_t	uis;
 
 //
-// ui_spLevel.c
-//
-void UI_SPLevelMenu_Cache( void );
-void UI_SPLevelMenu( void );
-void UI_SPLevelMenu_f( void );
-void UI_SPLevelMenu_ReInit( void );
-
-//
-// ui_spArena.c
-//
-void UI_SPArena_Start( const char *arenaInfo );
-
-//
-// ui_spPostgame.c
-//
-void UI_SPPostgameMenu_Cache( void );
-void UI_SPPostgameMenu_f( void );
-
-//
-// ui_spSkill.c
-//
-void UI_SPSkillMenu( const char *arenaInfo );
-void UI_SPSkillMenu_Cache( void );
-
-//
 // ui_syscalls.c
 //
 void			trap_Print( const char *string );
@@ -982,8 +562,6 @@
 int				trap_LAN_ServerStatus( const char *serverAddress, char *serverStatus, int maxLen );
 int				trap_LAN_CompareServers( int source, int sortKey, int sortDir, int s1, int s2 );
 int				trap_MemoryRemaining( void );
-void			trap_GetCDKey( char *buf, int buflen );
-void			trap_SetCDKey( char *buf );
 void			trap_R_RegisterFont(const char *pFontname, int pointSize, fontInfo_t *font);
 void			trap_S_StopBackgroundTrack( void );
 void			trap_S_StartBackgroundTrack( const char *intro, const char *loop);
@@ -994,78 +572,10 @@
 void			trap_CIN_SetExtents (int handle, int x, int y, int w, int h);
 int				trap_RealTime(qtime_t *qtime);
 void			trap_R_RemapShader( const char *oldShader, const char *newShader, const char *timeOffset );
-qboolean		trap_VerifyCDKey( const char *key, const char *chksum);
 
-void			trap_SetPbClStatus( int status );
-
 //
-// ui_addbots.c
-//
-void UI_AddBots_Cache( void );
-void UI_AddBotsMenu( void );
-
-//
-// ui_removebots.c
-//
-void UI_RemoveBots_Cache( void );
-void UI_RemoveBotsMenu( void );
-
-//
-// ui_teamorders.c
-//
-extern void UI_TeamOrdersMenu( void );
-extern void UI_TeamOrdersMenu_f( void );
-extern void UI_TeamOrdersMenu_Cache( void );
-
-//
-// ui_loadconfig.c
-//
-void UI_LoadConfig_Cache( void );
-void UI_LoadConfigMenu( void );
-
-//
-// ui_saveconfig.c
-//
-void UI_SaveConfigMenu_Cache( void );
-void UI_SaveConfigMenu( void );
-
-//
-// ui_display.c
-//
-void UI_DisplayOptionsMenu_Cache( void );
-void UI_DisplayOptionsMenu( void );
-
-//
-// ui_sound.c
-//
-void UI_SoundOptionsMenu_Cache( void );
-void UI_SoundOptionsMenu( void );
-
-//
-// ui_network.c
-//
-void UI_NetworkOptionsMenu_Cache( void );
-void UI_NetworkOptionsMenu( void );
-
-//
 // ui_gameinfo.c
 //
-typedef enum {
-	AWARD_ACCURACY,
-	AWARD_IMPRESSIVE,
-	AWARD_EXCELLENT,
-	AWARD_GAUNTLET,
-	AWARD_FRAGS,
-	AWARD_PERFECT
-} awardType_t;
-
-const char *UI_GetArenaInfoByNumber( int num );
-const char *UI_GetArenaInfoByMap( const char *map );
-const char *UI_GetSpecialArenaInfo( const char *tag );
-int UI_GetNumArenas( void );
-int UI_GetNumSPArenas( void );
-int UI_GetNumSPTiers( void );
-
 char *UI_GetBotInfoByNumber( int num );
 char *UI_GetBotInfoByName( const char *name );
 int UI_GetNumBots( void );
@@ -1072,40 +582,7 @@
 void UI_LoadBots( void );
 char *UI_GetBotNameByNumber( int num );
 
-void UI_GetBestScore( int level, int *score, int *skill );
-void UI_SetBestScore( int level, int score );
-int UI_TierCompleted( int levelWon );
-qboolean UI_ShowTierVideo( int tier );
-qboolean UI_CanShowTierVideo( int tier );
-int  UI_GetCurrentGame( void );
-void UI_NewGame( void );
-void UI_LogAwardData( int award, int data );
-int UI_GetAwardLevel( int award );
 
-void UI_SPUnlock_f( void );
-void UI_SPUnlockMedals_f( void );
-
-void UI_InitGameinfo( void );
-
-//
-// ui_login.c
-//
-void Login_Cache( void );
-void UI_LoginMenu( void );
-
-//
-// ui_signup.c
-//
-void Signup_Cache( void );
-void UI_SignupMenu( void );
-
-//
-// ui_rankstatus.c
-//
-void RankStatus_Cache( void );
-void UI_RankStatusMenu( void );
-
-
 // new ui 
 
 #define ASSET_BACKGROUND "uiBackground"
Index: code/ui/ui_main.c
===================================================================
--- code/ui/ui_main.c	(revision 3378)
+++ code/ui/ui_main.c	(working copy)
@@ -29,7 +29,6 @@
 */
 
 // use this to get a demo build without an explicit demo build, i.e. to get the demo ui files to build
-//#define PRE_RELEASE_TADEMO
 
 #include "ui_local.h"
 
@@ -95,10 +94,6 @@
 	"UDP6"
 };
 
-#ifndef MISSIONPACK
-static char quake3worldMessage[] = "Visit www.quake3world.com - News, Community, Events, Files";
-#endif
-
 static int gamecodetoui[] = {4,2,3,0,5,1,6};
 static int uitogamecode[] = {4,6,2,3,1,5,7};
 
@@ -179,8 +174,6 @@
 	  case UI_DRAW_CONNECT_SCREEN:
 		  UI_DrawConnectScreen( arg0 );
 		  return 0;
-	  case UI_HASUNIQUECDKEY: // mod authors need to observe this
-	    return qtrue; // change this to qfalse for mods!
 
 	}
 
@@ -599,7 +592,7 @@
 		if ( !total ) {
 			total = 1;
 		}
-		uiInfo.uiDC.FPS = 1000 * UI_FPS_FRAMES / total;
+		uiInfo.uiDC.FPS = 1000 * UI_FPS_FRAMES / (float)total;
 	}
 
 
@@ -618,7 +611,7 @@
 	} 
 	
 	// draw cursor
-	UI_SetColor( NULL );
+	trap_R_SetColor( NULL );
 	if (Menu_Count() > 0 && (trap_Key_GetCatcher() & KEYCATCH_UI)) {
 		UI_DrawHandlePic( uiInfo.uiDC.cursorx-16, uiInfo.uiDC.cursory-16, 32, 32, uiInfo.uiDC.Assets.cursor);
 	}
@@ -969,12 +962,8 @@
 
 	String_Init();
 
-#ifdef PRE_RELEASE_TADEMO
-	UI_ParseGameInfo("demogameinfo.txt");
-#else
 	UI_ParseGameInfo("gameinfo.txt");
 	UI_LoadArenas();
-#endif
 
 	UI_LoadMenus(menuSet, qtrue);
 	Menus_CloseAll();
@@ -1018,9 +1007,6 @@
 
 
 static const char *handicapValues[] = {"None","95","90","85","80","75","70","65","60","55","50","45","40","35","30","25","20","15","10","5",NULL};
-#ifndef MISSIONPACK
-static int numHandicaps = ARRAY_LEN(handicapValues);
-#endif
 
 static void UI_DrawHandicap(rectDef_t *rect, float scale, vec4_t color, int textStyle) {
   int i, h;
@@ -1419,13 +1405,6 @@
 }
 
 
-#ifndef MISSIONPACK
-static const char *UI_OpponentLeaderName(void) {
-  int i = UI_TeamIndexFromName(UI_Cvar_VariableString("ui_opponentName"));
-	return uiInfo.teamList[i].teamMembers[0];
-}
-#endif
-
 static const char *UI_AIFromName(const char *name) {
 	int j;
 	for (j = 0; j < uiInfo.aliasCount; j++) {
@@ -1433,55 +1412,17 @@
 			return uiInfo.aliasList[j].ai;
 		}
 	}
-	return "James";
-}
-
-#ifndef MISSIONPACK
-static const int UI_AIIndex(const char *name) {
-	int j;
 	for (j = 0; j < uiInfo.characterCount; j++) {
-		if (Q_stricmp(name, uiInfo.characterList[j].name) == 0) {
-			return j;
+		if (Q_stricmp(uiInfo.characterList[j].name, name) == 0) {
+			return uiInfo.characterList[j].name;
 		}
 	}
-	return 0;
+	// Name is listed in team list but not in alias or characters list.
+	Com_Printf( S_COLOR_YELLOW "WARNING: Unknown team character '%s'.\n", name );
+	return name;
 }
-#endif
 
-#ifndef MISSIONPACK
-static const int UI_AIIndexFromName(const char *name) {
-	int j;
-	for (j = 0; j < uiInfo.aliasCount; j++) {
-		if (Q_stricmp(uiInfo.aliasList[j].name, name) == 0) {
-			return UI_AIIndex(uiInfo.aliasList[j].ai);
-		}
-	}
-	return 0;
-}
-#endif
 
-
-#ifndef MISSIONPACK
-static const char *UI_OpponentLeaderHead(void) {
-	const char *leader = UI_OpponentLeaderName();
-	return UI_AIFromName(leader);
-}
-#endif
-
-#ifndef MISSIONPACK
-static const char *UI_OpponentLeaderModel(void) {
-	int i;
-	const char *head = UI_OpponentLeaderHead();
-	for (i = 0; i < uiInfo.characterCount; i++) {
-		if (Q_stricmp(head, uiInfo.characterList[i].name) == 0) {
-			return uiInfo.characterList[i].base;
-		}
-	}
-	return "James";
-}
-#endif
-
-
 static qboolean updateOpponentModel = qtrue;
 static void UI_DrawOpponent(rectDef_t *rect) {
   static playerInfo_t info2;
@@ -3221,41 +3162,8 @@
 			trap_Cmd_ExecuteText( EXEC_APPEND, "exec default.cfg\n");
 			trap_Cmd_ExecuteText( EXEC_APPEND, "cvar_restart\n");
 			Controls_SetDefaults();
-#ifdef CINEMATICS_INTRO
 			trap_Cvar_SetValue("com_introPlayed", 1 );
-#endif
 			trap_Cmd_ExecuteText( EXEC_APPEND, "vid_restart\n" );
-		} else if (Q_stricmp(name, "getCDKey") == 0) {
-			char out[17];
-			trap_GetCDKey(buff, 17);
-			trap_Cvar_Set("cdkey1", "");
-			trap_Cvar_Set("cdkey2", "");
-			trap_Cvar_Set("cdkey3", "");
-			trap_Cvar_Set("cdkey4", "");
-			if (strlen(buff) == CDKEY_LEN) {
-				Q_strncpyz(out, buff, 5);
-				trap_Cvar_Set("cdkey1", out);
-				Q_strncpyz(out, buff + 4, 5);
-				trap_Cvar_Set("cdkey2", out);
-				Q_strncpyz(out, buff + 8, 5);
-				trap_Cvar_Set("cdkey3", out);
-				Q_strncpyz(out, buff + 12, 5);
-				trap_Cvar_Set("cdkey4", out);
-			}
-
-		} else if (Q_stricmp(name, "verifyCDKey") == 0) {
-			buff[0] = '\0';
-			Q_strcat(buff, 1024, UI_Cvar_VariableString("cdkey1")); 
-			Q_strcat(buff, 1024, UI_Cvar_VariableString("cdkey2")); 
-			Q_strcat(buff, 1024, UI_Cvar_VariableString("cdkey3")); 
-			Q_strcat(buff, 1024, UI_Cvar_VariableString("cdkey4")); 
-			trap_Cvar_Set("cdkey", buff);
-			if (trap_VerifyCDKey(buff, UI_Cvar_VariableString("cdkeychecksum"))) {
-				trap_Cvar_Set("ui_cdkeyvalid", "CD Key Appears to be valid.");
-				trap_SetCDKey(buff);
-			} else {
-				trap_Cvar_Set("ui_cdkeyvalid", "CD Key does not appear to be valid.");
-			}
 		} else if (Q_stricmp(name, "loadArenas") == 0) {
 			UI_LoadArenasIntoMapList();
 			UI_MapCountByGameType(qfalse);
@@ -3267,11 +3175,7 @@
 		} else if (Q_stricmp(name, "clearError") == 0) {
 			trap_Cvar_Set("com_errorMessage", "");
 		} else if (Q_stricmp(name, "loadGameInfo") == 0) {
-#ifdef PRE_RELEASE_TADEMO
-			UI_ParseGameInfo("demogameinfo.txt");
-#else
 			UI_ParseGameInfo("gameinfo.txt");
-#endif
 			UI_LoadBestScores(uiInfo.mapList[ui_currentMap.integer].mapLoadName, uiInfo.gameTypes[ui_gameType.integer].gtEnum);
 		} else if (Q_stricmp(name, "resetScores") == 0) {
 			UI_ClearScores();
@@ -3527,12 +3431,7 @@
 			if (String_Parse(args, &name2)) {
 				UI_Update(name2);
 			}
-		} else if (Q_stricmp(name, "setPbClStatus") == 0) {
-			int stat;
-			if ( Int_Parse( args, &stat ) )
-				trap_SetPbClStatus( stat );
-		}
-		else {
+		} else {
 			Com_Printf("unknown UI script %s\n", name);
 		}
 	}
@@ -3872,6 +3771,7 @@
 	{"protocol", ""},
 	{"timelimit", ""},
 	{"fraglimit", ""},
+	{"capturelimit", ""},
 	{NULL, NULL}
 };
 
@@ -4320,7 +4220,7 @@
 		return UI_SelectedMap(index, &actual);
 	} else if (feederID == FEEDER_SERVERS) {
 		if (index >= 0 && index < uiInfo.serverStatus.numDisplayServers) {
-			int ping, game, punkbuster;
+			int ping, game;
 			if (lastColumn != column || lastTime > uiInfo.uiDC.realTime + 5000) {
 				trap_LAN_GetServerInfo(UI_SourceForLAN(), uiInfo.serverStatus.displayServers[index], info, MAX_STRING_CHARS);
 				lastColumn = column;
@@ -4370,13 +4270,6 @@
 					} else {
 						return Info_ValueForKey(info, "ping");
 					}
-				case SORT_PUNKBUSTER:
-					punkbuster = atoi(Info_ValueForKey(info, "punkbuster"));
-					if ( punkbuster ) {
-						return "Yes";
-					} else {
-						return "No";
-					}
 			}
 		}
 	} else if (feederID == FEEDER_SERVERSTATUS) {
@@ -4741,7 +4634,17 @@
     }
 
   }
+}
 
+void UI_ValidateTeams( void ) {
+	int i, j;
+
+	// Check for unknown team characters
+	for (i = 0; i < uiInfo.teamCount; i++) {
+		for (j = 0; j < TEAM_MEMBERS; j++) {
+			UI_AIFromName(uiInfo.teamList[i].teamMembers[j]);
+		}
+	}
 }
 
 
@@ -4932,12 +4835,6 @@
 	}
 }
 
-#ifndef MISSIONPACK
-static int UI_OwnerDraw_Width(int ownerDraw) {
-  return 0;
-}
-#endif
-
 static int UI_PlayCinematic(const char *name, float x, float y, float w, float h) {
   return trap_CIN_PlayCinematic(name, x, y, w, h, (CIN_loop | CIN_silent));
 }
@@ -5094,7 +4991,7 @@
 
   //UI_Load();
 	uiInfo.uiDC.registerShaderNoMip = &trap_R_RegisterShaderNoMip;
-	uiInfo.uiDC.setColor = &UI_SetColor;
+	uiInfo.uiDC.setColor = &trap_R_SetColor;
 	uiInfo.uiDC.drawHandlePic = &UI_DrawHandlePic;
 	uiInfo.uiDC.drawStretchPic = &trap_R_DrawStretchPic;
 	uiInfo.uiDC.drawText = &Text_Paint;
@@ -5156,15 +5053,11 @@
   uiInfo.characterCount = 0;
   uiInfo.aliasCount = 0;
 
-#ifdef PRE_RELEASE_TADEMO
-	UI_ParseTeamInfo("demoteaminfo.txt");
-	UI_ParseGameInfo("demogameinfo.txt");
-#else
 	UI_ParseTeamInfo("teaminfo.txt");
 	UI_LoadTeams();
 	UI_ParseGameInfo("gameinfo.txt");
 	UI_LoadArenas();
-#endif
+	UI_ValidateTeams();
 
 	menuSet = UI_Cvar_VariableString("ui_menuFiles");
 	if (menuSet == NULL || menuSet[0] == '\0') {
@@ -5286,18 +5179,19 @@
 
 	// this should be the ONLY way the menu system is brought up
 	// ensure minimum menu data is cached
-  if (Menu_Count() > 0) {
-		vec3_t v;
-		v[0] = v[1] = v[2] = 0;
-	  switch ( menu ) {
-	  case UIMENU_NONE:
+	if (Menu_Count() <= 0) {
+		return;
+	}
+
+	switch ( menu ) {
+		case UIMENU_NONE:
 			trap_Key_SetCatcher( trap_Key_GetCatcher() & ~KEYCATCH_UI );
 			trap_Key_ClearStates();
 			trap_Cvar_SetValue( "cl_paused", 0 );
 			Menus_CloseAll();
 
-		  return;
-	  case UIMENU_MAIN:
+			return;
+		case UIMENU_MAIN:
 			trap_Cvar_SetValue( "sv_killserver", 1 );
 			trap_Key_SetCatcher( KEYCATCH_UI );
 			//trap_S_StartLocalSound( trap_S_RegisterSound("sound/misc/menu_background.wav", qfalse) , CHAN_LOCAL_SOUND );
@@ -5315,24 +5209,12 @@
 					trap_Cvar_Set("com_errorMessage", "");
 				}
 			}
-		  return;
-	  case UIMENU_TEAM:
+			return;
+		case UIMENU_TEAM:
 			trap_Key_SetCatcher( KEYCATCH_UI );
-      Menus_ActivateByName("team");
-		  return;
-	  case UIMENU_NEED_CD:
-			// no cd check in TA
-			//trap_Key_SetCatcher( KEYCATCH_UI );
-      //Menus_ActivateByName("needcd");
-		  //UI_ConfirmMenu( "Insert the CD", NULL, NeedCDAction );
-		  return;
-	  case UIMENU_BAD_CD_KEY:
-			// no cd check in TA
-			//trap_Key_SetCatcher( KEYCATCH_UI );
-      //Menus_ActivateByName("badcd");
-		  //UI_ConfirmMenu( "Bad CD Key", NULL, NeedCDKeyAction );
-		  return;
-	  case UIMENU_POSTGAME:
+			Menus_ActivateByName("team");
+			return;
+		case UIMENU_POSTGAME:
 			trap_Cvar_SetValue( "sv_killserver", 1 );
 			trap_Key_SetCatcher( KEYCATCH_UI );
 			if (uiInfo.inGameLoad) {
@@ -5340,17 +5222,17 @@
 			}
 			Menus_CloseAll();
 			Menus_ActivateByName("endofgame");
-		  //UI_ConfirmMenu( "Bad CD Key", NULL, NeedCDKeyAction );
-		  return;
-	  case UIMENU_INGAME:
-		  trap_Cvar_SetValue( "cl_paused", 1 );
+			return;
+		case UIMENU_INGAME:
+			trap_Cvar_SetValue( "cl_paused", 1 );
 			trap_Key_SetCatcher( KEYCATCH_UI );
 			UI_BuildPlayerList();
 			Menus_CloseAll();
 			Menus_ActivateByName("ingame");
-		  return;
-	  }
-  }
+			return;
+		default:
+			Com_Printf( "UI_SetActiveMenu: unknown enum %d\n", menu );
+	}
 }
 
 qboolean _UI_IsFullscreen( void ) {
@@ -5470,7 +5352,7 @@
 
 	leftWidth = 320;
 
-	UI_SetColor(colorWhite);
+	trap_R_SetColor(colorWhite);
 	Text_PaintCenter(centerPoint, yStart + 112, scale, colorWhite, dlText, 0);
 	Text_PaintCenter(centerPoint, yStart + 192, scale, colorWhite, etaText, 0);
 	Text_PaintCenter(centerPoint, yStart + 248, scale, colorWhite, xferText, 0);
@@ -5628,35 +5510,10 @@
 	int			cvarFlags;
 } cvarTable_t;
 
-vmCvar_t	ui_ffa_fraglimit;
-vmCvar_t	ui_ffa_timelimit;
-
-vmCvar_t	ui_tourney_fraglimit;
-vmCvar_t	ui_tourney_timelimit;
-
-vmCvar_t	ui_team_fraglimit;
-vmCvar_t	ui_team_timelimit;
-vmCvar_t	ui_team_friendly;
-
-vmCvar_t	ui_ctf_capturelimit;
-vmCvar_t	ui_ctf_timelimit;
-vmCvar_t	ui_ctf_friendly;
-
 vmCvar_t	ui_arenasFile;
 vmCvar_t	ui_botsFile;
-vmCvar_t	ui_spScores1;
-vmCvar_t	ui_spScores2;
-vmCvar_t	ui_spScores3;
-vmCvar_t	ui_spScores4;
-vmCvar_t	ui_spScores5;
-vmCvar_t	ui_spAwards;
-vmCvar_t	ui_spVideos;
 vmCvar_t	ui_spSkill;
 
-vmCvar_t	ui_spSelection;
-
-vmCvar_t	ui_browserMaster;
-vmCvar_t	ui_browserGameType;
 vmCvar_t	ui_browserShowFull;
 vmCvar_t	ui_browserShowEmpty;
 
@@ -5665,25 +5522,6 @@
 vmCvar_t	ui_drawCrosshairNames;
 vmCvar_t	ui_marks;
 
-vmCvar_t	ui_server1;
-vmCvar_t	ui_server2;
-vmCvar_t	ui_server3;
-vmCvar_t	ui_server4;
-vmCvar_t	ui_server5;
-vmCvar_t	ui_server6;
-vmCvar_t	ui_server7;
-vmCvar_t	ui_server8;
-vmCvar_t	ui_server9;
-vmCvar_t	ui_server10;
-vmCvar_t	ui_server11;
-vmCvar_t	ui_server12;
-vmCvar_t	ui_server13;
-vmCvar_t	ui_server14;
-vmCvar_t	ui_server15;
-vmCvar_t	ui_server16;
-
-vmCvar_t	ui_cdkeychecked;
-
 vmCvar_t	ui_redteam;
 vmCvar_t	ui_redteam1;
 vmCvar_t	ui_redteam2;
@@ -5744,40 +5582,13 @@
 vmCvar_t	ui_Q3Model;
 vmCvar_t	ui_hudFiles;
 vmCvar_t	ui_recordSPDemo;
-vmCvar_t	ui_realCaptureLimit;
-vmCvar_t	ui_realWarmUp;
 vmCvar_t	ui_serverStatusTimeOut;
 
 static cvarTable_t		cvarTable[] = {
-	{ &ui_ffa_fraglimit, "ui_ffa_fraglimit", "20", CVAR_ARCHIVE },
-	{ &ui_ffa_timelimit, "ui_ffa_timelimit", "0", CVAR_ARCHIVE },
-
-	{ &ui_tourney_fraglimit, "ui_tourney_fraglimit", "0", CVAR_ARCHIVE },
-	{ &ui_tourney_timelimit, "ui_tourney_timelimit", "15", CVAR_ARCHIVE },
-
-	{ &ui_team_fraglimit, "ui_team_fraglimit", "0", CVAR_ARCHIVE },
-	{ &ui_team_timelimit, "ui_team_timelimit", "20", CVAR_ARCHIVE },
-	{ &ui_team_friendly, "ui_team_friendly",  "1", CVAR_ARCHIVE },
-
-	{ &ui_ctf_capturelimit, "ui_ctf_capturelimit", "8", CVAR_ARCHIVE },
-	{ &ui_ctf_timelimit, "ui_ctf_timelimit", "30", CVAR_ARCHIVE },
-	{ &ui_ctf_friendly, "ui_ctf_friendly",  "0", CVAR_ARCHIVE },
-
 	{ &ui_arenasFile, "g_arenasFile", "", CVAR_INIT|CVAR_ROM },
 	{ &ui_botsFile, "g_botsFile", "", CVAR_INIT|CVAR_ROM },
-	{ &ui_spScores1, "g_spScores1", "", CVAR_ARCHIVE },
-	{ &ui_spScores2, "g_spScores2", "", CVAR_ARCHIVE },
-	{ &ui_spScores3, "g_spScores3", "", CVAR_ARCHIVE },
-	{ &ui_spScores4, "g_spScores4", "", CVAR_ARCHIVE },
-	{ &ui_spScores5, "g_spScores5", "", CVAR_ARCHIVE },
-	{ &ui_spAwards, "g_spAwards", "", CVAR_ARCHIVE },
-	{ &ui_spVideos, "g_spVideos", "", CVAR_ARCHIVE },
 	{ &ui_spSkill, "g_spSkill", "2", CVAR_ARCHIVE },
 
-	{ &ui_spSelection, "ui_spSelection", "", CVAR_ROM },
-
-	{ &ui_browserMaster, "ui_browserMaster", "0", CVAR_ARCHIVE },
-	{ &ui_browserGameType, "ui_browserGameType", "0", CVAR_ARCHIVE },
 	{ &ui_browserShowFull, "ui_browserShowFull", "1", CVAR_ARCHIVE },
 	{ &ui_browserShowEmpty, "ui_browserShowEmpty", "1", CVAR_ARCHIVE },
 
@@ -5786,23 +5597,6 @@
 	{ &ui_drawCrosshairNames, "cg_drawCrosshairNames", "1", CVAR_ARCHIVE },
 	{ &ui_marks, "cg_marks", "1", CVAR_ARCHIVE },
 
-	{ &ui_server1, "server1", "", CVAR_ARCHIVE },
-	{ &ui_server2, "server2", "", CVAR_ARCHIVE },
-	{ &ui_server3, "server3", "", CVAR_ARCHIVE },
-	{ &ui_server4, "server4", "", CVAR_ARCHIVE },
-	{ &ui_server5, "server5", "", CVAR_ARCHIVE },
-	{ &ui_server6, "server6", "", CVAR_ARCHIVE },
-	{ &ui_server7, "server7", "", CVAR_ARCHIVE },
-	{ &ui_server8, "server8", "", CVAR_ARCHIVE },
-	{ &ui_server9, "server9", "", CVAR_ARCHIVE },
-	{ &ui_server10, "server10", "", CVAR_ARCHIVE },
-	{ &ui_server11, "server11", "", CVAR_ARCHIVE },
-	{ &ui_server12, "server12", "", CVAR_ARCHIVE },
-	{ &ui_server13, "server13", "", CVAR_ARCHIVE },
-	{ &ui_server14, "server14", "", CVAR_ARCHIVE },
-	{ &ui_server15, "server15", "", CVAR_ARCHIVE },
-	{ &ui_server16, "server16", "", CVAR_ARCHIVE },
-	{ &ui_cdkeychecked, "ui_cdkeychecked", "0", CVAR_ROM },
 	{ &ui_new, "ui_new", "0", CVAR_TEMP },
 	{ &ui_debug, "ui_debug", "0", CVAR_TEMP },
 	{ &ui_initialized, "ui_initialized", "0", CVAR_TEMP },
@@ -5866,8 +5660,10 @@
 	{ &ui_hudFiles, "cg_hudFiles", "ui/hud.txt", CVAR_ARCHIVE},
 	{ &ui_recordSPDemo, "ui_recordSPDemo", "0", CVAR_ARCHIVE},
 	{ &ui_teamArenaFirstRun, "ui_teamArenaFirstRun", "0", CVAR_ARCHIVE},
-	{ &ui_realWarmUp, "g_warmup", "20", CVAR_ARCHIVE},
-	{ &ui_realCaptureLimit, "capturelimit", "8", CVAR_SERVERINFO | CVAR_ARCHIVE | CVAR_NORESTART},
+	{ NULL, "g_warmup", "20", CVAR_ARCHIVE},
+	{ NULL, "timelimit", "0", CVAR_SERVERINFO | CVAR_ARCHIVE | CVAR_NORESTART},
+	{ NULL, "fraglimit", "20", CVAR_SERVERINFO | CVAR_ARCHIVE | CVAR_NORESTART},
+	{ NULL, "capturelimit", "8", CVAR_SERVERINFO | CVAR_ARCHIVE | CVAR_NORESTART},
 	{ &ui_serverStatusTimeOut, "ui_serverStatusTimeOut", "7000", CVAR_ARCHIVE},
 
 	{ NULL, "ui_videomode", "", CVAR_ROM },
@@ -5938,23 +5734,6 @@
 
 /*
 =================
-ArenaServers_MaxPing
-=================
-*/
-#ifndef MISSIONPACK
-static int ArenaServers_MaxPing( void ) {
-	int		maxPing;
-
-	maxPing = (int)trap_Cvar_VariableValue( "cl_maxPing" );
-	if( maxPing < 100 ) {
-		maxPing = 100;
-	}
-	return maxPing;
-}
-#endif
-
-/*
-=================
 UI_DoServerRefresh
 =================
 */
Index: code/ui/ui_players.c
===================================================================
--- code/ui/ui_players.c	(revision 3378)
+++ code/ui/ui_players.c	(working copy)
@@ -25,9 +25,7 @@
 #include "ui_local.h"
 
 
-#define UI_TIMER_GESTURE		2300
 #define UI_TIMER_JUMP			1000
-#define UI_TIMER_LAND			130
 #define UI_TIMER_WEAPON_SWITCH	300
 #define UI_TIMER_ATTACK			500
 #define	UI_TIMER_MUZZLE_FLASH	20
@@ -88,11 +86,9 @@
 		goto tryagain;
 	}
 
-	if ( weaponNum == WP_MACHINEGUN || weaponNum == WP_GAUNTLET || weaponNum == WP_BFG ) {
-		COM_StripExtension( item->world_model[0], path, sizeof(path) );
-		Q_strcat( path, sizeof(path), "_barrel.md3" );
-		pi->barrelModel = trap_R_RegisterModel( path );
-	}
+	COM_StripExtension( item->world_model[0], path, sizeof(path) );
+	Q_strcat( path, sizeof(path), "_barrel.md3" );
+	pi->barrelModel = trap_R_RegisterModel( path );
 
 	COM_StripExtension( item->world_model[0], path, sizeof(path) );
 	Q_strcat( path, sizeof(path), "_flash.md3" );
@@ -139,6 +135,20 @@
 		MAKERGB( pi->flashDlightColor, 0.6f, 0.6f, 1 );
 		break;
 
+#ifdef MISSIONPACK
+	case WP_NAILGUN:
+		MAKERGB( pi->flashDlightColor, 1, 0.75f, 0 );
+		break;
+
+	case WP_PROX_LAUNCHER:
+		MAKERGB( pi->flashDlightColor, 1, 0.70f, 0 );
+		break;
+
+	case WP_CHAINGUN:
+		MAKERGB( pi->flashDlightColor, 1, 1, 0 );
+		break;
+#endif
+
 	default:
 		MAKERGB( pi->flashDlightColor, 1, 1, 1 );
 		break;
@@ -183,7 +193,7 @@
 	pi->torsoAnim = ( ( pi->torsoAnim & ANIM_TOGGLEBIT ) ^ ANIM_TOGGLEBIT ) | anim;
 
 	if ( anim == TORSO_GESTURE ) {
-		pi->torsoAnimationTimer = UI_TIMER_GESTURE;
+		pi->torsoAnimationTimer = TIMER_GESTURE;
 	}
 
 	if ( anim == TORSO_ATTACK || anim == TORSO_ATTACK2 ) {
@@ -271,7 +281,7 @@
 
 	if ( currentAnim == LEGS_JUMP ) {
 		UI_ForceLegsAnim( pi, LEGS_LAND );
-		pi->legsAnimationTimer = UI_TIMER_LAND;
+		pi->legsAnimationTimer = TIMER_LAND;
 		jumpHeight = 0;
 		return;
 	}
@@ -661,7 +671,7 @@
 
 	memset( &ent, 0, sizeof( ent ) );
 	VectorCopy( origin, ent.origin );
-	ent.origin[2] += 48;
+	ent.origin[2] += 42;
 	ent.reType = RT_SPRITE;
 	ent.customShader = shader;
 	ent.radius = 10;
@@ -858,7 +868,7 @@
 	//
 	// add the spinning barrel
 	//
-	if ( pi->realWeapon == WP_MACHINEGUN || pi->realWeapon == WP_GAUNTLET || pi->realWeapon == WP_BFG ) {
+	if ( pi->barrelModel ) {
 		vec3_t	angles;
 
 		memset( &barrel, 0, sizeof(barrel) );
Index: code/ui/ui_public.h
===================================================================
--- code/ui/ui_public.h	(revision 3378)
+++ code/ui/ui_public.h	(working copy)
@@ -23,7 +23,7 @@
 #ifndef __UI_PUBLIC_H__
 #define __UI_PUBLIC_H__
 
-#define UI_API_VERSION	6
+#define UI_API_VERSION 7
 
 typedef struct {
 	connstate_t		connState;
@@ -90,8 +90,6 @@
 	UI_CVAR_REGISTER,
 	UI_CVAR_UPDATE,
 	UI_MEMORY_REMAINING,
-	UI_GET_CDKEY,
-	UI_SET_CDKEY,
 	UI_R_REGISTERFONT,
 	UI_R_MODELBOUNDS,
 	UI_PC_ADD_GLOBAL_DEFINE,
@@ -119,7 +117,6 @@
 	UI_CIN_SETEXTENTS,
 	UI_R_REMAP_SHADER,
 	UI_R_SETCLIPREGION,
-	UI_VERIFY_CDKEY,
 	UI_LAN_SERVERSTATUS,
 	UI_LAN_GETSERVERPING,
 	UI_LAN_SERVERISVISIBLE,
@@ -126,7 +123,6 @@
 	UI_LAN_COMPARESERVERS,
 	// 1.32
 	UI_FS_SEEK,
-	UI_SET_PBCLSTATUS,
 
 	UI_MEMSET = 100,
 	UI_MEMCPY,
@@ -143,8 +139,6 @@
 	UIMENU_NONE,
 	UIMENU_MAIN,
 	UIMENU_INGAME,
-	UIMENU_NEED_CD,
-	UIMENU_BAD_CD_KEY,
 	UIMENU_TEAM,
 	UIMENU_POSTGAME
 } uiMenuCommand_t;
@@ -154,7 +148,6 @@
 #define SORT_CLIENTS		2
 #define SORT_GAME			3
 #define SORT_PING			4
-#define SORT_PUNKBUSTER		5
 
 typedef enum {
 	UI_GETAPIVERSION = 0,	// system reserved
@@ -185,7 +178,6 @@
 
 	UI_DRAW_CONNECT_SCREEN,
 //	void	UI_DrawConnectScreen( qboolean overlay );
-	UI_HASUNIQUECDKEY
 // if !overlay, the background will be drawn, otherwise it will be
 // overlayed over whatever the cgame has drawn.
 // a GetClientState syscall will be made to get the current strings
Index: code/ui/ui_shared.c
===================================================================
--- code/ui/ui_shared.c	(revision 3378)
+++ code/ui/ui_shared.c	(working copy)
@@ -1776,6 +1776,7 @@
 				}
 				else {
 					listPtr->startPos++;
+					// ZTM: FIXME: should this be >= max like all the other startPos checks?
 					if (listPtr->startPos >= count)
 						listPtr->startPos = count-1;
 				}
@@ -3286,21 +3287,6 @@
 
 static const int g_bindCount = ARRAY_LEN(g_bindings);
 
-#ifndef MISSIONPACK
-static configcvar_t g_configcvars[] =
-{
-	{"cl_run",			0,					0},
-	{"m_pitch",			0,					0},
-	{"cg_autoswitch",	0,					0},
-	{"sensitivity",		0,					0},
-	{"in_joystick",		0,					0},
-	{"joy_threshold",	0,					0},
-	{"m_filter",		0,					0},
-	{"cl_freelook",		0,					0},
-	{NULL,				0,					0}
-};
-#endif
-
 /*
 =================
 Controls_GetKeyAssignment
@@ -3352,13 +3338,13 @@
 	}
 
 	//s_controls.invertmouse.curvalue  = DC->getCVarValue( "m_pitch" ) < 0;
-	//s_controls.smoothmouse.curvalue  = UI_ClampCvar( 0, 1, Controls_GetCvarValue( "m_filter" ) );
-	//s_controls.alwaysrun.curvalue    = UI_ClampCvar( 0, 1, Controls_GetCvarValue( "cl_run" ) );
-	//s_controls.autoswitch.curvalue   = UI_ClampCvar( 0, 1, Controls_GetCvarValue( "cg_autoswitch" ) );
-	//s_controls.sensitivity.curvalue  = UI_ClampCvar( 2, 30, Controls_GetCvarValue( "sensitivity" ) );
-	//s_controls.joyenable.curvalue    = UI_ClampCvar( 0, 1, Controls_GetCvarValue( "in_joystick" ) );
-	//s_controls.joythreshold.curvalue = UI_ClampCvar( 0.05, 0.75, Controls_GetCvarValue( "joy_threshold" ) );
-	//s_controls.freelook.curvalue     = UI_ClampCvar( 0, 1, Controls_GetCvarValue( "cl_freelook" ) );
+	//s_controls.smoothmouse.curvalue  = Com_Clamp( 0, 1, Controls_GetCvarValue( "m_filter" ) );
+	//s_controls.alwaysrun.curvalue    = Com_Clamp( 0, 1, Controls_GetCvarValue( "cl_run" ) );
+	//s_controls.autoswitch.curvalue   = Com_Clamp( 0, 1, Controls_GetCvarValue( "cg_autoswitch" ) );
+	//s_controls.sensitivity.curvalue  = Com_Clamp( 2, 30, Controls_GetCvarValue( "sensitivity" ) );
+	//s_controls.joyenable.curvalue    = Com_Clamp( 0, 1, Controls_GetCvarValue( "in_joystick" ) );
+	//s_controls.joythreshold.curvalue = Com_Clamp( 0.05, 0.75, Controls_GetCvarValue( "joy_threshold" ) );
+	//s_controls.freelook.curvalue     = Com_Clamp( 0, 1, Controls_GetCvarValue( "cl_freelook" ) );
 }
 
 /*
@@ -5476,7 +5462,6 @@
 			listPtr->cursorPos = 0;
 			listPtr->startPos = 0;
 			listPtr->endPos = 0;
-			listPtr->cursorPos = 0;
 		}
 	}
 }
@@ -5920,11 +5905,6 @@
 	return DC;
 }
  
-#ifndef MISSIONPACK
-static float captureX;
-static float captureY;
-#endif
-
 void *Display_CaptureItem(int x, int y) {
 	int i;
 
Index: code/ui/ui_syscalls.asm
===================================================================
--- code/ui/ui_syscalls.asm	(revision 3378)
+++ code/ui/ui_syscalls.asm	(working copy)
@@ -55,42 +55,38 @@
 equ	trap_Cvar_Register						-53
 equ trap_Cvar_Update						-54
 equ trap_MemoryRemaining					-55
-equ	trap_GetCDKey							-56
-equ	trap_SetCDKey							-57
-equ trap_R_RegisterFont						-58
-equ trap_R_ModelBounds						-59
-equ trap_PC_AddGlobalDefine					-60
-equ	trap_PC_LoadSource						-61
-equ trap_PC_FreeSource						-62
-equ trap_PC_ReadToken						-63
-equ trap_PC_SourceFileAndLine				-64
-equ trap_S_StopBackgroundTrack				-65
-equ trap_S_StartBackgroundTrack				-66
-equ trap_RealTime							-67
-equ trap_LAN_GetServerCount					-68
-equ trap_LAN_GetServerAddressString			-69
-equ trap_LAN_GetServerInfo					-70
-equ trap_LAN_MarkServerVisible 				-71
-equ trap_LAN_UpdateVisiblePings				-72
-equ trap_LAN_ResetPings						-73
-equ trap_LAN_LoadCachedServers				-74
-equ trap_LAN_SaveCachedServers				-75
-equ trap_LAN_AddServer						-76
-equ trap_LAN_RemoveServer	 				-77
-equ trap_CIN_PlayCinematic					-78
-equ trap_CIN_StopCinematic					-79
-equ trap_CIN_RunCinematic 					-80
-equ trap_CIN_DrawCinematic					-81
-equ trap_CIN_SetExtents						-82
-equ trap_R_RemapShader						-83
-equ trap_R_SetClipRegion					-84
-equ trap_VerifyCDKey						-85
-equ trap_LAN_ServerStatus					-86
-equ trap_LAN_GetServerPing					-87
-equ trap_LAN_ServerIsVisible				-88
-equ trap_LAN_CompareServers					-89
-equ trap_FS_Seek		-90
-equ trap_SetPbClStatus -91
+equ trap_R_RegisterFont						-56
+equ trap_R_ModelBounds						-57
+equ trap_PC_AddGlobalDefine					-58
+equ	trap_PC_LoadSource						-59
+equ trap_PC_FreeSource						-60
+equ trap_PC_ReadToken						-61
+equ trap_PC_SourceFileAndLine				-62
+equ trap_S_StopBackgroundTrack				-63
+equ trap_S_StartBackgroundTrack				-64
+equ trap_RealTime							-65
+equ trap_LAN_GetServerCount					-66
+equ trap_LAN_GetServerAddressString			-67
+equ trap_LAN_GetServerInfo					-68
+equ trap_LAN_MarkServerVisible 				-69
+equ trap_LAN_UpdateVisiblePings				-70
+equ trap_LAN_ResetPings						-71
+equ trap_LAN_LoadCachedServers				-72
+equ trap_LAN_SaveCachedServers				-73
+equ trap_LAN_AddServer						-74
+equ trap_LAN_RemoveServer	 				-75
+equ trap_CIN_PlayCinematic					-76
+equ trap_CIN_StopCinematic					-77
+equ trap_CIN_RunCinematic 					-78
+equ trap_CIN_DrawCinematic					-79
+equ trap_CIN_SetExtents						-80
+equ trap_R_RemapShader						-81
+equ trap_R_SetClipRegion					-82
+equ trap_LAN_ServerStatus					-83
+equ trap_LAN_GetServerPing					-84
+equ trap_LAN_ServerIsVisible				-85
+equ trap_LAN_CompareServers					-86
+equ trap_FS_Seek		-87
 
 equ	memset						-101
 equ	memcpy						-102
Index: code/ui/ui_syscalls.c
===================================================================
--- code/ui/ui_syscalls.c	(revision 3378)
+++ code/ui/ui_syscalls.c	(working copy)
@@ -329,14 +329,6 @@
 	return syscall( UI_MEMORY_REMAINING );
 }
 
-void trap_GetCDKey( char *buf, int buflen ) {
-	syscall( UI_GET_CDKEY, buf, buflen );
-}
-
-void trap_SetCDKey( char *buf ) {
-	syscall( UI_SET_CDKEY, buf );
-}
-
 int trap_PC_AddGlobalDefine( char *define ) {
 	return syscall( UI_PC_ADD_GLOBAL_DEFINE, define );
 }
@@ -406,10 +398,3 @@
 void trap_R_SetClipRegion( const float *region ) {
 	syscall( UI_R_SETCLIPREGION, region );
 }
-qboolean trap_VerifyCDKey( const char *key, const char *chksum) {
-	return syscall( UI_VERIFY_CDKEY, key, chksum);
-}
-
-void trap_SetPbClStatus( int status ) {
-	syscall( UI_SET_PBCLSTATUS, status );
-}
Index: Makefile
===================================================================
--- Makefile	(revision 3378)
+++ Makefile	(working copy)
@@ -2563,7 +2563,6 @@
   $(B)/$(BASEGAME)/ui/bg_lib.o \
   $(B)/$(BASEGAME)/ui/ui_addbots.o \
   $(B)/$(BASEGAME)/ui/ui_atoms.o \
-  $(B)/$(BASEGAME)/ui/ui_cdkey.o \
   $(B)/$(BASEGAME)/ui/ui_cinematics.o \
   $(B)/$(BASEGAME)/ui/ui_confirm.o \
   $(B)/$(BASEGAME)/ui/ui_connect.o \
Index: misc/msvc10/q3_ui.vcxproj
===================================================================
--- misc/msvc10/q3_ui.vcxproj	(revision 3378)
+++ misc/msvc10/q3_ui.vcxproj	(working copy)
@@ -621,36 +621,6 @@
       <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
     </ClCompile>
-    <ClCompile Include="..\..\code\q3_ui\ui_cdkey.c">
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">Disabled</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</BrowseInformation>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</BrowseInformation>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">Disabled</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">true</BrowseInformation>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">true</BrowseInformation>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">true</ExcludedFromBuild>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">MaxSpeed</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">MaxSpeed</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|x64'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-    </ClCompile>
     <ClCompile Include="..\..\code\q3_ui\ui_cinematics.c">
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</ExcludedFromBuild>
Index: misc/msvc10/q3_ui.vcxproj.filters
===================================================================
--- misc/msvc10/q3_ui.vcxproj.filters	(revision 3378)
+++ misc/msvc10/q3_ui.vcxproj.filters	(working copy)
@@ -29,9 +29,6 @@
     <ClCompile Include="..\..\code\q3_ui\ui_atoms.c">
       <Filter>Source Files</Filter>
     </ClCompile>
-    <ClCompile Include="..\..\code\q3_ui\ui_cdkey.c">
-      <Filter>Source Files</Filter>
-    </ClCompile>
     <ClCompile Include="..\..\code\q3_ui\ui_cinematics.c">
       <Filter>Source Files</Filter>
     </ClCompile>
Index: misc/msvc11/q3_ui.vcxproj
===================================================================
--- misc/msvc11/q3_ui.vcxproj	(revision 3378)
+++ misc/msvc11/q3_ui.vcxproj	(working copy)
@@ -629,36 +629,6 @@
       <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
       <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
     </ClCompile>
-    <ClCompile Include="..\..\code\q3_ui\ui_cdkey.c">
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">Disabled</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</BrowseInformation>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</BrowseInformation>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">Disabled</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">true</BrowseInformation>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">true</BrowseInformation>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">true</ExcludedFromBuild>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">MaxSpeed</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release TA|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">MaxSpeed</Optimization>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|x64'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|x64'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-    </ClCompile>
     <ClCompile Include="..\..\code\q3_ui\ui_cinematics.c">
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|x64'">true</ExcludedFromBuild>
Index: misc/msvc11/q3_ui.vcxproj.filters
===================================================================
--- misc/msvc11/q3_ui.vcxproj.filters	(revision 3378)
+++ misc/msvc11/q3_ui.vcxproj.filters	(working copy)
@@ -29,9 +29,6 @@
     <ClCompile Include="..\..\code\q3_ui\ui_atoms.c">
       <Filter>Source Files</Filter>
     </ClCompile>
-    <ClCompile Include="..\..\code\q3_ui\ui_cdkey.c">
-      <Filter>Source Files</Filter>
-    </ClCompile>
     <ClCompile Include="..\..\code\q3_ui\ui_cinematics.c">
       <Filter>Source Files</Filter>
     </ClCompile>
Index: misc/msvc12/q3_ui.vcxproj
===================================================================
--- misc/msvc12/q3_ui.vcxproj	(revision 3378)
+++ misc/msvc12/q3_ui.vcxproj	(working copy)
@@ -310,22 +310,6 @@
       <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">MaxSpeed</Optimization>
       <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
     </ClCompile>
-    <ClCompile Include="..\..\code\q3_ui\ui_cdkey.c">
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</BrowseInformation>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">Disabled</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <BasicRuntimeChecks Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">EnableFastChecks</BasicRuntimeChecks>
-      <BrowseInformation Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">true</BrowseInformation>
-      <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">true</ExcludedFromBuild>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release TA|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-      <Optimization Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">MaxSpeed</Optimization>
-      <PreprocessorDefinitions Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
-    </ClCompile>
     <ClCompile Include="..\..\code\q3_ui\ui_cinematics.c">
       <ExcludedFromBuild Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">true</ExcludedFromBuild>
       <Optimization Condition="'$(Configuration)|$(Platform)'=='Debug TA|Win32'">Disabled</Optimization>
Index: misc/msvc/q3_ui.vcproj
===================================================================
--- misc/msvc/q3_ui.vcproj	(revision 3378)
+++ misc/msvc/q3_ui.vcproj	(working copy)
@@ -581,52 +581,6 @@
 				</FileConfiguration>
 			</File>
 			<File
-				RelativePath="..\..\code\q3_ui\ui_cdkey.c"
-				>
-				<FileConfiguration
-					Name="Debug TA|Win32"
-					ExcludedFromBuild="true"
-					>
-					<Tool
-						Name="VCCLCompilerTool"
-						Optimization="0"
-						PreprocessorDefinitions="WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;"
-						BasicRuntimeChecks="3"
-						BrowseInformation="1"
-					/>
-				</FileConfiguration>
-				<FileConfiguration
-					Name="Release TA|Win32"
-					ExcludedFromBuild="true"
-					>
-					<Tool
-						Name="VCCLCompilerTool"
-						Optimization="2"
-						PreprocessorDefinitions="WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;"
-					/>
-				</FileConfiguration>
-				<FileConfiguration
-					Name="Release|Win32"
-					>
-					<Tool
-						Name="VCCLCompilerTool"
-						Optimization="2"
-						PreprocessorDefinitions="WIN32;NDEBUG;_WINDOWS;_MBCS;_USRDLL;Q3_UI_EXPORTS;"
-					/>
-				</FileConfiguration>
-				<FileConfiguration
-					Name="Debug|Win32"
-					>
-					<Tool
-						Name="VCCLCompilerTool"
-						Optimization="0"
-						PreprocessorDefinitions="WIN32;_DEBUG;_WINDOWS;_MBCS;_USRDLL;UI_EXPORTS;"
-						BasicRuntimeChecks="3"
-						BrowseInformation="1"
-					/>
-				</FileConfiguration>
-			</File>
-			<File
 				RelativePath="..\..\code\q3_ui\ui_cinematics.c"
 				>
 				<FileConfiguration
Index: misc/xcode/q3_ui.xcodeproj/project.pbxproj
===================================================================
--- misc/xcode/q3_ui.xcodeproj/project.pbxproj	(revision 3378)
+++ misc/xcode/q3_ui.xcodeproj/project.pbxproj	(working copy)
@@ -10,7 +10,7 @@
 		2711BDBC14D13007005EB142 /* ui_syscalls.c in Sources */ = {isa = PBXBuildFile; fileRef = 2711BDBB14D13007005EB142 /* ui_syscalls.c */; };
 		2772B7BB1790E7C6004CCF57 /* ui_addbots.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B78D1790E7C6004CCF57 /* ui_addbots.c */; };
 		2772B7BC1790E7C6004CCF57 /* ui_atoms.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B78E1790E7C6004CCF57 /* ui_atoms.c */; };
-		2772B7BD1790E7C6004CCF57 /* ui_cdkey.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B78F1790E7C6004CCF57 /* ui_cdkey.c */; };
+//		2772B7BD1790E7C6004CCF57 /* ui_cdkey.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B78F1790E7C6004CCF57 /* ui_cdkey.c */; };
 		2772B7BE1790E7C6004CCF57 /* ui_cinematics.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B7901790E7C6004CCF57 /* ui_cinematics.c */; };
 		2772B7BF1790E7C6004CCF57 /* ui_confirm.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B7911790E7C6004CCF57 /* ui_confirm.c */; };
 		2772B7C01790E7C6004CCF57 /* ui_connect.c in Sources */ = {isa = PBXBuildFile; fileRef = 2772B7921790E7C6004CCF57 /* ui_connect.c */; };
@@ -59,7 +59,7 @@
 		273531C714D1270700EB7BD6 /* q3_ui.dylib */ = {isa = PBXFileReference; explicitFileType = "compiled.mach-o.dylib"; includeInIndex = 0; path = q3_ui.dylib; sourceTree = BUILT_PRODUCTS_DIR; };
 		2772B78D1790E7C6004CCF57 /* ui_addbots.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_addbots.c; sourceTree = "<group>"; };
 		2772B78E1790E7C6004CCF57 /* ui_atoms.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_atoms.c; sourceTree = "<group>"; };
-		2772B78F1790E7C6004CCF57 /* ui_cdkey.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_cdkey.c; sourceTree = "<group>"; };
+//		2772B78F1790E7C6004CCF57 /* ui_cdkey.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_cdkey.c; sourceTree = "<group>"; };
 		2772B7901790E7C6004CCF57 /* ui_cinematics.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_cinematics.c; sourceTree = "<group>"; };
 		2772B7911790E7C6004CCF57 /* ui_confirm.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_confirm.c; sourceTree = "<group>"; };
 		2772B7921790E7C6004CCF57 /* ui_connect.c */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.c; path = ui_connect.c; sourceTree = "<group>"; };
@@ -154,7 +154,7 @@
 			children = (
 				2772B78D1790E7C6004CCF57 /* ui_addbots.c */,
 				2772B78E1790E7C6004CCF57 /* ui_atoms.c */,
-				2772B78F1790E7C6004CCF57 /* ui_cdkey.c */,
+//				2772B78F1790E7C6004CCF57 /* ui_cdkey.c */,
 				2772B7901790E7C6004CCF57 /* ui_cinematics.c */,
 				2772B7911790E7C6004CCF57 /* ui_confirm.c */,
 				2772B7921790E7C6004CCF57 /* ui_connect.c */,
@@ -308,7 +308,7 @@
 				2711BDBC14D13007005EB142 /* ui_syscalls.c in Sources */,
 				2772B7BB1790E7C6004CCF57 /* ui_addbots.c in Sources */,
 				2772B7BC1790E7C6004CCF57 /* ui_atoms.c in Sources */,
-				2772B7BD1790E7C6004CCF57 /* ui_cdkey.c in Sources */,
+//				2772B7BD1790E7C6004CCF57 /* ui_cdkey.c in Sources */,
 				2772B7BE1790E7C6004CCF57 /* ui_cinematics.c in Sources */,
 				2772B7BF1790E7C6004CCF57 /* ui_confirm.c in Sources */,
 				2772B7C01790E7C6004CCF57 /* ui_connect.c in Sources */,
Index: ui/menus.txt
===================================================================
--- ui/menus.txt	(revision 3378)
+++ ui/menus.txt	(working copy)
@@ -4,7 +4,6 @@
 	loadMenu { "ui/main.menu" }
  	loadMenu { "ui/joinserver.menu" }
  	loadMenu { "ui/filter.menu" }
-	loadMenu { "ui/punkbuster.menu" }
  	loadMenu { "ui/player.menu" }
  	loadMenu { "ui/setup.menu" }
  	loadMenu { "ui/fight.menu" }
@@ -11,7 +10,6 @@
  	loadMenu { "ui/skirmish.menu" }
  	loadMenu { "ui/createserver.menu" }
 	loadMenu { "ui/controls.menu" }
-	loadMenu { "ui/cdkey.menu" }
 	loadMenu { "ui/system.menu" }
 	loadMenu { "ui/options.menu" }
 	loadMenu { "ui/help.menu" }
